// # Recline Backbone Models
this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.FilteredDataset=this.recline.Model.FilteredDataset||{},function(a,b){b.FilteredDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var a=this;this.records=new b.RecordList,this.fields=this.attributes.dataset.fields,this.attributes.deriver=this.attributes.dataset.deriver,this.recordCount=null,this.queryState=new b.Query,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.dataset.fields.bind("reset",function(){a.fieldsReset()}),this.attributes.dataset.bind("query:done",function(){a.query()}),this.queryState.bind("change",function(){a.query()})},fieldsReset:function(){this.fields=this.attributes.dataset.fields},query:function(a){var c=this;this.trigger("query:start"),a&&this.queryState.set(a,{silent:!0});var a=this.queryState.toJSON();_.each(c.attributes.customFilterLogic,function(b){b(a)});var d=c.attributes.dataset,e=a.size||d.recordCount,f=a.from||0,g=recline.Data.Filters.applyFiltersOnData(a.filters,d.toFullJSON(),d.fields.toJSON());_.each(a.sort,function(a){var b=a.field;g=_.sortBy(g,function(a){var c=a[b];return c}),a.order=="desc"&&g.reverse()}),g=g.slice(f,f+e),c.recordCount=g.length;var h=_.map(g,function(a){var e=new b.Record(a);return e.fields=d.fields,e.bind("change",function(a){c._changes.updates.push(a.toJSON())}),e.bind("destroy",function(a){c._changes.deletes.push(a.toJSON())}),e});c.records.reset(h),c.trigger("query:done")},getRecords:function(){return this.records.models},getFields:function(a){return this.attributes.dataset.fields},toTemplateJSON:function(){var a=this.records.toJSON();return a.recordCount=this.recordCount,a.fields=this.fields.toJSON(),a},getFieldsSummary:function(){return this.attributes.dataset.getFieldsSummary()},addCustomFilterLogic:function(a){this.attributes.customFilterLogic?this.attributes.customFilterLogic.push(a):this.attributes.customFilterLogic=[a]},setColorSchema:function(){var a=this;_.each(a.attributes.colorSchema,function(b){var c=_.find(a.fields.models,function(a){return b.field===a.id});c!=null&&(c.attributes.colorSchema=b.schema)})},toFullJSON:function(a){var b=this;return _.map(b.records.models,function(a){var c={};return _.each(b.fields.models,function(b){c[b.id]=a.getFieldValueUnrendered(b)}),c})}})}(jQuery,this.recline.Model),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.JoinedDataset=this.recline.Model.JoinedDataset||{},function(a,b){b.JoinedDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var a=this;_.bindAll(this,"generatefields"),a.ds_fetched=[],a.field_fetched=[],a.joinedModel=new b.Dataset({backend:"Memory",records:[],fields:[],renderer:a.attributes.renderer}),a.fields=a.joinedModel.fields,a.records=a.joinedModel.records,a.facets=a.joinedModel.facets,a.recordCount=a.joinedModel.recordCount,a.queryState=a.joinedModel.queryState,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.model.fields.bind("reset",function(){a.field_fetched.push("model"),a.allDsFetched(a.field_fetched)&&a.generatefields()}),_.each(this.attributes.join,function(b){b.model.fields.bind("reset",function(){if(!b.id)throw"joinedmodel: a model without id has been used in join. Unable to apply joined model";a.field_fetched.push(b.model.id),a.allDsFetched(a.field_fetched)&&a.generatefields()})}),this.attributes.model.bind("query:done",function(){a.ds_fetched.push("model"),a.allDsFetched(a.ds_fetched)&&a.query()}),_.each(this.attributes.join,function(b){b.model.bind("query:done",function(){if(!b.id)throw"joinedmodel: a model without id has been used in join. Unable to apply joined model";a.ds_fetched.push(b.id),a.allDsFetched(a.ds_fetched)&&a.query()}),b.model.queryState.bind("change",function(){a.allDsFetched(a.ds_fetched)&&a.query()})})},allDsFetched:function(a){var b=this,c=!0;return _.contains(a,"model")?(_.each(b.attributes.join,function(b){_.contains(a,b.id)||(c=!1)}),c):!1},generatefields:function(){var a=this,b=[];_.each(this.attributes.model.fields.models,function(a){var c=a.toJSON();c.id=c.id,b.push(c)}),_.each(this.attributes.join,function(a){_.each(a.model.fields.models,function(c){var d=c.toJSON();d.id=a.id+"_"+d.id,b.push(d)})}),this.joinedModel.resetFields(b)},query:function(a){var b=this;b.trigger("query:start"),a&&this.queryState.set(a,{silent:!0});var c=b.join();b.joinedModel.resetRecords(c),b.fields.models.length==0&&b.generatefields(),b.joinedModel.fetch(),b.recordCount=b.joinedModel.recordCount,b.trigger("query:done")},join:function(){var a=this.attributes.joinType,b=this.attributes.model,c=this.attributes.join,d=[];return _.each(b.getRecords(),function(b){var e=[],f=!0,g={};_.each(b.fields.models,function(a){g[a.id]=b.getFieldValueUnrendered(a)}),_.each(c,function(a){_.each(a.joinon,function(c){var d=a.model.fields.get(c);if(!d)throw"joinedmodel.js: unable to find field ["+c+"] on secondary model";e.push({field:d.id,type:"term",term:b.getFieldValueUnrendered(d),fieldType:d.attributes.type})});var c=recline.Data.Filters.applyFiltersOnData(e,a.model.toFullJSON(),a.model.fields.toJSON());c.length==0&&(f=!1),_.each(c,function(b){_.each(b,function(b,c){g[a.id+"_"+c]=b})})}),(a=="left"||f)&&d.push(g)}),d},addCustomFilterLogic:function(a){return this.joinedModel.addCustomFilterLogic(a)},getRecords:function(a){return this.joinedModel.getRecords(a)},getFields:function(a){return this.joinedModel.getFields(a)},toTemplateJSON:function(){return this.joinedModel.toTemplateJSON()},getFacetByFieldId:function(a){return this.joinedModel.getFacetByFieldId(a)},isFieldPartitioned:function(a){return!1},toFullJSON:function(a){return this.joinedModel.toFullJSON(a)},setColorSchema:function(){return this.attributes.colorSchema&&(this.joinedModel.attributes.colorSchema=this.attributes.colorSchema),this.joinedModel.setColorSchema()},addStaticColorSchema:function(a,b){var c=this;c.attributes.colorSchema||(c.attributes.colorSchema=[]),c.attributes.colorSchema.push({schema:a,field:b}),this.joinedModel.attributes.colorSchema=this.attributes.colorSchema,c.setColorSchema(),c.fields.bind("reset",function(){c.setColorSchema()}),c.fields.bind("add",function(){c.setColorSchema()})}})}(jQuery,this.recline.Model),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{defaults:function(){return{size:5e5,from:0,q:"",facets:{},filters:[]}}}),function(a){recline.Model.Dataset.prototype=a.extend(recline.Model.Dataset.prototype,{setColorSchema:function(){var a=this;_.each(a.attributes.colorSchema,function(b){var c=_.find(a.fields.models,function(a){return b.field===a.id});c!=null&&(c.attributes.colorSchema=b.schema)})},addStaticColorSchema:function(a,b){var c=this;c.attributes.colorSchema||(c.attributes.colorSchema=[]),c.attributes.colorSchema.push({schema:a,field:b}),c.fields.length>0&&c.setColorSchema(),c.fields.bind("reset",function(){c.setColorSchema()}),c.fields.bind("add",function(){c.setColorSchema()}),c.fields.bind("change",function(){c.setColorSchema()})},_handleQueryResult:function(){var a=recline.Model.Dataset.prototype._handleQueryResult;return function(b){var c=this;a.call(this,b),b.facets&&_.each(b.facets,function(a,b){recline.Data.ColorSchema.addColorsToTerms(a.id,a.terms,c.attributes.colorSchema)})}}()}),recline.Model.Record.prototype=a.extend(recline.Model.Record.prototype,{getFieldColor:function(a){return a.attributes.colorSchema?a.attributes.is_partitioned?a.attributes.colorSchema.getTwoDimensionalColor(a.attributes.partitionValue,this.getFieldValueUnrendered(a)):a.attributes.colorSchema.getColorFor(this.getFieldValueUnrendered(a)):null}}),recline.Model.Field.prototype=a.extend(recline.Model.Field.prototype,{getColorForPartition:function(){return this.attributes.colorSchema?this.attributes.is_partitioned?this.attributes.colorSchema.getColorFor(this.attributes.partitionValue):this.attributes.colorSchema.getColorFor(this.attributes.id):null}})}(jQuery),function(a){recline.Model.Dataset.prototype=a.extend(recline.Model.Dataset.prototype,{addCustomFilterLogic:function(a){this.attributes.customFilterLogic?this.attributes.customFilterLogic.push(a):this.attributes.customFilterLogic=[a]}})}(jQuery),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{initialize:function(){var a=recline.Model.Dataset.prototype.initialize;return function(){a.call(this),_.bindAll(this,"applyRendererToFields"),this.fields.bind("reset",this.applyRendererToFields)}}(),applyRendererToFields:function(){var a=this;a.attributes.renderer&&_.each(a.fields.models,function(b){b.renderer=a.attributes.renderer})}}),function(a){recline.Model.Dataset.prototype=a.extend(recline.Model.Dataset.prototype,{getFacetByFieldId:function(a){return _.find(this.facets.models,function(b){return b.id==a})}})}(jQuery),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{addFacetNoEvent:function(a){var b=this.get("facets");if(_.contains(_.keys(b),a))return;b[a]={terms:{field:a}},this.set({facets:b},{silent:!0})}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{toFullJSON:function(a){var b=this;return _.map(b.getRecords(a),function(c){var d={};return _.each(b.getFields(a).models,function(a){d[a.id]=c.getFieldValueUnrendered(a)}),d})},resetRecords:function(a){this.set({records:a},{silent:!0})},resetFields:function(a){this.set({fields:a},{silent:!0})},getRecords:function(a){var b=this;if(a==="filtered"||a==null)return b.records.models;if(b._store.data==null)throw"Model: unable to retrieve not filtered data, store can't provide data. Use a backend that use a memory store";b.queryState.get("sort")&&b.queryState.get("sort").length>0&&_.each(b.queryState.get("sort"),function(a){var c=a.field;b._store.data=_.sortBy(b._store.data,function(a){var b=a[c];return b}),a.order=="desc"&&typeof a.alreadySorted=="undefined"&&(b._store.data.reverse(),a.alreadySorted=!0)});var c=_.map(b._store.data,function(a){var c=new recline.Model.Record(a);return c.fields=b.fields,c});return b.queryState.getSelections().length>0&&recline.Data.Filters.applySelectionsOnRecord(b.queryState.get("selections"),c,b.fields),c},getFields:function(a){var b=this;return b.fields},_normalizeRecordsAndFields:function(){var a=recline.Model.Dataset.prototype._normalizeRecordsAndFields;return function(b,c){var d=this,e=a.call(this,b,c);return d.backend.__type__=="csv"&&recline.Backend.CSV.setFieldsAttributesCSV(e.fields,d,e.records),recline.Data.FieldsUtility.setFieldsAttributes(e.fields,d),e}}(),_handleQueryResult:function(a){var b=recline.Model.Dataset.prototype._handleQueryResult;return function(a){var c=this;if(a.fields&&c.fields.length==0){recline.Data.FieldsUtility.setFieldsAttributes(a.fields,c);var d;c.attributes.renderer&&(d={renderer:c.attributes.renderer}),c.fields.reset(a.fields,d)}return b.call(this,a)}}()}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{query:function(a){var b=recline.Model.Dataset.prototype.query;return function(a){var c=this;a&&this.queryState.set(a,{silent:!0});var d=this.queryState.toJSON(),e=!1;return _.each(c.attributes.customFilterLogic,function(a){a(d),e=!0}),a||e?b.call(this,d):b.call(this,a)}}()}),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{removeFilterByFieldNoEvent:function(a){var b=this.get("filters");for(var c in b)b[c].field===a&&(b.splice(c,1),this.set({filters:b},{silent:!0}))},getFilterByFieldName:function(a){var b=_.find(this.get("filters"),function(b){return b.field==a});return b==-1?null:b},setFilter:function(a){if(a.remove)this.removeFilterByFieldNoEvent(a.field),delete a.remove;else{var b=this.get("filters"),c=!1;for(var d=0;d<b.length;d++)b[d].field==a.field&&(b[d]=a,c=!0);c||b.push(a)}},removeFilterByField:function(a){var b=this.get("filters");for(var c in b)b[c].field==a&&this.removeFilter(c)},clearFilter:function(a){var b=this.get("filters");for(var c in b)if(b[c].field==a){b[c].term=null,b[c].start=null,b[c].stop=null;break}},addSortCondition:function(a,b){var c=this.get("sort");c?c.push({field:a,order:b}):c=[{field:a,order:b}],this.attributes.sort=c,this.trigger("change:filters:sort")},setSortCondition:function(a){var b=this.get("sort");b?b.push(a):b=[a],this.attributes.sort=b},clearSortCondition:function(){this.attributes.sort=null}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{selection:function(a){var b=this;this.trigger("selection:start"),a&&b.queryState.set(a,{silent:!0});var c=b.queryState;recline.Data.Filters.applySelectionsOnRecord(b.queryState.getSelections(),b.records.models,b.fields),b.queryState.trigger("selection:done")},initialize:function(){var a=recline.Model.Dataset.prototype.initialize;return function(){a.call(this),_.bindAll(this,"selection"),_.bindAll(this,"applySelectionOnRecords"),this.queryState.bind("selection:change",this.selection),this.records.bind("reset",this.applySelectionOnRecords)}}(),applySelectionOnRecords:function(){var a=this;this.queryState&&this.queryState.getSelections().lenght>0&&recline.Data.Filters.applySelectionsOnRecord(a.queryState.getSelections(),a.records.models,a.fields)}}),recline.Model.Record.prototype=$.extend(recline.Model.Record.prototype,{isRecordSelected:function(){var a=this;return a.is_selected},setRecordSelection:function(a){var b=this;b.is_selected=a}}),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{getSelections:function(){var a=this.get("selections");return a?a:(this.set({selections:[]},{silent:!0}),this.get("selections"))},getSelectionByFieldName:function(a){var b=_.find(this.get("selections"),function(b){return b.field==a});return b==-1?null:b},addSelection:function(a){var b=JSON.parse(JSON.stringify(a));_.keys(a).length<=3&&(b=_.extend(this._selectionTemplates[a.type],b));var c=this.getSelections();c.push(b),this.trigger("selection:change")},removeSelection:function(a){var b=this.getSelections();b.splice(a,1),this.set({selections:b},{silent:!0}),this.trigger("selection:change")},removeSelectionByField:function(a){var b=this.getSelections();for(var c in b)b[c].field==a&&this.removeSelection(c)},setSelection:function(a){if(a.remove)this.removeSelectionByField(a.field),delete a.remove;else{var b=this.getSelections(),c=!1;for(var d=0;d<b.length;d++)b[d].field==a.field&&(b[d]=a,c=!0);c||b.push(a)}this.trigger("selection:change")},isSelected:function(){return this.getSelections().length>0}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{setShapeSchema:function(){var a=this;_.each(a.attributes.shapeSchema,function(b){var c=_.find(a.fields.models,function(a){return b.field===a.id});c!=null&&(c.attributes.shapeSchema=b.schema)})},_handleQueryResult:function(){var a=recline.Model.Dataset.prototype._handleQueryResult;return function(b){var c=this;if(b.facets)return _.each(b.facets,function(a,b){recline.Data.ShapeSchema.addShapesToTerms(a.id,a.terms,c.attributes.shapeSchema)}),a.call(this,b)}}()}),recline.Model.Record.prototype=$.extend(recline.Model.Record.prototype,{getFieldShapeName:function(a){return a.attributes.shapeSchema?a.attributes.is_partitioned?a.attributes.shapeSchema.getShapeNameFor(a.attributes.partitionValue):a.attributes.shapeSchema.getShapeNameFor(this.getFieldValueUnrendered(a)):null},getFieldShape:function(a,b,c){if(!a.attributes.shapeSchema)return recline.Template.Shapes.empty(null,c,b);var d,e=this.getFieldColor(a);return a.attributes.is_partitioned?d=a.attributes.partitionValue:d=this.getFieldValueUnrendered(a),a.attributes.shapeSchema.getShapeFor(d,e,b,c)}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{initialize:function(){var a=recline.Model.Dataset.prototype.initialize;return function(){a.call(this),this.get("initialState")&&this.get("initialState").setState(this)}}()}),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.UnionDataset=this.recline.Model.UnionDataset||{},function(a,b){b.UnionDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var a=this;_.bindAll(this,"generateFields"),a.ds_fetched=[],a.unionModel=new b.Dataset({backend:"Memory",records:[],fields:[],renderer:a.attributes.renderer}),a.fields=a.unionModel.fields,a.records=a.unionModel.records,a.facets=a.unionModel.facets,a.recordCount=a.unionModel.recordCount,a.queryState=a.unionModel.queryState,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.model.fields.bind("reset",this.generateFields),this.attributes.model.fields.bind("add",this.generateFields),_.each(this.attributes.union,function(b){b.model.fields.bind("reset",a.generateFields),b.model.fields.bind("add",a.generateFields)}),a.attributes.model.recordCount>0&&a.ds_fetched.push("model"),this.attributes.model.bind("query:done",function(){a.ds_fetched.push("model"),a.allDsFetched()&&a.query()}),_.each(this.attributes.union,function(b){b.model.bind("query:done",function(){a.ds_fetched.push(b.id),a.allDsFetched()&&a.query()}),b.model.recordCount>0&&a.ds_fetched.push(b.id),b.model.queryState.bind("change",function(){a.allDsFetched()&&a.query()})}),a.allDsFetched()&&(a.generateFields(),a.query())},allDsFetched:function(){var a=this,b=!0;return _.contains(a.ds_fetched,"model")?(_.each(a.attributes.union,function(c){_.contains(a.ds_fetched,c.id)||(b=!1)}),b):!1},generateFields:function(){var a=this,b=[],c=[];_.each(this.attributes.model.fields.models,function(a){b.push(a.toJSON())}),_.each(this.attributes.union,function(a){_.each(a.model.fields.models,function(a){_.find(b,function(b){return b.id==a.id})||b.push(a.toJSON())})}),this.unionModel.resetFields(b)},query:function(a){var b=this;b.trigger("query:start"),a&&this.queryState.set(a,{silent:!0});var c=b.union();b.unionModel.resetRecords(c),b.unionModel.fetch(),b.recordCount=b.unionModel.recordCount,b.trigger("query:done")},union:function(){var a=this.attributes.model,b=this.attributes.union,c=[];return _.each(a.records.toJSON(),function(a){c.push(a)}),_.each(b,function(a){_.each(a.model.records.toJSON(),function(a){c.push(a)})}),c},addCustomFilterLogic:function(a){return this.unionModel.addCustomFilterLogic(a)},getRecords:function(a){return this.unionModel.getRecords(a)},getFields:function(a){return this.unionModel.getFields(a)},toTemplateJSON:function(){return this.unionModel.toTemplateJSON()},getFacetByFieldId:function(a){return this.unionModel.getFacetByFieldId(a)},isFieldPartitioned:function(a){return!1},toFullJSON:function(a){return this.unionModel.toFullJSON(a)},setColorSchema:function(){return this.attributes.colorSchema&&(this.unionModel.attributes.colorSchema=this.attributes.colorSchema),this.unionModel.setColorSchema()}})}(jQuery,this.recline.Model),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.VirtualDataset=this.recline.Model.VirtualDataset||{},function(a,b){b.VirtualDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){_.bindAll(this,"query");var a=this;a.vModel=new b.Dataset({backend:"Memory",records:[],fields:[],renderer:a.attributes.renderer}),a.fields=a.vModel.fields,a.records=a.vModel.records,a.facets=a.vModel.facets,a.recordCount=a.vModel.recordCount,a.queryState=a.vModel.queryState,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.dataset.bind("query:done",function(){a.initializeCrossfilter()}),this.queryState.bind("change",function(){a.query()}),this.queryState.bind("selection:change",function(){a.selection()}),this.attributes.dataset.records.models.length>0&&a.initializeCrossfilter()},getRecords:function(a){var b=this;return a==="totals"?(b.needsTableCalculation&&b.totals==null&&b.rebuildTotals(),b.totals.records.models):a==="totals_unfiltered"?(b.totals_unfiltered==null&&b.rebuildUnfilteredTotals(),b.totals_unfiltered.records.models):(b.needsTableCalculation&&b.totals==null&&b.rebuildTotals(),b.vModel.getRecords(a))},getField_byAggregationFunction:function(a,b,c){var d=this.getFields(a);return d.get(b+"_"+c)},getFields:function(a){var b=this;return a==="totals"?(b.totals==null&&b.rebuildTotals(),b.totals.fields):a==="totals_unfiltered"?(b.totals==null&&b.rebuildUnfilteredTotals(),b.totals_unfiltered.fields):b.vModel.getFields(a)},fetch:function(){this.initializeCrossfilter()},initializeCrossfilter:function(){var a=this.attributes.aggregation.measures,b=this.attributes.aggregation.aggregationFunctions,c=this.attributes.dataset.fields,d=this.attributes.aggregation.dimensions,e=this.attributes.aggregation.partitions,f=crossfilter(this.attributes.dataset.toFullJSON()),g=this.createDimensions(f,d),h=this.reduce(g,d,a,b,e);this.updateStore(h,c,d,b,a,e),this.trigger("query:done")},setDimensions:function(a){this.attributes.aggregation.dimensions=a,this.trigger("dimensions:change")},setMeasures:function(a){this.attributes.aggregation.measures=a,this.trigger("measures:change")},setTotalsMeasures:function(a){this.attributes.totals.measures=a,this.trigger("totals:change")},getDimensions:function(){return this.attributes.aggregation.dimensions},createDimensions:function(a,b){var c;if(b==null)c=a.groupAll();else{var d=a.dimension(function(a){var c="";for(i=0;i<b.length;i++)i>0&&(c+="#"),a[b[i]]?c+=a[b[i]].valueOf():c+="NULL";return c});c=d.group()}return c},reduce:function(a,b,c,d,e){function h(a,b){a.count=a.count+1;for(i=0;i<c.length;i++){for(j=0;j<d.length;j++){var h=this.recline.Data.Aggregations.aggregationFunctions[d[j]];a[d[j]][c[i]]=h(a[d[j]][c[i]],b[c[i]])}if(f)for(x=0;x<e.length;x++){var k=e[x],l=b[e[x]],m=c[i],n=m+"_by_"+k+"_"+l;for(j=0;j<d.length;j++){g[d[j]]==null&&(g[d[j]]={});var h=this.recline.Data.Aggregations.aggregationFunctions[d[j]];a.partitions[d[j]][n]==null&&(a.partitions[d[j]][n]={value:null,partition:l,originalField:m,aggregationFunction:h},g[d[j]][n]={field:k,value:l,originalField:m,aggregationFunction:h,aggregationFunctionName:d[j],id:n+"_"+d[j]}),a.partitions[d[j]][n].value=h(a.partitions[d[j]][n].value,b[c[i]])}a.partitions.count[n]==null?a.partitions.count[n]={value:1,partition:l,originalField:m,aggregationFunction:"count"}:a.partitions.count[n].value+=1}}return a}function k(a,b){throw"crossfilter reduce remove function not implemented"}function l(){var a={count:0};for(j=0;j<d.length;j++)a[d[j]]={},this.recline.Data.Aggregations.initFunctions[d[j]](a,c,e);if(f){a.partitions={},a.partitions.count={};for(j=0;j<d.length;j++)a.partitions[d[j]]={}}return a}var f=!1,g={};if(e!=null)var f=!0;var m=a.reduce(h,k,l),n;return b==null?n=[m.value()]:n=m.all(),{reducedResult:n,partitionFields:g}},updateStore:function(a,b,c,d,e,f){var g=this,h=a.reducedResult,i=a.partitionFields;this.partitionFields=i;var j=g.buildFields(h,b,i,c,d),k=g.buildResult(h,b,i,c,d,e,f);g.vModel.resetFields(j),g.vModel.resetRecords(k),recline.Data.FieldsUtility.setFieldsAttributes(j,g),this.clearUnfilteredTotals(),g.vModel.fetch(),g.recordCount=g.vModel.recordCount},rebuildTotals:function(){this._rebuildTotals(this.records,this.fields,!0)},rebuildUnfilteredTotals:function(){this._rebuildTotals(this._store.data,this.fields,!1)},clearUnfilteredTotals:function(){this.totals_unfiltered=null,this.clearFilteredTotals()},clearFilteredTotals:function(){this.totals=null},_rebuildTotals:function(a,c,d){var e=this;if(!e.attributes.totals)return;var f=e.attributes.totals.measures,g=e.attributes.totals.aggregationFunctions,h;a.constructor==Array?h=a:h=_.map(a.models,function(a){return a.attributes});var i=crossfilter(h),j=this.createDimensions(i,null),k=this.reduce(j,null,f,g,null),l=e.buildFields(k.reducedResult,c,{},null,g),m=e.buildResult(k.reducedResult,c,{},null,g,f,null),n=recline.Data.Aggregations.checkTableCalculation(e.attributes.aggregation.aggregationFunctions,e.attributes.totals);_.each(n,function(a){var b;_.each(h,function(c){b=recline.Data.Aggregations.tableCalculations[a](e.attributes.aggregation.measures,b,c,m[0])})}),recline.Data.FieldsUtility.setFieldsAttributes(l,e);var o;e.attributes.renderer&&(o={renderer:e.attributes.renderer}),d?(this.totals==null&&(this.totals={records:new b.RecordList,fields:new b.FieldList}),this.totals.fields.reset(l,o),this.totals.records.reset(m)):(this.totals_unfiltered==null&&(this.totals_unfiltered={records:new b.RecordList,fields:new b.FieldList}),this.totals_unfiltered.fields.reset(l,o),this.totals_unfiltered.records.reset(m))},needsTableCalculation:function(){return recline.Data.Aggregations.checkTableCalculation(self.attributes.aggregation.aggregationFunctions,self.attributes.totals).length>0?!0:!1},buildResult:function(a,b,c,d,e,f,g){var h=!1;if(g!=null)var h=!0;var i;d==null?i=a:a.length>0?i=a[0].value:i={count:0};var j=[];for(var k=0;k<a.length;k++){var l,m=a[k],n;if(d!=null){var o=a[k].key.split("#");n={dimension:m.key,count:m.value.count};for(var p=0;p<o.length;p++){var q=d[p],r=b.get(q).attributes,s=r.type,t=recline.Data.FormattersMoviri[s],u=t(o[p]);n[d[p]]=u}l=m.value}else l=m,n={count:m.count};for(var p=0;p<e.length;p++){var v=[];c[e[p]]!=null&&(v=c[e[p]]),recline.Data.Aggregations.finalizeFunctions[e[p]](l,f,_.keys(v));var w;typeof l[e[p]]=="function"?w=l[e[p]]():w=l[e[p]];for(var x in w){var y;typeof w[x]=="function"?y=w[x]():y=w[x],n[x+"_"+e[p]]=y}if(h){var w;typeof l.partitions[e[p]]=="function"?w=l.partitions[e[p]]():w=l.partitions[e[p]];for(var x in w){var y;typeof l.partitions[e[p]]=="function"?y=l.partitions[e[p]]():y=l.partitions[e[p]];var z=x+"_"+e[p];n[z]=y[x].value}}}if(h)for(var x in i.partitions.count)m.value.partitions["count"][x]==null?n[x+"_count"]=0:n[x+"_count"]=m.value.partitions.count[x].value;j.push(n)}return j},buildFields:function(a,b,c,d,e){var f=this,g=[],h;d==null?a.constructor!=Array?h=a:a.length>0?h=a[0]:h={count:0}:a.length>0?h=a[0].value:h={count:0},g.push({id:"count",type:"integer"});for(var i=0;i<e.length;i++){var j;typeof h[e[i]]=="function"?j=h[e[i]]():j=h[e[i]];for(var k in j){var l=b.get(k);if(!l)throw"Virtualmodel: unable to find field ["+k+"] in model";var m=l.attributes,n=recline.Data.Aggregations.resultingDataType[e[i]](m.type),o=k+"_"+e[i];f.attributes.fieldLabelForFields&&(o=f.attributes.fieldLabelForFields.replace("{originalFieldLabel}",m.label).replace("{aggregatedFunction}",e[i])),g.push({id:k+"_"+e[i],type:n,is_partitioned:!1,colorSchema:m.colorSchema,shapeSchema:m.shapeSchema,originalField:k,aggregationFunction:e[i],label:o})}_.each(c,function(a){_.each(a,function(a){var c=b.get(a.field).attributes,d=recline.Data.Aggregations.resultingDataType[e[i]](c.type),h=a.id,j=h;f.attributes.fieldLabelForPartitions&&(j=f.attributes.fieldLabelForPartitions.replace("{originalField}",a.originalField).replace("{partitionFieldName}",a.field).replace("{partitionFieldValue}",a.value).replace("{aggregatedFunction}",e[i])),g.push({id:h,type:d,is_partitioned:!0,partitionField:a.field,partitionValue:a.value,colorSchema:c.colorSchema,shapeSchema:c.shapeSchema,originalField:a.originalField,aggregationFunction:e[i],label:j})})})}if(d!=null){g.push({id:"dimension"});for(var p=0;p<d.length;p++){var q=b.get(d[p]);if(!q)throw"VirtualModel.js: unable to find field ["+d[p]+"] in model";var m=q.attributes;g.push({id:d[p],type:m.type,label:m.label,format:m.format,colorSchema:m.colorSchema,shapeSchema:m.shapeSchema})}}return g},query:function(a){var b=this;b.trigger("query:start"),a&&this.queryState.set(a,{silent:!0}),b.clearFilteredTotals(),b.vModel.query(a),b.recordCount=b.vModel.recordCount,b.trigger("query:done")},selection:function(a){return this.vModel.selection(a)},setColorSchema:function(a){return this.attributes.colorSchema&&(this.vModel.attributes.colorSchema=this.attributes.colorSchema),this.vModel.setColorSchema(a)},setShapeSchema:function(a){return this.vModel.setShapeSchema(a)},getFacetByFieldId:function(a){return this.vModel.getFacetByFieldId(a)},toTemplateJSON:function(){return this.vModel.toTemplateJSON()},getFieldsSummary:function(){return this.vModel.getFieldsSummary()},addStaticColorSchema:function(a,b){return this.vModel.addStaticColorSchema(a,b)},getPartitionedFields:function(a,b){var c=_.filter(this.fields.models,function(c){return c.attributes.partitionField==a&&c.attributes.originalField==b});return c==null&&(field=[]),c},isFieldPartitioned:function(a,b){var c=this.getFields(b).get(a);if(!c)throw"Virtualmodel.js: isFieldPartitioned: unable to find field ["+a+"] in virtualmodel ["+this.id+"]";return c.attributes.aggregationFunction&&this.attributes.aggregation.partitions},getPartitionedFieldsForAggregationFunction:function(a,b){var c=this,d=[];return _.each(c.partitionFields[a],function(a){a.originalField==b&&d.push(c.fields.get(a.id))}),d},addCustomFilterLogic:function(a){return this.vModel.addCustomFilterLogic(a)}})}(jQuery,this.recline.Model),this.recline=this.recline||{},function(a,b){b.ActionUtility={},b.ActionUtility.doAction=function(a,b,c){var d=_.filter(a,function(a){var c=_.find(a.event,function(a){return a==b});return c!=-1?!0:!1});_.each(d,function(a){var b=a.mapping,d=[];_.each(b,function(b){if(c[b["srcField"]]==null&&a.action.attributes.filters[b.filter].type!="list")console.log("warn: sourceField: ["+b.srcField+"] not present in event data");else{var e={filter:b.filter,value:c[b.srcField]};d.push(e)}}),d.length>0&&a.action._internalDoAction(d)})},b.ActionUtility.getActiveFilters=function(a){var b=[];return _.each(a,function(a){_.each(a.mapping,function(c){var d=a.action.getActiveFilters(c.filter,c.srcField);d!=null&&d.length>0&&(b=_.union(b,d))})}),b},b.Action=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){},doAction:function(a,b){var c=[];b.forEach(function(b){var d=[];a.forEach(function(a){d.push(a.getFieldValueUnrendered({id:b.srcField}))}),c.push({filter:b.filter,value:d})}),this._internalDoAction(c)},doActionWithFacets:function(a,b,c,d){var e=[];c.forEach(function(c){var f=[];a.forEach(function(a){a.records.forEach(function(a){var e=a[d];_.contains(b,e)&&!_.contains(f,a[c.srcField])&&f.push(a[c.srcField])})}),e.push({filter:c.filter,value:f})}),this._internalDoAction(e)},doActionWithValues:function(a,b){var c=[];b.forEach(function(b){var d=[];_.each(a,function(a){a.field===b.srcField&&c.push({filter:b.filter,value:a.value})})}),this._internalDoAction(c)},_internalDoAction:function(a){var b=this,c=this.attributes.filters,d=this.attributes.models,e=this.attributes.type,f=[];_.each(a,function(a){var d=c[a.filter];if(d==null)throw"Filter "+a.filter+" defined in actions data not configured for action ";d.name=a.filter;if(b.filters[d.type]==null)throw"Filter not implemented for type "+d.type;f.push(b.filters[d.type](d,a.value))}),_.each(e,function(a){_.each(d,function(c){var d=[];_.each(f,function(a){d.push(_.clone(a))});var e=!1;_.each(d,function(d){_.find(c.filters,function(a){return a==d.name})!=null&&(b.modelsAddFilterActions[a](c.model,d),e=!0)}),e&&b.modelsTriggerActions[a](c.model)})}),_.each(a,function(a){var b=c[a.filter];delete b.remove})},getActiveFilters:function(a,b){var c=this,d=this.attributes.models,e=this.attributes.type,f=this.attributes.filters,g=[];return _.each(e,function(e){_.each(d,function(d){var h=_.filter(d.filters,function(b){return b==a});_.each(h,function(a){var h=f[a];if(h!=null){var i=c.modelsGetFilter[e](d.model,h.field);i!=null&&(i.field=b,g.push(i))}})})}),g},modelsGetFilter:{filter:function(a,b){return a.queryState.getFilterByFieldName(b)},selection:function(a,b){throw"Action.js selection not implemented selection for selection"},sort:function(a,b){throw"Action.js sort not implemented selection for sort"}},modelsAddFilterActions:{filter:function(a,b){a.queryState.setFilter(b)},selection:function(a,b){a.queryState.setSelection(b)},sort:function(a,b){a.queryState.clearSortCondition(),a.queryState.setSortCondition(b)}},modelsTriggerActions:{filter:function(a){a.queryState.trigger("change")},selection:function(a){a.queryState.trigger("selection:change")},sort:function(a){a.queryState.trigger("change")}},filters:{term:function(a,b){if(b.length===0)a.term=null,a.remove=!0;else{if(b.length!==1)throw"Data passed for filtertype term not valid. Data lenght should be 1 or empty but is "+b.length;b[0]==null?a.remove=!0:a.term=b[0]}return a},range:function(a,b){if(b.length===0)a.start=null,a.stop=null;else if(b[0]===null||b[1]===null)a.remove=!0;else{if(b.length!==2)throw"Data passed for filtertype range not valid. Data lenght should be 2 but is "+b.length;a.start=b[0],a.stop=b[1]}return a},list:function(a,b){return b===null?a.list=null:b.length===0?(a.remove=!0,a.list=[]):a.list=b,a},sort
:function(a,b){if(b.length===0)a=null;else{if(b.length!=2)throw"Actions.js: invalid data length ["+b+"]";a.field=b[0],a.order=b[1]}return a}}})}(jQuery,this.recline),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(a){a.Aggregations={},a.Aggregations.aggregationFunctions={sum:function(a,b){return a==null&&(a=0),a+b},avg:function(a,b){},max:function(a,b){return a==null?b:Math.max(a,b)},min:function(a,b){return a==null?b:Math.min(a,b)},ratioToReport:function(a,b){},ratioToMax:function(a,b){},runningTotal:function(a,b){}},a.Aggregations.initFunctions={sum:function(){},avg:function(){},max:function(){},min:function(){},ratioToReport:function(){},ratioToMax:function(){},runningTotal:function(){}},a.Aggregations.resultingDataType={sum:function(a){return a},avg:function(a){return"float"},max:function(a){return a},min:function(a){return a},ratioToReport:function(a){return"float"},ratioToMax:function(a){return"float"},runningTotal:function(a){return a}},a.Aggregations.finalizeFunctions={sum:function(){},avg:function(a,b,c){a.avg=function(a,b){return function(){var b={};for(var c=0;c<a.length;c++)b[a[c]]=this.sum[a[c]]/this.count;return b}}(b,c),c!=null&&c.length>0&&(a.partitions.avg=function(b,c){return function(){var b={};for(var d=0;d<c.length;d++)a.partitions.sum[c[d]]&&(b[c[d]]={value:a.partitions.sum[c[d]].value/a.partitions.count[c[d]].value,partition:a.partitions.sum[c[d]].partition});return b}}(b,c))},max:function(){},min:function(){},ratioToReport:function(){},ratioToMax:function(){},runningTotal:function(){}},a.Aggregations.tableCalculations={ratioToReport:function(a,b,c,d){return _.each(a,function(a){d[a+"_sum_sum"]>0&&(c[a+"_ratioToReport"]=c[a+"_sum"]/d[a+"_sum_sum"])}),c},ratioToMax:function(a,b,c,d){return _.each(a,function(a){d[a+"_sum_max"]>0&&(c[a+"_ratioToMax"]=c[a+"_sum"]/d[a+"_sum_max"])}),c},runningTotal:function(a,b,c,d){return _.each(a,function(a){b?c[a+"_runningTotal"]=c[a+"_sum"]+b[a+"_runningTotal"]:c[a+"_runningTotal"]=c[a+"_sum"]}),c}};var b=function(a,b,c){var d=c.split("."),e,f;if(d.length>0){e=a,f=b;for(var g=0;g<d.length;g++)arr=d[g].match(/(.*)\[\'?(\d*\w*)\'?\]/i),arr&&arr.length==3?(e=e[arr[1]]?e[arr[1]][arr[2]]:e[d[g]],f=f[arr[1]]?f[arr[1]][arr[2]]:f[d[g]]):(e=e[d[g]],f=f[d[g]])}return _.isEqual(e,f)};a.Aggregations.intersectionObjects=a.Aggregations.intersectObjects=function(a,c){var d=Array.prototype.slice,e=d.call(arguments,1);return _.filter(_.uniq(c),function(c){return _.every(e,function(d){return _.any(d,function(d){var e=b(d,c,a);return e&&_.extend(c,d),e})})})},a.Aggregations.checkTableCalculation=function(b,c){var d=_.intersection(b,["runningTotal","ratioToReport","ratioToMax"]);return d.length>0&&_.each(d,function(b){if(!_.intersection(c.aggregationFunctions,a.Aggregations.tableCalculationDependencies[b]))throw"Data.Aggregation: unable to calculate "+b+", totals aggregation function ["+a.Aggregations.tableCalculationDependencies[b]+"] must be defined"}),d},a.Aggregations.tableCalculationDependencies={runningTotal:[],ratioToReport:["sum"],ratioToMax:["max"]}}(this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.ColorSchema=this.recline.Data.ColorSchema||{},function(a,b){b.ColorSchema=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var a=this;if(this.attributes.data){var b=this.attributes.data;a._generateLimits(b)}else if(this.attributes.dataset)this.bindToDataset();else if(this.attributes.fields){var b=this.attributes.fields;this.attributes.type="scaleWithDistinctData",a._generateLimits(b)}if(this.attributes.twoDimensionalVariation)if(this.attributes.twoDimensionalVariation.data){var b=this.attributes.twoDimensionalVariation.data;a._generateVariationLimits(b)}else this.attributes.twoDimensionalVariation.dataset&&this.bindToVariationDataset()},bindToDataset:function(){var a=this;a.attributes.dataset.dataset.records.bind("reset",function(){a._generateFromDataset()}),a.attributes.dataset.dataset.fields.bind("reset",function(){a.attributes.dataset.dataset.setColorSchema(a.attributes.dataset.type)}),a.attributes.dataset.dataset.fields.bind("add",function(){a.attributes.dataset.dataset.setColorSchema(a.attributes.dataset.type)}),a.attributes.dataset.dataset.records.models.length>0&&a._generateFromDataset()},bindToVariationDataset:function(){var a=this;a.attributes.twoDimensionalVariation.dataset.dataset.records.bind("reset",function(){a._generateFromVariationDataset()}),a.attributes.twoDimensionalVariation.dataset.dataset.records.models.length>0&&a._generateFromVariationDataset()},setDataset:function(a,b,c){var d=this;a.attributes.colorSchema||(a.attributes.colorSchema=[]),d.attributes.fields?_.each(d.attributes.fields,function(b){a.attributes.colorSchema.push({schema:d,field:b})}):(d.attributes.dataset={dataset:a,field:b,type:c},a.attributes.colorSchema.push({schema:d,field:b}),d.bindToDataset()),a.setColorSchema(c)},setVariationDataset:function(a,b){var c=this;c.attributes.twoDimensionalVariation={dataset:{dataset:a,field:b}},c.bindToVariationDataset()},generateFromExternalDataset:function(a){var b=this,c=this.getRecordsArray(a);b._generateLimits(c)},_generateFromDataset:function(){var a=this,b=this.getRecordsArray(a.attributes.dataset);a._generateLimits(b)},_generateFromVariationDataset:function(){var a=this,b=this.getRecordsArray(a.attributes.twoDimensionalVariation.dataset);a._generateVariationLimits(b)},_generateLimits:function(a){var b=this;switch(this.attributes.type){case"scaleWithDataMinMax":b.schema=new chroma.ColorScale({colors:this.attributes.colors,limits:this.limits.minMax(a)});break;case"scaleWithDistinctData":b.schema=new chroma.ColorScale({colors:this.attributes.colors,limits:[0,1]}),b.limitsMapping=this.limits.distinct(a,b.oldLimitData),b.oldLimitData=a;break;case"fixedLimits":b.schema=new chroma.ColorScale({colors:this.attributes.colors,limits:this.attributes.limits});break;default:throw"data.colors.js: unknown or not defined properties type ["+this.attributes.type+"] possible values are [scaleWithDataMinMax,scaleWithDistinctData,fixedLimits]"}},getScaleType:function(){return this.attributes.type},getScaleLimits:function(){return this.schema.limits},_generateVariationLimits:function(a){var b=this;b.variationLimits=this.limits.minMax(a)},getColorFor:function(a){var b=this;if(this.schema==null&&!b.attributes.defaultColor)throw"data.colors.js: colorschema not yet initialized, datasource not fetched?";return b.limitsMapping?b.limitsMapping[a]!=null?this.schema.getColor(b.limitsMapping[a]):chroma.hex(b.attributes.defaultColor):b.schema?this.schema.getColor(a):chroma.hex(b.attributes.defaultColor)},getTwoDimensionalColor:function(a,b){if(this.schema==null)throw"data.colors.js: colorschema not yet initialized, datasource not fetched?";if(this.attributes.twoDimensionalVariation==null)return this.getColorFor(a);var c="#000000";this.attributes.twoDimensionalVariation.type=="toLight"&&(c="#ffffff");var d=this,e=new chroma.ColorScale({colors:[d.getColorFor(a),c],limits:d.variationLimits,mode:"hsl"});return e.getColor(b)},getRecordsArray:function(a){if(!a.dataset.fields.get(a.field))return;var b=[];if(a.dataset.isFieldPartitioned&&a.dataset.isFieldPartitioned(a.field)){var c=a.dataset.getPartitionedFields(a.field);_.each(a.dataset.getRecords(a.type),function(a){_.each(c,function(c){b.push(a.getFieldValueUnrendered(c))})})}else{var c=[a.field];_.each(a.dataset.getRecords(a.type),function(a){_.each(c,function(c){var e=a.fields.get(c);b.push(a.getFieldValueUnrendered(e))})})}return b},limits:{minMax:function(a){var b=[null,null];return a&&a.length==1?b=[0,a[0]]:_.each(a,function(a){b[0]==null?b[0]=a:b[0]=Math.min(b[0],a),b[1]==null?b[1]=a:b[1]=Math.max(b[1],a)}),b},distinct:function(){var a=function(a){var b=0,c,d,e;if(a.length===0)return b;for(c=0;c<a.length;c++)for(d=0;d<a[c].length;d++)e=a[c].charCodeAt(d),b=(b<<5)-b+e,b&=b;return b},b=function(){var a={},b=function(a){return a+a-1};return function(c){if(a[c])return a[c];var d=2;while(d<c)d=b(d);return a[c]=d,d}}(),c=function(a,b,c){return a/(c-1)},d={},e={},f={};return function(g,h){var i={},j={},k=[],l;g?g.sort(function(a,b){return a>b?1:b>a?-1:0}):g=[],h?h.sort(function(a,b){return a>b?1:b>a?-1:0}):h=[];var m=_.uniq(g,!0);m[0]==null&&(m=[]);var n=_.uniq(h,!0);n[0]==null&&(n=[]);var o=f[a(n)]||b(n.length),p=Math.max(b(m.length),o),q=0;p>o&&(o*2<p?n=[]:q=1),k=n.length?e[a(n)]:[];if(q==1&&n.length!==0)for(l=1;l<p;l+=2)k.push(l);if(n.length===0){l=0,_.each(m,function(a){p===1?i[a]=0:i[a]=c(l,m.length,p),j[a]=l,l++});for(l=m.length;l<p;l++)k.push(l)}else{var r,s,t=0,u=0,v=d[a(n)];l=0,r=0;while(!t&&!u)m[l]===n[r]?(l++,r++):m[l]<n[r]?l++:(k.push(v[n[r]]),r++),t=r>=n.length,u=l>=m.length;while(!t)k.push(v[n[r]]),r++,t=r>=n.length;l=0,r=0,t=0,u=0;while(!t&&!u)m[l]===n[r]?(s=v[n[r]]*Math.pow(2,q),j[m[l]]=s,i[m[l]]=c(s,m.length,p),l++,r++):m[l]<n[r]?(s=k.pop(),j[m[l]]=s,i[m[l]]=c(s,m.length,p),l++):r++,t=r>=n.length,u=l>=m.length;if(!u)for(;l<m.length;l++)s=k.pop(),j[m[l]]=s,i[m[l]]=c(s,m.length,p)}return d[a(m)]=j,e[a(m)]=k,f[a(m)]=p,i}}()}}),b.ColorSchema.addColorsToTerms=function(a,b,c){_.each(b,function(b){c&&_.each(c,function(c){c.field===a&&(b.color=c.schema.getColorFor(b.term))})})}}(jQuery,this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(a){a.Faceting={},a.Faceting.computeFacets=function(a,b){var c=this,d={};return b.facets?(_.each(b.facets,function(a,b){d[b]=(new recline.Model.Facet({id:b})).toJSON(),d[b].termsall={}}),_.each(a,function(a){_.each(b.facets,function(b,c){var e=b.terms.field,f=a[e],g=d[c];f?g.termsall[f]?(g.termsall[f].records.push(a),g.termsall[f].count=g.termsall[f].count+1):g.termsall[f]={count:1,value:f,records:[a]}:g.missing=g.missing+1})}),c.updateDistinctFieldsForFaceting(b),_.each(b.facets,function(a,b){var e=d[b],f=_.difference(c.distinctFieldsValues[b],_.map(e.termsall,function(a){return a.value}));_.each(f,function(a){e.termsall[a]={count:0,value:a,records:[]}})}),_.each(b.facets,function(a,b){var c=d[b],e=_.map(c.termsall,function(a,b){return{term:a.value,count:a.count,records:a.records}});c.terms=_.sortBy(e,function(a){return-a.count})}),d):d},a.Faceting.updateDistinctFieldsForFaceting=function(a){var b=this;this.distinctFieldsValues==null&&(this.distinctFieldsValues={});var c=[];_.each(a.facets,function(a,d){a.terms.all_terms&&b.distinctFieldsValues[d]==null&&c.push(d)}),c.length>0&&(_.each(c,function(a){b.distinctFieldsValues[a]=[]}),_.each(b.data,function(a){_.each(c,function(c){b.distinctFieldsValues[c].push(a[c])})})),_.each(c,function(a){b.distinctFieldsValues[a]=_.uniq(b.distinctFieldsValues[a])})}}(this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.FieldsUtility=this.recline.Data.FieldsUtility||{},function(a,b){b.setFieldsAttributes=function(a,b,c){if(b.attributes.fieldLabels)for(var d=0;d<a.length;d++){var e=_.find(b.attributes.fieldLabels,function(b){return b.id==a[d].id});e!=null&&(a[d].label=e.label)}if(b.attributes.fieldsFormat){if(!b.attributes.fieldsFormat.length)throw"Wrong fieldsFormat parameter. Must be an array, not a single object!";_.each(b.attributes.fieldsFormat,function(b){var c=_.find(a,function(a){return b.id===a.id});c!=null&&(c.format=b.format)})}b.attributes.colorSchema&&_.each(b.attributes.colorSchema,function(b){var c=_.find(a,function(a){return b.field===a.id});c!=null&&(c.colorSchema=b.schema)}),b.attributes.shapeSchema&&_.each(b.attributes.shapeSchema,function(b){var c=_.find(a,function(a){return b.field===a.id});c!=null&&(c.shapeSchema=b.schema)})}}(jQuery,this.recline.Data.FieldsUtility),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(a){a.Filters={},a.Filters.applyFiltersOnData=function(a,b,c){return _.filter(b,function(b){var d=_.map(a,function(a){return recline.Data.Filters._isNullFilter[a.type](a)||recline.Data.Filters._filterFunctions[a.type](b,a,c)});return _.all(d,_.identity)})},a.Filters.applyFiltersOnRecords=function(a,b,c){return _.filter(b.models,function(b){var d=_.map(a,function(a){return recline.Data.Filters._isNullFilter[a.type](a)||recline.Data.Filters._filterFunctions[a.type](b.toJSON(),a,c.toJSON())});return _.all(d,_.identity)})},a.Filters.applySelectionsOnRecord=function(a,b,c){_.each(b,function(b){b.setRecordSelection(!1),_.each(a,function(a){!recline.Data.Filters._isNullFilter[a.type](a)&&recline.Data.Filters._filterFunctions[a.type](b.attributes,a,c)&&b.setRecordSelection(!0)})})},a.Filters._getDataParser=function(a,b){var c={},d;b.models?d=b.models:d=b,_.each(d,function(a){c[a.id]=a});var e=c[a.field],f="string";if(e==null)throw"data.filters.js: Warning could not find field "+a.field+" for dataset ";return e.attributes?f=e.attributes.type:e.type&&(f=e.type),recline.Data.Filters._dataParsers[f]},a.Filters._isNullFilter={term:function(a){return a["term"]==null},range:function(a){return a["start"]==null||a["stop"]==null},list:function(a){return a["list"]==null},termAdvanced:function(a){return a["term"]==null}},this._applyFilters=function(a,b){function g(a){var b=f[a.field].type||"string";return e[b]}var c=b.filters,d={term:term,range:range,geo_distance:geo_distance},e={integer:function(a){return parseFloat(a,10)},"float":function(a){return parseFloat(a,10)},string:function(a){return a.toString()},date:function(a){return(new Date(a)).valueOf()},datetime:function(a){return(new Date(a)).valueOf()}},f={};return _.each(self.fields,function(a){f[a.id]=a}),_.filter(a,function(a){var b=_.map(c,function(b){return d[b.type](a,b)});return _.all(b,_.identity)})},a.Filters._filterFunctions={term:function(a,b,c){var d=recline.Data.Filters._getDataParser(b,c),e=d(a[b.field]),f=d(b.term);return e===f},range:function(a,b,c){var d=b.start==null||b.start==="",e=b.stop==null||b.stop==="",f=recline.Data.Filters._getDataParser(b,c),g=f(a[b.field]),h=f(b.start),i=f(b.stop);return(!d||!e)&&g===""?!1:(d||g>=h)&&(e||g<=i)},list:function(a,b,c){var d=recline.Data.Filters._getDataParser(b,c),e=d(a[b.field]),f=b.list;return _.each(f,function(a,b){f[b]=d(a)}),_.contains(f,e)},termAdvanced:function(a,b,c){var d=recline.Data.Filters._getDataParser(b,c),e=d(a[b.field]),f=d(b.term),g=b.operator,h={ne:function(a,b){return a!==b},eq:function(a,b){return a===b},lt:function(a,b){return a<b},lte:function(a,b){return a<=b},gt:function(a,b){return a>b},gte:function(a,b){return a>=b},bw:function(a,b){return _.contains(b,a)}};return h[g](e,f)}},a.Filters._dataParsers={integer:function(a){return parseFloat(a,10)},"float":function(a){return parseFloat(a,10)},string:function(a){return a?a.toString():null},date:function(a){return(new Date(a)).valueOf()},datetime:function(a){return(new Date(a)).valueOf()},number:function(a){return parseFloat(a,10)}}}(this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(a){a.Format={},a.Formatters={},a.FormattersMoviri={integer:function(a){return isFinite(a)?parseInt(a,10):0},string:function(a){return a?a.toString():null},date:function(a){return(new Date(parseInt(a))).valueOf()},"float":function(a){return isFinite(a)?parseFloat(a,10):0},number:function(a){return isFinite(a)?parseFloat(a,10):0}},a.Format.decimal=d3.format(".00f"),a.Format.scale=function(a){var b=function(a,b){return[0,a*b]};return function(c,d,e){var f={},g;f.axisScale={};var h=b(e,d);if(a.type==="linear"){var i=d3.max(c,function(b){var c=0;return g=0,_.each(a.domain,function(a){c=b.getFieldValue({id:a})>c?b.getFieldValue({id:a}):c,g++}),c*g});_.each(a.domain,function(b,c){var d,e=[h[0],h[1]/g];c%2==1&&a.invertEven?d=[i/g,0]:d=[0,i/g],f.axisScale[b]=d3.scale.linear().domain(d).range(e)}),f.scale=d3.scale.linear().domain([0,i]).range(h)}return f}},a.Formatters.Renderers=function(b,c,d){var e=a.Formatters.RenderersImpl[c.attributes.type];if(e==null)throw"No custom renderers defined for field type "+c.attributes.type;return e(b,c,d)},a.Formatters.RenderersConvert_ALL_=function(b,c,d){var e=function(a,b,c){var d=b.get("format");if(d==="markdown"){if(typeof Showdown!="undefined"){var e=new Showdown.converter;return out=e.makeHtml(a),out}return a}return d=="plain"?a?a.replace(/\b_ALL_\b/g,"All"):a:(a&&typeof a=="string"&&(a=a.replace(/(https?:\/\/[^ ]+)/g,'<a href="$1">$1</a>').replace(/\b_ALL_\b/g,"All")),a)},f=a.Formatters.RenderersImpl[c.attributes.type];if(f==null)throw"No custom renderers defined for field type "+c.attributes.type;return c.attributes.type=="string"&&(f=e),f(b,c,d)},a.Formatters.RenderersImpl={object:function(a,b,c){return JSON.stringify(a)},integer:function(a,b,c){var d=b.get("format");return d==="currency_euro"?accounting.formatMoney(a,{symbol:"â‚¬",format:"%v %s",decimal:".",thousand:",",precision:0}):accounting.formatNumber(a,0,",")},date:function(a,b,c){var d=b.get("format");return d==null||d=="date"?a:d==="localeTimeString"?(new Date(a)).toLocaleString():d==="timeString"?(new Date(a)).toUTCString():(new Date(a)).toUTCString()},geo_point:function(a,b,c){return JSON.stringify(a)},number:function(a,b,c){var d=b.get("format");if(d==="percentage")try{return accounting.formatNumber(a,2,",",".")+'<small class="muted">%</small>'}catch(e){return"-"}else if(d==="percentage_0to1")try{return a>1?accounting.formatNumber(a,2,",",".")+'<small class="muted">%</small>':accounting.formatNumber(a*100,2,",",".")+'<small class="muted">%</small>'}catch(e){return"-"}else if(d==="currency_euro")try{return accounting.formatMoney(a,{symbol:"",format:"%v %s",decimal:".",thousand:",",precision:0})+'<small class="muted">â‚¬</small>'}catch(e){return"-"}else if(d==="currency_euro_decimal")try{return accounting.formatMoney(a,{symbol:"",format:"%v %s",decimal:".",thousand:",",precision:2})+'<small class="muted">â‚¬</small>'}catch(e){return"-"}else{if(d==="time"){var f=parseInt(a),g=Math.floor(f/3600),h=Math.floor((f-g*3600)/60),i=f-g*3600-h*60;g<10&&(g="0"+g),h<10&&(h="0"+h),i<10&&(i="0"+i);var j=g+":"+h+":"+i;return j}if(d==="integer")try{return accounting.formatNumber(a,0,",",".")}catch(e){return"-"}}try{return accounting.formatNumber(a,2,",",".")}catch(e){return"-"}},string:function(a,b,c){var d=b.get("format");if(d==="markdown"){if(typeof Showdown!="undefined"){var e=new Showdown.converter;return out=e.makeHtml(a),out}return a}if(d=="plain")return a;if(d==="time"){var f=parseInt(a),g=Math.floor(f/3600),h=Math.floor((f-g*3600)/60),i=f-g*3600-h*60;g<10&&(g="0"+g),h<10&&(h="0"+h),i<10&&(i="0"+i);var j=g+":"+h+":"+i;return j}return a&&typeof a=="string"&&(a=a.replace(/(https?:\/\/[^ ]+)/g,'<a href="$1">$1</a>')),a}},a.Formatters.getFieldLabel=function(a,b){var c=a.attributes.label;a.attributes.is_partitioned&&(c=a.attributes.partitionValue);if(b){var d=_.find(b,function(a){return a.id==c});typeof d!="undefined"&&d!=null&&(c=d.label)}return c}}(this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.SeriesUtility=this.recline.Data.SeriesUtility||{},function(a,b){b.createSeries=function(a,b,c,d,e,f,g){var h=[],i=a.fillEmptyValuesWith,j=a.requiredXValues,k="#C0C0C0";b&&(k=b);var l=!1;c.queryState.isSelected()&&(l=!0);var m="filtered";d&&(m=d);var n=c.getRecords(m),o=c.fields.get(e);if(!o)throw"data.series.utility.CreateSeries: unable to find field ["+e+"] in model ["+c.id+"]";var p=[];j&&(p=j);var q;if(a.sizeField){q=c.fields.get(a.sizeField);if(!q)throw"data.series.utility.CreateSeries: unable to find field ["+a.sizeField+"] on model"}if(a.type=="byFieldValue"){var r={},s=c.fields.get(a.seriesField),t=c.fields.get(a.valuesField);if(!t)throw"data.series.utility.CreateSeries: unable to find field ["+a.valuesField+"] in model ["+c.id+"]";if(!s)throw"data.series.utility.CreateSeries: unable to find field ["+a.seriesField+"] in model ["+c.id+"]";_.each(n,function(a,b){var c=a.getFieldValueUnrendered(s),d=a.getFieldValue(s),e;if(r[c]!=null)e=r[c];else{e={key:c,label:d,values:[],field:t};var f=a.getFieldColor(s);f!=null&&(e.color=f)}var g=a.getFieldShapeName(s),h=a.getFieldValueUnrendered(o),j=a.getFieldValue(o),k=a.getFieldValueUnrendered(t),l=a.getFieldValue(t);if(k==null||typeof k=="undefined"&&i!=null)k=i,l=k;if(k!=null&&typeof k!="undefined"&&!isNaN(k)){var m={x:h,y:k,record:a,y_formatted:l,x_formatted:j,legendField:s.attributes.label||s.attributes.id,legendValue:d};q&&(m.size=a.getFieldValueUnrendered(q)),g!=null&&(m.shape=g),e.values.push(m),i!=null&&p.push(h),r[c]=e}});for(var u in r)h.push(r[u])}else{if(a.type!="byFieldName"&&a.type!="byPartitionedField")throw"data.series.utility.CreateSeries: unsupported or not defined type "+a.type;var v;a.type=="byFieldName"?v=a.valuesField:(v=[],_.each(a.aggregationFunctions,function(b){_.each(c.getPartitionedFieldsForAggregationFunction(b,a.aggregatedField),function(a){v.push(a.get("id"))})})),_.each(v,function(a){var b;b=c.fields.get(a);if(!b)throw"data.series.utility.CreateSeries: unable to find field ["+a+"] on model";var d;a.fieldColor&&(d=a.fieldColor);var e=[];_.each(n,function(a,c){var d=a.getFieldValueUnrendered(o),f=a.getFieldValue(o);try{var g=a.getFieldValueUnrendered(b),h=a.getFieldValue(b);if(g==null||typeof g=="undefined"&&i!=null)g=i;if(g!=null&&!isNaN(g)){var j,m=a.getFieldColor(b);l?a.isRecordSelected()?j=m:j=k:j=m;var n=a.getFieldShapeName(b),r={x:d,y:g,record:a,y_formatted:h,x_formatted:f};j!=null&&(r.color=j),n!=null&&(r.shape=n),q&&(r.size=a.getFieldValueUnrendered(q)),e.push(r),i!=null&&p.push(d)}}catch(s){}});if(e.length>0){var f;d?f=d:f=b.getColorForPartition();var g={values:e,key:recline.Data.Formatters.getFieldLabel(b,c.attributes.fieldLabels)};f&&(g.color=f),h.push(g)}})}i!=null&&(p=_.unique(p),_.each(h,function(a){var b=_.unique(_.map(a.values,function(a){return a.x}));_.each(_.difference(p,b),function(b){a.values.push({x:b,y:i})})}));if(g){var w=g.mainSeriesCount,x=g.labelForSmallSeries||"Other",y=[];_.each(h,function(a){y.push({id:y.length,key:a.key,total:_.reduce(a.values,function(a,b){return a+b.y},0)})}),y=_.sortBy(y,function(a){return-a.total});var z=[],u=0;for(u=0;u<w&&u<y.length;u++)z.push(h[y[u].id]);if(u<h.length){var A={key:x,values:[]};_.each(h[y[u].id].values,function(a){A.values.push({x:a.x,y:a.y})});var B=h[0].values.length;for(var C=u+1;C<h.length;C++)for(var D=0;D<B;D++)A.values[D].y+=h[y[C].id].values[D].y;z.push(A)}h=z}if(f&&h.length){var E=h[0].values.length,F=[];for(var D=0;D<E;D++)F.push(_.reduce(h,function(a,b){return a+b.values[D].y},0));for(var D=0;D<E;D++)_.each(h,function(a){F[D]&&(a.values[D].y_orig=a.values[D].y,a.values[D].y=Math.round(a.values[D].y_orig/F[D]*1e4)/100)})}return h},b.createSerieAnnotations=function(a,b,c,d){var e=[];if(a&&b&&c){var f=a.fields.get(b);if(typeof f=="undefined"||f==null)throw"data.series.utility.CreateSerieAnnotations: field "+b+" not found in model";var g=a.fields.get(c);if(typeof g=="undefined"||g==null)throw"data.series.utility.CreateSerieAnnotations: field "+c+" not found in model";_.each(a.getRecords(),function(a){var b=[],c=a.getFieldValueUnrendered(f).valueOf();_.each(d,function(a,d){var e=_.find(a.data,function(a){return a.x==c});if(e)b.push(e.y);else for(var f=1;f<a.data.length;f++)if(a.data[f-1].x<c&&a.data[f].x>c){var g=d3.scale.linear().domain([a.data[f-1].x,a.data[f].x]).range([a.data[f-1].y,a.data[f].y]);b.push({y:g(c),serie:d});break}});var h=_.max(b,function(a){return a.y});if(h){var i=_.find(e,function(a){return a.x==c});if(i)i.text+="<br>"+a.getFieldValue(g);else{var j=e.length,k=String.fromCharCode(j%27+65);j>26&&(k+=Math.floor(j/27)),e.push({x:c,text:a.getFieldValue(g),letter:k,y:h.y||0,serie:h.serie||0})}}}),_.each(d,function(a,b){a.annotations=_.filter(e,function(a){return a.serie==b})})}}}(jQuery,this.recline.Data.SeriesUtility),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.ShapeSchema=this.recline.Data.ShapeSchema||{},function(a,b){b.ShapeSchema=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var a=this;if(this.attributes.data){var b=this.attributes.data;a._generateLimits(b)}else this.attributes.dataset&&this.bindToDataset()},bindToDataset:function(){var a=this;a.attributes.dataset.dataset.records.bind("reset",function(){a._generateFromDataset()}),a.attributes.dataset.dataset.fields.bind("reset",function(){a.attributes.dataset.dataset.setShapeSchema(a.attributes.dataset.type)}),a.attributes.dataset.dataset.records.models.length>0&&a._generateFromDataset()},setDataset:function(a,b,c){var d=this;d.attributes.dataset={dataset:a,field:b,type:c},a.attributes.shapeSchema||(a.attributes.shapeSchema=[]),a.attributes.shapeSchema.push({schema:d,field:b}),a.setShapeSchema(c),d.bindToDataset()},_generateFromDataset:function(){var a=this,b=this.getRecordsArray(a.attributes.dataset);a._generateLimits(b)},_generateLimits:function(a){var b=this;b.schema={},_.each(b.attributes.limits,function(a,c){b.schema[a]=b.attributes.shapes[c]})},getShapeNameFor:function(a){var b=this;if(this.schema==null)throw"data.shape.js: shape schema not yet initialized, datasource not fetched?";return b._shapeName(a)},getShapeFor:function(a,b,c,d){var e=this;if(this.schema==null)throw"data.shape.js: shape schema not yet initialized, datasource not fetched?";if(!e.attributes.shapeType||e.attributes.shapeType=="svg"){var f=recline.Template.Shapes[this._shapeName(a)];if(f==null)throw"data.shape.js: shape ["+this._shapeName(a)+"] not defined in template.shapes";return f(b,d,c)}if(e.attributes.shapeType=="text")return this._shapeName(this._shapeName(a));if(e.attributes.shapeType=="image")return'<img src="'+this._shapeName(a)+'" class="shape_image">';throw"data.shape.js: unsupported shapeType ["+e.attributes.shapeType+"]"},_shapeName:function(a){var b=this;if(b.attributes.limitType&&this.attributes.limitType=="fixedLimits"){var c=b.attributes.shapes[0];for(var d=1;d<this.attributes.limits.length;d++)if(a>=this.attributes.limits[d-1]&&a<this.attributes.limits[d]){c=b.attributes.shapes[d];break}return c}return b.schema[a]},getRecordsArray:function(a){var b=this,c=[];if(a.dataset.isFieldPartitioned&&a.dataset.isFieldPartitioned(a.field,a.type)){var d=a.dataset.getPartitionedFields(a.field);_.each(a.dataset.getRecords(a.type),function(a){_.each(d,function(b){c.push(a.attributes[b.id])})})}else{var d=[a.field];_.each(a.dataset.getRecords(a.type),function(a){_.each(d,function(b){c.push(a.attributes[b])})})}return c},limits:{distinct:function(a){var b={};return _.each(_.uniq(a),function(a,c){b[a]=recline.Data.Transform.getFieldHash(a)}),a}}}),b.ShapeSchema.addShapesToTerms=function(a,b,c){_.each(b,function(b){c&&_.each(c,function(c){c.field===a&&(b.shape=c.schema.getShapeFor(b.term,b.color,!1,!1))})})}}(jQuery,this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(a,b){b.StateManagement={},b.StateManagement.State=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var a=this;_.each(a.attributes.models,function(b){b.ds.queryState.bind("change",function(){a.setState(a.attributes.stateName,b.ds.queryState,b.field,a)}),b.ds.queryState.bind("selection:change",function(){a.setState(a.attributes.stateName,b.ds.queryState,b.field,a)})}),this.attributes.defaultValue&&(this.defaultValue=this.attributes.defaultValue);var c=b.StateManagement.getState(a.attributes.stateName);c&&_.each(a.attributes.models,function(b){_.each(c.filters,function(c){b.ds.queryState.setFilter(a.mappingField(c,a.attributes.mappingField,b.field))}),_.each(c.selections,function(c){b.ds.queryState.setSelection(a.mappingField(c,a.attributes.mappingField,b.field))})})},mappingField:function(a,b,c){var d=this;if(a.field!=b)return a;var e=_.clone(a);return e.field=c,e},applySelectionToFilters:function(a){var c=this,d=b.StateManagement.getState(c.attributes.stateName);d&&_.each(a,function(a){_.each(d.selections,function(b){a.ds.queryState.setFilter(c.mappingField(b,c.attributes.mappingField,a.field))})})},setState:function(b,c,d,e){var f=_.filter(c.attributes.filters,function(a){return a.field==d}),g=_.filter(c.attributes.selections,function(a){return a.field==d});f=_.map(f,function(a){return e.mappingField(a,d,e.attributes.mappingField)}),g=_.map(g,function(a){return e.mappingField(a,d,e.attributes.mappingField)}),a.cookie("recline.extensions.statemanagement."+b,JSON.stringify({filters:f,selections:g}),{path:"/"})}}),b.StateManagement.getState=function(b){var c=a.cookie("recline.extensions.statemanagement."+b);return c?JSON.parse(c):this.State.arguments&&this.State.arguments.length&&this.State.arguments[0].defaultValue?this.State.arguments[0].defaultValue:null}}(jQuery,this.recline.Data),this.recline=this.recline||{},this.recline.Template=this.recline.Template||{},this.recline.Template.Shapes=this.recline.Template.Shapes||{},function(a,b){b.Shapes={circle:function(a,c,d){var e='<circle cx="100" cy="50" r="40" stroke="black" stroke-width="2" fill="{{color}}"/>',f={color:a};return b._internalDataConversion(c,d,e,f)},empty:function(a,c,d){b._internalDataConversion(c,d,"")}},b._internalDataConversion=function(a,b,c,d){b&&(c="<svg>"+c+"</svg>");var e=Mustache.render(c,d);return a?jQuery(e):e}}(jQuery,this.recline.Template),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.CSV=this.recline.Backend.CSV||{},function(a,b){b.setFieldsAttributesCSV=function(a,b,c){if(b.attributes.fieldsType){if(!b.attributes.fieldsType.length)throw"Wrong fieldsType parameter. Must be an array, not a single object!";_.each(b.attributes.fieldsType,function(d){var e=_.find(a,function(a){return d.id===a.id});e!=null&&(typeof e.type=="undefined"||e.type==null)&&e.type!=d.type&&(e.type=d.type,b.backend.__type__=="csv"&&c&&e.type!="string"&&_.each(c,function(a){e.type=="date"?a[d.id]=new Date(a[d.id]):e.type=="integer"?a[d.id]=parseInt(a[d.id]):e.type=="number"&&(a[d.id]=parseFloat(a[d.id]))}))})}}}(jQuery,this.recline.Backend.CSV),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.Jsonp=this.recline.Backend.Jsonp||{},function(a,b){function c(b,c,e){var f=a.Deferred(),g=a.ajax({url:b.url,dataType:"jsonp",jsonpCallback:b.id,data:c,cache:!0});return i(g).done(function(a){a.results.length!=1||a.results[0].status.code!=0?(console.log("Error in fetching data: "+a.results[0].status.message+" Statuscode:["+a.results[0].status.code+"] AdditionalInfo:["+a.results[0].status.additionalInfo+"]"),f.reject(a.results[0].status)):f.resolve(d(a.results[0].result,e))}).fail(function(a){f.reject(a)}),f.promise()}function d(a,b){if(a.data==null)return{fields:j(a.description),useMemoryStore:!1};var c=j(a.description),d=[];if(b)var d=recline.Data.Faceting.computeFacets(a.data,b);return{hits:e(a.data,c),fields:c,facets:d,useMemoryStore:!1,total:a.data.length}}function e(a,b){return _.each(b,function(b){b!="string"&&_.each(a,function(a){a[b.id]=recline.Data.FormattersMoviri[b.type](a[b.id])})}),a}function f(a){var b=new Date,c=g(a.getFullYear())+"-"+g(1+a.getMonth())+"-"+g(a.getDate())+" "+g(a.getHours())+":"+g(a.getMinutes())+":"+g(a.getSeconds());return c}function g(a){return a<10?"0"+a:""+a}function h(a){var b=a.filters,c=[],d="|",e={term:function k(a){var b=g[a.fieldType],c=a.field,k=b(a.term);return c+" eq "+k},termAdvanced:function(b){var c=g[b.fieldType],d=b.field,e=c(b.term),f=b.operator;return d+" "+f+" "+e},range:function(b){var c=g[b.fieldType],e=b.field,f=c(b.start),h=c(b.stop);return e+" bw "+f+d+h},list:function l(a){var b=g[a.fieldType],c=a.field,l=a.list,e=c+" in ";for(var f in l)f>0&&(e+=d),e+=l[f];return e}},g={number:function(a){return parseFloat(a,10)},string:function(a){return a.toString()},date:function(a){var b=new Date(a);return f(b)},integer:function(a){return parseInt(a)}};for(var h=0;h<b.length;h++)c.push(e[b[h].type](b[h]));var i="";_.each(a.sort,function(a){i.length>0&&(i+=";");var b=a.field;i+=b,a.order&&(i+=":"+a.order)});var j={};return c.length>0&&(j.filtersep="!==!",j.filters=c.join("!==!")),i.length>0&&(j.orderby=i),j}function j(a){var b={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},c=[];for(var d in a)c.push({id:d,type:b[a[d]]});return c}b.__type__="Jsonp",b.timeout=6e4,b.fetch=function(a){console.log("Fetching data structure "+a.url);var b={onlydesc:"true"};return c(a,b)},b.query=function(a,b){var d=h(a);return console.log("Querying jsonp backend ["+(b.id?b.id:b.url)+"] for "),console.log(d),c(b,d,a)};var i=function(c){var d=a.Deferred(),e=setTimeout(function(){d.reject({message:"Request Error: Backend did not respond after "+b.timeout/1e3+" seconds"})},b.timeout);return c.done(function(a){clearTimeout(e),d.resolve(a)}).fail(function(a){clearTimeout(e),d.reject(a)
}),d.promise()}}(jQuery,this.recline.Backend.Jsonp),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.JsonpMemoryStore=this.recline.Backend.JsonpMemoryStore||{},function(a,b){function c(b,c,e,f){var g=a.Deferred(),h=a.ajax({url:b.url,dataType:"jsonp",jsonpCallback:b.id,data:e,cache:!0});return i(h).done(function(a){a.results.length!=1||a.results[0].status.code!=0?(console.log("Error in fetching data: "+a.results[0].status.message+" Statuscode:["+a.results[0].status.code+"] AdditionalInfo:["+a.results[0].status.additionalInfo+"]"),g.reject(a.results[0].status)):g.resolve(d(a.results[0].result,f,c))}).fail(function(a){g.reject(a)}),g.promise()}function d(a,b,c){if(a.data==null)return{fields:j(a.description),useMemoryStore:!0};var d=j(a.description),f=[];if(b)var f=recline.Data.Faceting.computeFacets(a.data,b);return c=="fetch"?{records:e(a.data,d),fields:d,facets:f,useMemoryStore:!0,total:a.data.length}:{hits:e(a.data,d),fields:d,facets:f,useMemoryStore:!0,total:a.data.length}}function e(a,b){return _.each(b,function(b){b!="string"&&_.each(a,function(a){a[b.id]=recline.Data.FormattersMoviri[b.type](a[b.id])})}),a}function f(a){var b=new Date,c=g(a.getFullYear())+"-"+g(1+a.getMonth())+"-"+g(a.getDate())+" "+g(a.getHours())+":"+g(a.getMinutes())+":"+g(a.getSeconds());return c}function g(a){return a<10?"0"+a:""+a}function h(a){var b=[],c="|",d={term:function j(a){var b=e[a.fieldType],c=a.field,j=b(a.term);return c+" eq "+j},termAdvanced:function(b){var c=e[b.fieldType],d=b.field,f=c(b.term),g=b.operator;return d+" "+g+" "+f},range:function(b){var c=e[b.fieldType],d=b.field,f=c(b.start),g=c(b.stop);return d+" lte "+g+","+d+" gte "+f},list:function k(a){var b=e[a.fieldType],d=a.field,k=a.list,f=d+" bw ";for(var g in a.list)g>0&&(f+=c),f+=k[g];return f}},e={number:function(a){return parseFloat(a,10)},string:function(a){return a.toString()},date:function(a){var b=new Date(a);return f(b)},integer:function(a){return parseInt(a)}};for(var g=0;g<a.length;g++)b.push(d[a[g].type](a[g]));var h="",i={};return b.length>0&&(i.filters=b.toString()),h.length>0&&(i.orderby=h),i}function j(a){var b={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},c=[];for(var d in a)c.push({id:d,type:b[a[d]]});return c}b.__type__="JsonpMemoryStore",b.timeout=6e4,b.fetch=function(a){console.log("Fetching data structure "+a.url);if(a.fetchFilters){var b=h(a.fetchFilters);return c(a,"fetch",b)}return c(a,"fetch",{})},b.query=function(a,b){var d=h(a);return console.log("Querying JsonpMemoryStore backend for "),console.log(d),c(b,"query",d,a)};var i=function(c){var d=a.Deferred(),e=setTimeout(function(){d.reject({message:"Request Error: Backend did not respond after "+b.timeout/1e3+" seconds"})},b.timeout);return c.done(function(a){clearTimeout(e),d.resolve(a)}).fail(function(a){clearTimeout(e),d.reject(a)}),d.promise()}}(jQuery,this.recline.Backend.JsonpMemoryStore),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.Splunk=this.recline.Backend.Splunk||{},function(a,b){function c(b,c,e){var g=a.Deferred(),h=new splunkjs.ProxyHttp(b.proxyUrl),i=new splunkjs.Service(h,{username:b.username,password:b.password,scheme:b.scheme,host:b.host,port:b.port,version:b.version}),j={};e?(e.size&&(j.count=e.size),j.search=f(e)):j.search="search *";var k={exec_mode:"normal",earliest_time:b.earliestTime};return i.search(j.search,k,function(a,b){console.log("Job SID: ",b.sid),b.track({period:200},{done:function(a){console.log("Done!"),console.log("Job statistics:"),console.log("  Event count:  "+a.properties().eventCount),console.log("  Result count: "+a.properties().resultCount),console.log("  Disk usage:   "+a.properties().diskUsage+" bytes"),console.log("  Priority:     "+a.properties().priority),a.results(j,function(a,b,c){g.resolve(d(b,e))})},failed:function(a){g.reject("Job failed")},error:function(a){g.reject(a)}})}),g.promise()}function d(a,b){var c=h(a.fields);if(b)var d=recline.Data.Faceting.computeFacets(a.records,b);return{fields:c,useMemoryStore:!1,facets:d,total:a.rows.length,hits:e(a.rows,c)}}function e(a,b){var c=[];return _.each(a,function(a){var d={};_.each(b,function(b){d[b.id]=recline.Data.FormattersMoviri[b.type](a[b.index])}),c.push(d)}),c}function f(a){var b=a.filters,c=[],d={term:function h(a){var b=e[a.fieldType],c=a.field,h=b(a.term);return c+"="+h},range:function(b){var c=e[b.fieldType],d=b.field,f=c(b.start),g=c(b.stop);return d+" bw "+f+multivsep+g},list:function i(a){var b=e[a.fieldType],c=a.field,i=a.list,d=c+" in ";for(var f in i)f>0&&(d+=multivsep),d+=i[f];return d}},e={number:function(a){return parseFloat(a,10)},string:function(a){return a.toString()},date:function(a){var b=new Date(a);return getDate(b)},integer:function(a){return parseInt(a)}};for(var f=0;f<b.length;f++)c.push(d[b[f].type](b[f]));var g="search ";return c.length>0?g+=c.toString():g+="*",g}function h(a,b){var c={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},d=[];return _.each(a,function(a,b){d.push({id:a,type:c.STRING,index:b})}),d}b.__type__="Splunk",b.timeout=6e4,b.fetch=function(a){throw"recline-splunk: fetch not implemented"},b.query=function(a,b){var d=f(a);return console.log("Querying splunk backend ["+(b.id?b.id:b.url)+"] for "),console.log(d),c(b,d,a)};var g=function(c){var d=a.Deferred(),e=setTimeout(function(){d.reject({message:"Request Error: Backend did not respond after "+b.timeout/1e3+" seconds"})},b.timeout);return c.done(function(a){clearTimeout(e),d.resolve(a)}).fail(function(a){clearTimeout(e),d.reject(a)}),d.promise()}}(jQuery,this.recline.Backend.Splunk),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.ParallelUnionBackend=this.recline.Backend.ParallelUnionBackend||{},function(a,b){b.__type__="ParallelUnionBackend",b.deferreds=function(a){var c=[];return _.each(a.backendConfiguration.backends,function(a){a.instance=b._backendFromString(a.backend);var d=a.instance.fetch(a.props);d.done(function(a){_.extend(data,a)}),c.push(d)}),c},b.fetch=function(c){var d=new a.Deferred,e={fields:[],records:[],useMemoryStore:!1},f=[];return _.each(c.backendConfiguration.backends,function(a){a.instance=b._backendFromString(a.backend);var c=a.instance.fetch(a.props);c.done(function(a){e.useMemoryStore&&(e.useMemoryStore=!0),_.each(a.fields,function(a){_.find(e.fields,function(b){return a.id==b.id})||e.fields.push(a)})}),f.push(c)}),a.when.apply(window,f).done(function(){d.resolve(e).fail(b.errorOnFetching)}),d.promise()},b.query=function(c,d){var e=new a.Deferred,f={fields:[],hits:[],useMemoryStore:!1,facets:[]},g=[];if(d.backendConfiguration.backendChoser){var h=d.backendConfiguration.backendChoser(c);_.each(h,function(d){var e=_.clone(c);e.filters=d.filters,d.instance=b._backendFromString(d.backend.backend);var h=d.instance.query(e,d.backend.props);h.done(function(b){f.useMemoryStore&&(f.useMemoryStore=!0),_.each(b.fields,function(a){_.find(f.fields,function(b){return a.id==b.id})||f.fields.push(a)}),f.hits=a.merge(f.hits,b.hits),f.facets=a.merge(f.facets,b.facets),f.total=f.total+f.hits.length}),g.push(h)})}else _.each(d.backendConfiguration.backends,function(d){d.instance=b._backendFromString(d.backend);var e=d.instance.query(c,d.props);e.done(function(b){f.useMemoryStore&&(f.useMemoryStore=!0),_.each(b.fields,function(a){_.find(f.fields,function(b){return a.id==b.id})||f.fields.push(a)}),f.hits=a.merge(f.hits,b.hits),f.facets=a.merge(f.facets,b.facets),f.total=f.total+f.hits.length}),g.push(e)});return a.when.apply(window,g).done(function(){e.resolve(b.prepareResults(f,d.backendConfiguration.result)).fail(b.errorOnFetching)}),e.promise()},b.prepareResults=function(a,b){if(b.type=="union")return a;if(b.type=="sum"){var c=b.groupBy,d;c.constructor==Array?d=_.groupBy(a.hits,function(a){var b="";return _.each(c,function(c){b=b+"#"+a[c]}),b}):d=_.groupBy(a.hits,c);var e=[];return _.each(d,function(a,d){var f={};_.each(c,function(b){f[b]=a[0][b]}),_.each(a,function(a){_.each(b.fields,function(b,c){f[b]?f[b]=f[b]+a[b]:f[b]=a[b]})}),e.push(f)}),a.hits=e,a.total=a.hits.length,a}},b.errorOnFetching=function(){return{message:"Request Error: error on fetching union parallel backends"}},b._backendFromString=function(a){var b=null;return recline&&recline.Backend&&_.each(_.keys(recline.Backend),function(c){c.toLowerCase()===a.toLowerCase()&&(b=recline.Backend[c])}),b}}(jQuery,this.recline.Backend.ParallelUnionBackend),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function($,my){my.GoogleMaps=Backbone.View.extend({iconaMarker:"http://chart.googleapis.com/chart?chst=d_simple_text_icon_above&chld={TEXT}|14|{TEXTCOLOR}|{MARKERICON}|{ICONSIZE}|{ICONCOLOR}|404040",initialize:function(a){_.bindAll(this,"render","redraw","clearAllMarkers","getMarkerColor","openInfoWindow"),this.model.bind("query:done",this.redraw),this.mapEl=document.getElementById(this.options.el),this.render()},clearAllMarkers:function(){_.each(this.markers,function(a){a.setMap(null)}),this.markers=[]},getMarkerColor:function(val,htmlType){var self=this,min,max;if(self.options.state.redThreshold.indexOf("min")>=0||self.options.state.redThreshold.indexOf("max")>=0||self.options.state.greenThreshold.indexOf("min")>=0||self.options.state.greenThreshold.indexOf("max")>=0){var fieldValues=_.map(this.model.getRecords(),function(a){return a.attributes[self.options.state.valueField]});min=_.min(fieldValues),max=_.max(fieldValues)}return val<=eval(self.options.state.redThreshold)?htmlType?"#FF0000":"red":val<=eval(self.options.state.greenThreshold)?htmlType?"#FFFF00":"yellow":htmlType?"#00FF00":"green"},render:function(){var a=this,b={};this.options.state.googleOptions&&(b=_.extend(b,this.options.state.googleOptions)),this.options.state.mapCenter&&(b.center=new google.maps.LatLng(this.options.state.mapCenter[0],this.options.state.mapCenter[1])),this.options.state.mapType&&(b.mapTypeId=google.maps.MapTypeId[this.options.state.mapType]),this.map=new google.maps.Map(this.mapEl,b),this.options.state.clustererOptions&&(mc=new MarkerClusterer(this.map,[],this.options.state.clustererOptions)),this.options.events&&this.options.events.mapClick&&google.maps.event.addListener(this.map,"click",this.options.events.mapClick),this.options.events&&this.options.events.mapDblClick&&google.maps.event.addListener(this.map,"dblclick",this.options.events.mapDblClick),this.options.events&&this.options.events.mapRightClick&&google.maps.event.addListener(this.map,"rightclick",this.options.events.mapRightClick),this.options.state.infoWindowTemplate&&(this.infowindow=new google.maps.InfoWindow({content:""}),this.infowindow.close()),this.redraw()},redraw:function(){var a=this;this.clearAllMarkers(),mc&&mc.clearMarkers();var b=a.options.state.latField,c=a.options.state.longField,d=a.options.state.valueField,e=a.options.state.markerIcon,f=_.each(this.model.getRecords("unfiltered"),function(e){var f=new google.maps.LatLng(e.attributes[b],e.attributes[c]),g=a.getMarkerColor(e.attributes[d],!0).replace("#",""),h=a.iconaMarker.replace("{TEXT}",a.options.state.showValue?e.attributes[d].toString():"");h=h.replace("{ICONCOLOR}",g),h=h.replace("{TEXTCOLOR}",g),h=h.replace("{MARKERICON}",a.options.state.markerIcon),h=h.replace("{ICONSIZE}",a.options.state.markerSize);var i=new google.maps.Marker({position:f,map:a.map,animation:null,icon:h,value:e.attributes[d],color:a.getMarkerColor(e.attributes[d]),record:e});a.options.state.infoWindowTemplate&&google.maps.event.addListener(i,"click",function(){a.openInfoWindow(i)});if(a.options.actions){var j=a.getActionsForEvent("selection"),k=a.options.state.mapping;google.maps.event.addListener(i,"click",function(){var a=this.record;j.forEach(function(b){b.action.doAction([a],b.mapping)})});var l=a.getActionsForEvent("hover"),k=a.options.state.mapping;google.maps.event.addListener(i,"mouseover",function(){var a=this.record;l.forEach(function(b){b.action.doAction([a],b.mapping)})})}a.options.events&&a.options.events.markerClick&&google.maps.event.addListener(i,"click",a.options.events.markerClick),a.options.events&&a.options.events.markerDblClick&&google.maps.event.addListener(i,"dblclick",a.options.events.markerDblClick),a.options.events&&a.options.events.markerRightClick&&google.maps.event.addListener(i,"rightclick",a.options.events.markerRightClick),a.markers.push(i)});mc&&(mc.addMarkers(this.markers),mc.repaint())},getActionsForEvent:function(a){var b=this,c=[];return _.each(b.options.actions,function(b){_.contains(b.event,a)&&c.push(b)}),c},openInfoWindow:function(a){var b={value:a.value,color:a.color};b=_.extend(b,a.record.attributes);var c=Mustache.render(this.options.state.infoWindowTemplate,b);this.infowindow.setContent(c),this.infowindow.setPosition(a.position),this.infowindow.open(this.map)},closeInfoWindow:function(){this.infowindow.setContent(""),this.infowindow.close()}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.Composed=Backbone.View.extend({templates:{vertical:'<div id="{{uid}}"><div class="composedview_table"><div class="c_group c_header"><div class="c_row"><div class="cell cell_empty"></div>{{#dimensions}}<div class="cell cell_name"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{/dimensions}}</div></div><div class="c_group c_body"><div class="c_row"><div class="cell cell_empty"/>{{{noData}}}</div>{{#measures}}<div class="c_row"><div class="cell cell_title"><div style="white-space:nowrap;"><div class="rawhtml" style="vertical-align:middle;float:left">{{{rawhtml}}}</div><div style="vertical-align:middle;float:left"><div class="title">{{{title}}}</div><div class="subtitle">{{{subtitle}}}</div></div><div class="shape" style="vertical-align:middle;float:left">{{shape}}</div></div></div>{{#dimensions}}<div class="cell cell_graph" id="{{#getDimensionIDbyMeasureID}}{{measure_id}}{{/getDimensionIDbyMeasureID}}" term="{{measure_id}}"></div>{{/dimensions}}</div>{{/measures}}</div><div class="c_group c_footer"></div></div></div>',horizontal:'<div id="{{uid}}"><table><tr><td><div class="composedview_table"><div class="c_group c_header"><div class="c_row"><div class="cell cell_empty"></div>{{#measures}}<div class="cell cell_title"><div style="white-space:nowrap;"><div class="rawhtml" style="vertical-align:middle;float:left">{{{rawhtml}}}</div><div style="float:left;vertical-align:middle"><div class="title"><a class="link_tooltip" href="#" data-toggle="tooltip" title="{{{subtitle}}}">{{{title}}}</a></div></div><div class="shape" style="float:left;vertical-align:middle">{{shape}}</div></div></div>{{/measures}}</div></div><div class="c_group c_body">{{#dimensions}}<div class="c_row"><div class="cell cell_name"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{#measures}}<div class="cell cell_graph" id="{{viewid}}"></div>{{/measures}}</div>{{/dimensions}}<div class="c_row c_totals">{{#dimensions_totals}}<div class="cell cell_name"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{#measures_totals}}<div class="cell cell_graph" id="{{viewid}}"></div>{{/measures_totals}}{{/dimensions_totals}}</div></div></div></td></tr><tr><td>{{{noData}}}</td></tr></table></div>'},redrawSemaphore:function(a,b){b.semaphore||(b.semaphore=""),b.options.modelTotals?a=="model"?b.semaphore=="totals"?(b.semaphore="",b.redraw()):b.semaphore="model":b.semaphore=="model"?(b.semaphore="",b.redraw()):b.semaphore="totals":b.redraw()},initialize:function(b){var c=this;this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",function(){c.redrawSemaphore("model",c)}),this.options.modelTotals&&(this.options.modelTotals.bind("change",this.render),this.options.modelTotals.fields.bind("reset",this.render),this.options.modelTotals.fields.bind("add",this.render),this.options.modelTotals.bind("query:done",function(){c.redrawSemaphore("totals",c)})),this.uid=b.id||"composed_"+(new Date).getTime()+Math.floor(Math.random()*1e4),_.each(this.options.measures,function(a,b){c.options.measures[b].measure_id=(new Date).getTime()+Math.floor(Math.random()*1e4)}),_.each(this.options.measuresTotals,function(a,b){c.options.measuresTotals[b].measure_id=(new Date).getTime()+Math.floor(Math.random()*1e4)}),this.views=[]},render:function(){var a=this,b="#"+this.uid;a.graph&&jQuery(b).empty()},getViewFunction:function(){return function(a){var b=_.find(this.measures,function(b){return b.measure_id==a});return b.viewid}},redraw:function(){var a=this;a.dimensions=[],a.noData="";if(a.options.groupBy){var b=this.model.getFacetByFieldId(a.options.groupBy),c=this.model.fields.get(a.options.groupBy);if(!c)throw"ComposedView: unable to find groupBy field ["+a.options.groupBy+"] in model ["+this.model.id+"]";if(!b)throw"ComposedView: no facet present for groupby field ["+a.options.groupBy+"]. Define a facet on the model before view render";b.attributes.terms.length==0&&!a.options.modelTotals?a.noData=(new recline.View.NoDataMsg).create2():_.each(b.attributes.terms,function(b){if(b.count>0){var d=(new Date).getTime()+Math.floor(Math.random()*1e4),e;if(b.term){var f=_.find(a.model.getRecords(),function(c){return c.attributes[a.options.groupBy]==b.term});f&&(e=f.getFieldValue(c))}var g;a.options.rowTitle?g=a.options.rowTitle(b):g=e||b.term;var h={term:b.term,term_desc:g,id_dimension:d,shape:b.shape};h.getDimensionIDbyMeasureID=function(){return function(a){var b=_.find(this.measures,function(b){return b.measure_id==a});return b.viewid}},a.dimensions.push(a.addFilteredMeasuresToDimension(h,c))}})}else{var d=(new Date).getTime()+Math.floor(Math.random()*1e4),e;a.options.type=="groupByRecord"?e=a.addMeasuresToDimension({id_dimension:d}):e=a.addMeasuresToDimensionAllModel({id_dimension:d},a.options.measures),_.each(e,function(b,c){b.getDimensionIDbyMeasureID=a.getViewFunction,e[c]=b}),a.dimensions=e}this.measures=this.options.measures;if(a.options.modelTotals){var f=[],d=(new Date).getTime()+Math.floor(Math.random()*1e4),e={id_dimension:d,measures:f};a.options.titleTotals&&(e.term_desc=a.options.titleTotals),_.each(a.options.measuresTotals,function(b){var c={view:b.view,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:b.measure_id,props:b.props,dataset:a.options.modelTotals,title:b.title,subtitle:b.subtitle,rawhtml:b.rawhtml};f.push(c)}),a.dimensions_totals=[e],a.measures_totals=f}var g=this.templates.vertical;this.options.template&&(g=this.templates[this.options.template]),this.options.customTemplate&&(g=this.options.customTemplate);var h=Mustache.render(g,a);this.el.html(h),this.attachViews(),a.options.postRender&&a.options.postRender.call(),this.el.trigger("resize")},attachViews:function(){var b=this;b.views=[],_.each(b.dimensions,function(c){_.each(c.measures,function(c){var d=a("#"+c.viewid);c.props.el=d,c.props.model=c.dataset;var e=new recline.View[c.view](c.props);b.views.push(e),typeof e.render!="undefined"&&e.render(),typeof e.redraw!="undefined"&&e.redraw()})}),_.each(b.dimensions_totals,function(c){_.each(c.measures,function(c){var d=a("#"+c.viewid);c.props.el=d,c.props.model=c.dataset;var e=new recline.View[c.view](c.props);b.views.push(e),typeof e.render!="undefined"&&e.render(),typeof e.redraw!="undefined"&&e.redraw()})})},addFilteredMeasuresToDimension:function(a,b){var c=this,d=new recline.Model.FilteredDataset({dataset:c.model}),e={field:b.get("id"),type:"term",term:a.term,term_desc:a.term,fieldType:b.get("type")};d.queryState.addFilter(e),d.query();var f=[];return _.each(c.options.measures,function(a){var b={view:a.view,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:a.measure_id,props:a.props,dataset:d,title:a.title,subtitle:a.subtitle,rawhtml:a.rawhtml};f.push(b)}),a.measures=f,a},addMeasuresToDimension:function(a){var b=this,c=[];return _.each(b.model.records.models,function(d){var e=[];_.each(b.options.measures,function(a){var c=new recline.Model.Dataset({records:[d.toJSON()],fields:d.fields.toJSON(),renderer:b.model.attributes.renderer});c.fields=d.fields;var f={view:a.view,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:a.measure_id,props:a.props,dataset:c,title:a.title,subtitle:a.subtitle,rawhtml:a.rawhtml};e.push(f)});var f={measures:e,id_dimension:a.id_dimension};c.push(f)}),c},addMeasuresToDimensionAllModel:function(a,b,c){var d=this,e=[];return _.each(b,function(a){var b,f;c?(b=a.totals.view,a.totals.props?f=a.totals.props:f={}):(b=a.view,f=a.props);var g={view:b,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:a.measure_id,props:f,dataset:d.model,title:a.title,subtitle:a.subtitle,rawhtml:a.rawhtml};e.push(g)}),a.measures=e,[a]}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.Indicator=Backbone.View.extend({defaults:{format:"d"},compareType:{self:this,percentage:function(a,b,c,d,e){var f=new recline.Model.Field({type:"number",format:"percentage"}),g=a/b*100,h=recline.Data.Formatters.Renderers(g,f),i=c.templatePercentage;return d==1&&(e==1?i=c.templateCondensedShapeAfter:i=c.templateCondensed),{data:h,template:i,unrenderedValue:g,percentageMsg:" % of total: "}},percentageVariation:function(a,b,c,d,e){var f=new recline.Model.Field({type:"number",format:"percentage"}),g=(a-b)/b*100,h=recline.Data.Formatters.Renderers(g,f),i=c.templatePercentage;return d==1&&(e==1?i=c.templateCondensedShapeAfter:i=c.templateCondensed),{data:h,template:i,unrenderedValue:g,percentageMsg:""}},nocompare:function(a,b,c,d,e){var f=c.templateBase;return d==1&&(e==1?f=c.templateCondensedShapeAfter:f=c.templateCondensed),{data:null,template:f,unrenderedValue:null}}},templates:{templateBase:'<div class="indicator">       <div class="panel indicator_{{viewId}}">         <div id="indicator_{{viewId}}"> 			<table class="indicator-table">                 <tr class="titlerow"><td></td><td style="text-align: center;" class="title">{{{label}}}</td></tr>                    <tr class="descriptionrow"><td></td><td style="text-align: center;" class="description"><small>{{description}}</small></td></tr>                    <tr class="shaperow"> 	   				<td><div class="shape">{{{shape}}}</div> 	   				<div class="compareshape">{{{compareShape}}}</div> 	   				</td><td class="value-cell"><div class="kpi_value">{{{value}}}</div></td>	   				<td class="aftershape">{{{afterShape}}}</td> 	   			</tr>              </table>  		</div>      </div>     </div> ',templateCondensed:'<div class="indicator round-border-dark" >     	    <div class="panel indicator_{{viewId}}" >         		<div id="indicator_{{viewId}}" class="indicator-container" >         			<div class="round-border" style="float:left;margin:2px 2px 0px 2px">     					{{#compareShape}}     					<div class="compareshape" style="float:left">{{{compareShape}}}</div>     					{{/compareShape}} 						{{#shape}}     	                <div class="shape" style="float:left">{{{shape}}}</div>     					{{/shape}}         				<div class="value-cell" style="float:left"><div class="kpi_value">{{{value}}}</div></div>     					<div class="aftershape" style="float:left">{{{afterShape}}}</div>     				</div>     				{{#label}}<div class="title">&nbsp;&nbsp;{{{label}}}</div>{{/label}}    			</div>     	    </div>         </div>',templateCondensedShapeAfter:'<div class="indicator round-border-dark" >     	    <div class="panel indicator_{{viewId}}" >     			<div class="title">{{{label}}}</div>        		<div id="indicator_{{viewId}}" class="indicator-container"> 			    	<div class="round-border" style="float:left;margin:2px 2px 0px 2px">     				<div class="value-cell" style="float:left">{{{value}}}</div> 					{{#compareShape}} 					<div class="compareshape" style="float:left">{{{compareShape}}}</div> 					{{/compareShape}} 					{{#shape}} 			        <div class="shape" style="float:left">{{{shape}}}</div> 					{{/shape}}     			</div>     			</div>     	    </div>         </div>',templatePercentage:'<div class="indicator"> 	      <div class="panel indicator_{{viewId}}"> 	        <div id="indicator_{{viewId}}"> 				 <div class="indicator-table"> 	                <div class="titlerow"><span class="title">{{{label}}}</span></div>    	                <div class="descriptionrow"><span class="description"><small>{{description}}</small></span></div>    	                <div class="shaperow"> 						<div class="shape">{{{shape}}}</div> 						<span class="value-cell"> 							<div style="white-space: nowrap;"> 								<div class="kpi_value">{{{value}}}</div> 								<div class="kpi_compare_shape_container"> 									<div class="kpi_compare_shape_shape" >{{{compareShape}}}</div> 									<div class="kpi_compare_shape_msg">{{{percentageMsg}}}{{{compareValue}}}</div>								</div> 							</div> </span> 					</div>  	             </div>  			</div>	      </div> 	    </div> '},initialize:function(b){var c=this;this.el=a(this.el),_.bindAll(this,"render"),this.uid=b.id||""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.model.bind("query:done",this.render)},render:function(){var b=this,c={};c.viewId=this.uid,c.label=this.options.state&&this.options.state.label;var d=b.model.getRecords(b.options.state.kpi.type),e;b.options.state.kpi.aggr?e=b.model.getField_byAggregationFunction(b.options.state.kpi.type,b.options.state.kpi.field,b.options.state.kpi.aggr):e=b.model.getFields(b.options.state.kpi.type).get(b.options.state.kpi.field);if(!e)throw"View.Indicator: unable to find field ["+b.options.state.kpi.field+"] on model";var f=null;if(b.options.state.condensed==1&&b.options.state.kpi.textField){b.options.state.kpi.aggr?f=b.model.getField_byAggregationFunction(b.options.state.kpi.type,b.options.state.kpi.textField,b.options.state.kpi.aggr):f=b.model.getFields(b.options.state.kpi.type).get(b.options.state.kpi.textField);if(!f)throw"View.Indicator: unable to find field ["+b.options.state.kpi.textField+"] on model"}var g;if(d.length>0){g=d[0].getFieldValueUnrendered(e),c.value=d[0].getFieldValue(e),c.shape=d[0].getFieldShape(e,!0,!1);if(b.options.state.condensed==1&&f)if(b.options.maxLabelLength){var h=d[0].getFieldValue(f);if(h&&h.length>b.options.maxLabelLength){var i=h.substring(0,b.options.maxLabelLength);c.label='<abbr title="'+h+'">'+i+"...</abbr>"}else c.label=d[0].getFieldValue(f)}else c.label=d[0].getFieldValue(f)}else c.value="N/A";var j=this.templates.templateBase;b.options.state.condensed==1&&(j=b.templates.templateCondensed);if(b.options.state.compareWith){var k=b.model.getRecords(b.options.state.compareWith.type);if(k.length>0){var l;b.options.state.kpi.aggr?l=b.model.getField_byAggregationFunction(b.options.state.compareWith.type,b.options.state.compareWith.field,b.options.state.compareWith.aggr):l=b.options.model.getFields(b.options.state.compareWith.type).get(b.options.state.compareWith.field);if(!l)throw"View.Indicator: unable to find field ["+b.options.state.compareWith.field+"] on model";c.compareWithValue=k[0].getFieldValue(l);var m=k[0].getFieldValueUnrendered(l),n,n=b.compareType[b.options.state.compareWith.compareType](g,m,b.templates,b.options.state.condensed,b.options.state.shapeAfter);if(!n)throw"View.Indicator: unable to find compareType ["+b.options.state.compareWith.compareType+"]";c.compareValue=n.data,b.options.state.compareWith.shapes&&(n.unrenderedValue==0?c.compareShape=b.options.state.compareWith.shapes.constant:n.unrenderedValue>0?c.compareShape=b.options.state.compareWith.shapes.increase:n.unrenderedValue<0&&(c.compareShape=b.options.state.compareWith.shapes.decrease)),n.template&&(j=n.template)}}else b.options.state.fillCompareSpace&&(j=this.templates.templatePercentage);(c["shape"]==null||typeof c["shape"]=="undefined")&&(c["compareShape"]==null||typeof c["compareShape"]=="undefined")&&(c.compareShape=" "),this.options.showPercentageBar&&(c.afterShape="<div class='indicator-percent-complete-bar-background' style='float:left;'><span class='indicator-percent-complete-bar' style='width:"+c.value+"'></span></div>"),this.options.state.description&&(c.description=this.options.state.description),n&&n.percentageMsg&&(c.percentageMsg=n.percentageMsg);var o=Mustache.render(j,c);return a(this.el).html(o),this}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.KartoGraph=Backbone.View.extend({template:'<div id="cartograph_{{viewId}}"></div> ',rendered:!1,mapWidth:undefined,mapHeight:undefined,initialize:function(b){var c=this;this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",c.render),this.model.fields.bind("reset",c.render),this.model.fields.bind("add",c.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.mapWidth=b.state.width,this.mapHeight=b.state.height,this.unselectedColor="#C0C0C0",this.options.state.unselectedColor&&(this.unselectedColor=this.options.state.unselectedColor)},render:function(){var b=this,c={};c.viewId=this.uid;var d=Mustache.render(this.template,c);a(this.el).html(d);var e=this.options.state.svgURI,f=this.options.state.layers;return b.map=$K.map("#cartograph_"+this.uid,b.mapWidth,b.mapHeight),b.map.loadMap(e,function(a){_.each(f,function(c){a.addLayer(c,b.getEventsForLayer(c))}),b.rendered=!0,b.updateMap()}),this},redraw:function(){var a=this;a.updateMap()},updateMap:function(){var a=this;if(!a.rendered)return;var b=a.map,c=this.options.state.colors,d=this.options.state.mapping;_.each(d,function(c){var d=b.getLayer(c.destLayer),e=[];_.each(d.paths,function(a){e.push(a.data[c.destAttribute])});var f=a._getDataFor(e,c.srcShapeField,c.srcValueField);d.style("fill",function(b){var d=f[b[c.destAttribute]];return d!=null?d.color:a.unselectedColor})})},_getDataFor:function(a,b,c){var d=this,e="filtered";d.options.useFilteredData!==null&&d.options.useFilteredData===!1&&(e="original");var f=d.model.getRecords(e),g=d.model.fields.get(b),h=d.model.fields.get(c),i=!1;d.model.queryState.isSelected()&&(i=!0);var j={};return _.each(f,function(b){if(_.contains(a,b.getFieldValueUnrendered(g))){var c=d.unselectedColor;i?b.isRecordSelected()&&(c=b.getFieldColor(h)):c=b.getFieldColor(h),j[b.getFieldValueUnrendered(g)]={record:b,field:h,color:c,value:b.getFieldValueUnrendered(h)}}}),j},getEventsForLayer:function(a){var b=this,c={},d=_.filter(this.options.state.mapping,function(b){return b.destLayer==a});if(d.length==0)return{};if(d.length>1)throw"view.Kartograph.js: more than one field associated with layer, impossible to link with actions";var e=b.getActionsForEvent("selection"),f=_.filter(e,function(a){return a.mapping.srcField==d.srcShapeField});return f.length>0&&(c.click=function(a,b,c){console.log(a),_.each(f,function(b){var c=[];_.each(b.mapping,function(b){c.push({filter:b.filter,value:[a[d[0].destAttribute]]})}),b.action._internalDoAction(c,"add")})}),c},getMapping:function(a){var b=this,c=this.options.state.mapping;return _.filter(c,function(b){return b.srcShapeField==a})},doActions:function(a,b){_.each(a,function(a){a.action._internalDoAction([b])}),params.push({filter:mapp.filter,value:values})},getActionsForEvent:function(a){var b=this,c=[];return _.each(b.options.actions,function(b){_.contains(b.event,a)&&c.push(b)}),c}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.Loader=Backbone.View.extend({divOver:null,loaderCount:0,initialize:function(b){_.bindAll(this,"render","incLoaderCount","decLoaderCount","bindDatasets","bindDataset","bindCharts","bindChart"),this.divOver=a("<div/>"),this.divOver.attr("style",b.style),this.datasets=b.datasets,this.charts=b.charts,this.baseurl="/",b.baseurl&&(this.baseurl=b.baseurl),b.container!=null?b.container.append(this.divOver):a(document.body).append(this.divOver)},render:function(){a(document.body).append(this.htmlLoader.replace("{{baseurl}}",this.baseurl)),this.divOver.show(),this.bindDatasets(this.datasets),this.bindCharts(this.charts)},htmlLoader:'<div id="loadingImage" style="display:block">     			<div style="position:absolute;top:45%;left:45%;width:150px;height:80px;z-index:100">     				<p class="centered">     					<img src="{{baseurl}}images/ajax-loader-blue.gif" >     				</p>     			</div>     		</div>',incLoaderCount:function(){this.loaderCount++,this.divOver.show(),document.getElementById("loadingImage").style.display="block"},decLoaderCount:function(){var a=this;this.loaderCount--,this.loaderCount<=0&&
(document.getElementById("loadingImage").style.display="none",a.divOver.hide(),this.loaderCount=0)},bindDatasets:function(a){var b=this;_.each(a,function(a){a.bind("query:start",b.incLoaderCount),a.bind("query:done query:fail",b.decLoaderCount)})},bindDataset:function(a){a.bind("query:start",this.incLoaderCount),a.bind("query:done query:fail",this.decLoaderCount)},bindCharts:function(a){var b=this;_.each(a,function(a){a.bind("chart:startDrawing",b.incLoaderCount),a.bind("chart:endDrawing",b.decLoaderCount)})},bindChart:function(a){a.bind("chart:startDrawing",this.incLoaderCount),a.bind("chart:endDrawing",this.decLoaderCount)}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.NoDataMsg=Backbone.View.extend({templateP1:"<div class='noData' style='display:table;width:100%;height:100%;'><p style='display:table-cell;width:100%;height:100%;margin-left: auto;margin-right: auto;text-align: center;margin-bottom: auto;margin-top: auto;vertical-align: middle;'>",template2P1:"<div class='noData' style='width:100%;height:100%;'><p style='width:100%;height:100%;margin-left: auto;margin-right: auto;text-align: center;margin-bottom: 10px;margin-top:10px;'>",_internalMsg:"No Data Available!",templateP2:"</p></div>",initialize:function(){},create:function(a){return a?this.templateP1+a+this.templateP2:this.templateP1+this._internalMsg+this.templateP2},create2:function(a){return a?this.template2P1+a+this.templateP2:this.template2P1+this._internalMsg+this.templateP2}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.NVD3Graph=Backbone.View.extend({template:'<div class="recline-graph">       <div class="panel nvd3graph_{{viewId}}"style="display: block;">         <div id="nvd3chart_{{viewId}}"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" class="bstrap" width="{{width}}" height="{{height}}">         	  <defs> 		    	<marker id = "Circle" viewBox = "0 0 40 40" refX = "12" refY = "12" markerWidth = "6" markerHeight = "6" stroke = "white" stroke-width = "4" fill = "dodgerblue" orient = "auto"> 		    	<circle cx = "12" cy = "12" r = "12"/> 		    	</marker> 		      </defs>         	</svg></div>      </div>     </div> ',initialize:function(b){var c=this;this.uid=b.id||""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.el=a(this.el),_.bindAll(this,"render","redraw","graphResize","changeDimensions","getFormatter"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.model.bind("dimensions:change",this.changeDimensions),this.options.state&&this.options.state.loader&&this.options.state.loader.bindChart(this)},changeDimensions:function(){var a=this;a.state.attributes.group=a.model.getDimensions()},render:function(){var b=this;b.trigger("chart:startDrawing");var c=_.extend({group:null,seriesNameField:[],seriesValues:[],colors:["#edc240","#afd8f8","#cb4b4b","#4da74d","#9440ed"],graphType:"lineChart",xLabel:"",id:0},this.options.state);this.state=new recline.Model.ObjectState(c);var d=this.model.toTemplateJSON();d.viewId=this.uid,this.state.attributes.width&&(d.width=this.state.attributes.width),this.state.attributes.height&&(d.height=this.state.attributes.height),delete this.chart;var e=Mustache.render(this.template,d);return a(this.el).html(e),this.$graph=this.el.find(".panel.nvd3graph_"+d.viewId),b.trigger("chart:endDrawing"),this},getActionsForEvent:function(a){var b=[];return _.each(this.options.actions,function(c){_.contains(c.event,a)&&b.push(c)}),b},redraw:function(){var a=this;a.trigger("chart:startDrawing");if(a.model.recordCount==0){var b=this.el.find("#nvd3chart_"+a.uid+" svg");b.css("display","block");var c=b.width(),d=b.height();b.css("display","none"),this.el.find("#nvd3chart_"+a.uid).width(c).height(d).append((new recline.View.NoDataMsg).create()),a.trigger("chart:endDrawing");return}var b=this.el.find("#nvd3chart_"+a.uid+" svg");b.css("display","block");var c=b.width(),d=b.height(),e=this.state,f=recline.Data.SeriesUtility.createSeries(this.state.attributes.series,this.state.attributes.unselectedColor,this.model,this.options.resultType,this.state.attributes.group,this.options.state.scaleTo100Perc,this.options.state.groupAllSmallSeries),g=0;f&&_.each(f,function(a){a.values&&(g+=a.values.length)});if(!g)return b.css("display","none"),this.el.find("#nvd3chart_"+a.uid).width(c).height(d).append((new recline.View.NoDataMsg).create()),a.trigger("chart:endDrawing"),null;var h=this.state.get("graphType"),i=this.uid,j=this.model,e=this.state,k=this.state.get("xLabel"),l=this.state.get("yLabel");nv.addGraph(function(){a.chart=a.getGraph[h](a);var b=a.el.find("#nvd3chart_"+a.uid+" svg"),c=a.getGraphModel(a,h);if(typeof c=="undefined")throw"NVD3 Graph type "+h+" not found!";if(a.options.state.options){if(a.options.state.options.noTicksX)a.chart.xAxis.tickFormat(function(a){return""});else{var d=a.model.fields.get(a.options.state.group);d.attributes.type=="date"&&a.chart.xAxis.tickFormat(function(a){return d3.time.format("%d-%b")(new Date(a))})}a.options.state.options.noTicksY&&a.chart.yAxis.tickFormat(function(a){return""});if(a.options.state.options.customTooltips){var e=10,g=0,i=a.model.fields.get(a.state.attributes.group),j=a.model.fields.get(a.state.attributes.series);c.dispatch.on("elementMouseover.tooltip",function(c){var d;c.e&&c.e.pageY&&c.e.pageX?d={top:c.e.pageY,left:c.e.pageX}:d={left:c.pos[0]+ +b.offset().left+50,top:c.pos[1]+b.offset().top};var f;h.indexOf("Horizontal")>=0?f={x:c.point.x,y:j?a.getFormatter(j.get("type"))(c.point.y):c.point.y,y_orig:c.point.y_orig||c.point.y,yLabel:c.series.key,xLabel:i?i.get("label"):""}:f={x:i?a.getFormatter(i.get("type"))(c.point.x):c.point.x,y:c.point.y,y_orig:c.point.y_orig||c.point.y,xLabel:c.series.key,yLabel:j?j.get("label"):""},f.record=c.point.record.attributes;var k=Mustache.render(a.options.state.options.customTooltips,f);nv.tooltip.show([d.left+e,d.top+g],k,d.left<a.el[0].offsetLeft+a.el.width()/2?"w":"e",null,a.el[0])}),c.dispatch.on("elementMouseout.tooltip",function(a){nv.tooltip.cleanup()})}}return a.state.attributes.options&&_.each(_.keys(a.state.attributes.options),function(b){try{a.addOption[b](a.chart,a.state.attributes.options[b])}catch(c){console.log("view.nvd3.graph.js: cannot add options "+b+" for graph type "+h)}}),d3.select("#nvd3chart_"+a.uid+"  svg").datum(f).transition().duration(a.options.state.timing||500).call(a.chart),nv.utils.windowResize(a.graphResize),a.trigger("chart:endDrawing"),a.chart})},graphResize:function(){var b=this,c=this.uid,d=b.el;while(!d.hasClass("container-fluid")&&!d.hasClass("container")&&d.length)d=d.parent();if(typeof d!="undefined"&&d!=null&&(d.hasClass("container")||d.hasClass("container-fluid"))&&d[0].style&&d[0].style.height&&d[0].style.height.indexOf("%")>0){a("body").height(a(window).innerHeight()-10);var e=b.el;while(!e.hasClass("row-fluid")&&!e.hasClass("row"))e=e.parent();if(typeof e!="undefined"&&e!=null&&(e.hasClass("row-fluid")||e.hasClass("row"))){var f=e.height();a("#nvd3chart_"+c).height(f),a("#nvd3chart_"+c+"  svg").height(f)}}b.chart&&b.chart.update&&b.chart.update()},setAxis:function(a,b){var c=this,d=c.state.get("xLabel");if(a=="all"||a=="x"){var e=function(a){return a};if(c.state.get("graphType").indexOf("Horizontal")<0){var f=c.model.fields.get(c.state.attributes.group);e=c.getFormatter(f.get("type"));if(d==null||d==""||typeof d=="undefined")d=f.get("label")}else d=c.state.get("yLabel");b.xAxis.axisLabel(d).tickFormat(e)}if(a=="all"||a=="y"){var g=c.state.get("yLabel"),h=function(a){return a};if(c.state.get("graphType").indexOf("Horizontal")>=0){var i=c.model.fields.get(c.state.attributes.group);h=c.getFormatter(i.get("type")),g=c.state.get("xLabel")}else if(g==null||g==""||typeof g=="undefined")g=c.state.attributes.seriesValues.join("/");b.yAxis.axisLabel(g).tickFormat(h)}},getFormatter:function(a){var b=this;switch(a){case"string":return d3.format(",s");case"float":return d3.format(",r");case"integer":return d3.format(",r");case"date":return d3.time.format(b.state.get("tickFormatDate")||"%x")}},addOption:{staggerLabels:function(a,b){a.staggerLabels(b)},tooltips:function(a,b){a.tooltips(b)},showValues:function(a,b){a.showValues(b)},tooltip:function(a,b){var c=function(a,c,d,e,f){return b.replace("{x}",c).replace("{y}",d).replace("{key}",a)};a.tooltip(c)},minmax:function(a,b){},trendlines:function(a,b){},showLegend:function(a,b){a.showLegend(b)},showControls:function(a,b){a.showControls(b)},showMaxMin:function(a,b){a.showMaxMin(b)},showValues:function(a,b){a.showValues(b)},customTooltips:function(a,b){},stacked:function(a,b){a.stacked(b)},grouped:function(a,b){a.stacked(!b)},margin:function(a,b){a.margin(b)}},getGraph:{multiBarChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.multiBarChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.multibar.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.multibar.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},lineChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.lineChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.lines.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.lines.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},lineDottedChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.lineDottedChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.lines.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.lines.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},lineWithFocusChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.lineWithFocusChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.lines.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.lines.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},indentedTree:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.indentedTree()},stackedAreaChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.stackedAreaChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.stacked.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.stacked.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},historicalBar:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.historicalBar(),b},multiBarHorizontalChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.multiBarHorizontalChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.multibar.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.multibar.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},legend:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.legend(),b},line:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.line(),b},sparkline:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.sparkline(),b},sparklinePlus:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.sparklinePlus(),b},multiChart:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.multiChart(),b},bulletChart:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.bulletChart(),b},linePlusBarChart:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.linePlusBarChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b),b},cumulativeLineChart:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.cumulativeLineChart(),a.setAxis(a.options.state.axisTitlePresent||"all",b),b},scatterChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.scatterChart(),b.showDistX(!0).showDistY(!0),a.setAxis(a.options.state.axisTitlePresent||"all",b);var c=a.getActionsForEvent("selection");c.length>0&&b.scatter.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.scatter.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b},discreteBarChart:function(a){var b=a.getActionsForEvent("selection"),c;a.chart!=null?c=a.chart:c=nv.models.discreteBarChart(),a.setAxis(a.options.state.axisTitlePresent||"all",c),b.length>0&&c.discretebar.dispatch.on("elementClick",function(c){a.doActions(b,[c.point.record])});return c;var d},lineWithBrushChart:function(a){var b;return a.chart!=null?b=a.chart:b=nv.models.lineWithBrushChart(options),a.setAxis(a.options.state.axisTitlePresent||"all",b),b},multiBarWithBrushChart:function(a){var b=a.getActionsForEvent("selection"),c={};a.state.attributes.options&&(a.state.attributes.options.trendlines&&(c.trendlines=a.state.attributes.options("trendlines")),a.state.attributes.options.minmax&&(c.minmax=a.state.attributes.options("minmax"))),b.length>0?c.callback=function(c){var d=c[0][0].record,e=c[0][c[0].length-1].record;a.doActions(b,[d,e])}:c.callback=function(){};var d;return a.chart!=null?d=a.chart:d=nv.models.multiBarWithBrushChart(c),d},pieChart:function(a){var b;a.chart!=null?b=a.chart:b=nv.models.pieChart(),b.values(function(a){var b=[];return _.each(a.values,function(a){b.push({x:a.x,y:a.y})}),b});var c=a.getActionsForEvent("selection");c.length>0&&b.pie.dispatch.on("elementClick",function(b){a.doActions(c,[b.point.record])});var d=a.getActionsForEvent("hover");return d.length>0&&b.pie.dispatch.on("elementMouseover",function(b){a.doActions(d,[b.point.record])}),b}},getGraphModel:function(a,b){switch(b){case"historicalBar":case"multiBarChart":case"multiBarWithBrushChart":case"multiBarHorizontalChart":return a.chart.multibar;case"lineChart":case"lineDottedChart":case"lineWithFocusChart":case"linePlusBarChart":case"cumulativeLineChart":case"lineWithBrushChart":return a.chart.lines;case"bulletChart":return a.chart.bullet;case"scatterChart":return a.chart.scatter;case"stackedAreaChart":return a.chart.stacked;case"pieChart":return a.chart.pie;case"discreteBarChart":return a.chart.discretebar}},doActions:function(a,b){_.each(a,function(a){a.action.doAction(b,a.mapping)})},getFieldLabel:function(a){var b=this,c=a.attributes.label;a.attributes.is_partitioned&&(c=a.attributes.partitionValue);if(typeof b.state.attributes.fieldLabels!="undefined"&&b.state.attributes.fieldLabels!=null){var d=_.find(b.state.attributes.fieldLabels,function(a){return a.id==c});typeof d!="undefined"&&d!=null&&(c=d.label)}return c}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.Rickshaw=Backbone.View.extend({template:'<div id="{{uid}}"> <div> ',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.options=b},render:function(){console.log("View.Rickshaw: render");var a=this,b="#"+this.uid;a.graph&&(jQuery(b).empty(),delete a.graph);var c=Mustache.render(this.template,this);this.el.html(c)},redraw:function(){var a=this;console.log("View.Rickshaw: redraw"),a.graph?a.updateGraph():a.renderGraph()},updateGraph:function(){var a=this;a.createSeries(),a.graph.update()},convertDateValueWithoutMillis:function(a){return Math.round(a.valueOf()/1e3)},renderGraph:function(){var a=this;this.graphOptions={element:document.querySelector("#"+this.uid)},a.graphOptions=_.extend(a.graphOptions,a.options.state.options),a.createSeries(),a.graphOptions.series=a.series,a.graph=new Rickshaw.Graph(a.graphOptions),a.options.state.unstack&&(a.graph.renderer.unstack=!0),a.graph.render();var b={graph:a.graph};b=_.extend(b,a.options.state.hoverDetailOpt);var c=new Rickshaw.Graph.HoverDetail(b),d={graph:a.graph};d=_.extend(d,a.options.state.xAxisOptions);var e=new Rickshaw.Graph.Axis.Time(d);e.render();var f=new Rickshaw.Graph.Axis.Y({graph:a.graph});f.render();if(a.options.state.events){a.annotator=new Rickshaw.Graph.Annotate({graph:a.graph,element:document.getElementById("timeline")});var g=a.options.state.events.timeField,h=a.options.state.events.valueField,i=a.options.state.events.endField;_.each(a.options.state.events.dataset.getRecords(a.options.state.events.resultType),function(b){i?a.annotator.add(a.convertDateValueWithoutMillis(b.attributes[g]),b.attributes[h],a.convertDateValueWithoutMillis(b.attributes[i])):a.annotator.add(a.convertDateValueWithoutMillis(b.attributes[g]),b.attributes[h])}),a.annotator.update()}if(a.options.state.legend)var j=new Rickshaw.Graph.Legend({graph:a.graph,element:document.querySelector("#"+a.options.state.legend)}),k=new Rickshaw.Graph.Behavior.Series.Toggle({graph:a.graph,legend:j}),l=new Rickshaw.Graph.Behavior.Series.Order({graph:a.graph,legend:j}),m=new Rickshaw.Graph.Behavior.Series.Highlight({graph:a.graph,legend:j})},createSeries:function(){var a=this;a.series?a.series.length=0:a.series=[];var b=a.series,c=this.options.state.series,d=c.fillEmptyValuesWith,e="#C0C0C0";a.options.state.unselectedColor&&(e=a.options.state.unselectedColor);var f=!1;a.model.queryState.isSelected()&&(f=!0);var g="filtered";a.options.resultType!==null&&(g=a.options.resultType);var h=a.model.getRecords(g),i=a.model.fields.get(a.options.state.group),j=[],k;c.sizeField&&(k=a.model.fields.get(c.sizeField));if(c.type=="byFieldValue"){var l={},m=a.model.fields.get(c.seriesField),n=a.model.fields.get(c.valuesField);if(!n)throw"view.rickshaw: unable to find field ["+c.valuesField+"] in model";_.each(h,function(a,b){var c=a.getFieldValueUnrendered(m),e;if(l[c]!=null)e=l[c];else{e={name:c,data:[],field:n};var f=a.getFieldColor(m);f!=null&&(e.color=f)}var g=a.getFieldShapeName(m),h;i.attributes.type=="date"?h=Math.floor(a.getFieldValueUnrendered(i)/1e3):h=a.getFieldValueUnrendered(i);var o=a.getFieldValue(i),p=a.getFieldValueUnrendered(n),q=a.getFieldValue(n);if(p&&!isNaN(p)){var r={x:h,y:p,record:a,y_formatted:q,x_formatted:o};k&&(r.size=a.getFieldValueUnrendered(k)),g!=null&&(r.shape=g),e.data.push(r),d!=null&&j.push(h),l[c]=e}});for(var o in l)b.push(l[o])}else{if(c.type!="byFieldName"&&c.type!="byPartitionedField")throw"views.rickshaw.graph.js: unsupported or not defined type "+c.type;var p;c.type=="byFieldName"?p=c.valuesField:(p=[],_.each(c.aggregationFunctions,function(b){_.each(a.model.getPartitionedFieldsForAggregationFunction(b,c.aggregatedField),function(a){p.push(a.get("id"))})})),_.each(p,function(g){var l;c.type=="byFieldName"&&g.fieldName?l=a.model.fields.get(g.fieldName):l=a.model.fields.get(g);var m;g.fieldColor&&(m=g.fieldColor);var n=[];_.each(h,function(a,b){var c;i.attributes.type=="date"?c=Math.floor(a.getFieldValueUnrendered(i)/1e3):c=a.getFieldValueUnrendered(i);var g=a.getFieldValue(i);try{var h=a.getFieldValueUnrendered(l),m=a.getFieldValue(l);if(h!=null&&!isNaN(h)){var o,p=a.getFieldColor(l);f?a.isRecordSelected()?o=p:o=e:o=p;var q=a.getFieldShapeName(l),r={x:c,y:h,record:a,y_formatted:m,x_formatted:g};o!=null&&(r.color=o),q!=null&&(r.shape=q),k&&(r.size=a.getFieldValueUnrendered(k)),n.push(r),d!=null&&j.push(c)}}catch(s){}});if(n.length>0){var o;m?o=m:o=l.getColorForPartition();var p={data:n,name:a.getFieldLabel(l)};o&&(p.color=o),b.push(p)}})}d!=null&&(j=_.unique(j),_.each(b,function(a){var b=_.map(a.data,function(a){return a.x});_.each(_.difference(j,b),function(b){a.data.push({x:b,y:d})})}))},getFieldLabel:function(a){var b=this,c=a.attributes.label;a.attributes.is_partitioned&&(c=a.attributes.partitionValue);if(typeof b.options.state.fieldLabels!="undefined"&&b.options.state.fieldLabels!=null){var d=_.find(b.state.attributes.fieldLabels,function(a){return a.id==c});typeof d!="undefined"&&d!=null&&(c=d.label)}return c}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.SaveCSV=Backbone.View.extend({template:'<a id="{{uid}}" style="text-decoration: none;cursor: pointer;"><i class="icon-download" title="Download as csv file"></i></a>',id:"save",initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.records.bind("reset",this.render),this.model.queryState.bind("selection:done",this.render),this.uid=b.id||"save_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.options=b},initialize:function(b){this.el=a(this.el)},updateState:function(a){var b=this;b.options.visibleColumns=a.visibleColumns},render:function(){var a=this,b=function(){var b=[],c=a.model.records,d=[];_.each(a.options.visibleColumns,function(b){b.indexOf("_sum",b.length-"_sum".length)!==-1&&(b=b.substring(0,b.length-4));if(a.options.fieldLabels){var c=_.find(a.options.fieldLabels,function(a){return a.id==b});c?d.push(c.label):d.push(b)}else d.push(b)}),b.push(d),_.each(c.models,function(c){var d=[];_.each(a.options.visibleColumns,function(a){d.push(c.getFieldValueUnrendered(c.fields.get(a)))}),b.push(d)});var e="",f="";for(var g=0;g<b.length;g++){var f="";for(var h in b[g]){var i=b[g][h]+"";f+='"'+i.replace(/"/g,'""')+'",'}f=f.slice(0,-1),e+=f+"\r\n"}saveAs(new Blob([e],{type:"text/plain;charset="+document.characterSet}),"data.csv")},c=Mustache.render(this.template,a);this.el.off("click"),this.el.click(function(){return b()}),this.el.html(c)}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.SlickGridGraph=Backbone.View.extend({initialize:function(b){var c=this;this.el=a(this.el),this.discardSelectionEvents=!1,this.el.addClass("recline-slickgrid"),_.bindAll(this,"render"),_.bindAll(this,"onSelectionChanged"),_.bindAll(this,"handleRequestOfRowSelection"),this.resultType="filtered",c.options.resultType!==null&&(this.resultType=c.options.resultType),this.model.records.bind("add",this.render),this.model.records.bind("reset",this.render),this.model.records.bind("remove",this.render),this.model.queryState.bind("selection:done",this.handleRequestOfRowSelection);var d=_.extend({hiddenColumns:[],visibleColumns:[],columnsOrder:[],columnsSort:{},columnsWidth:[],fitColumns:!1},b.state);this.state=new recline.Model.ObjectState(d)},events:{},render:function(){function b(a){return isFinite(a)&&a}function c(a){return!isFinite(a)||a==0}function ib(){if(a.model.getRecords(a.resultType).length>0){var b=a.el.parent();typeof b!="undefined"&&b!=null&&(b[0].style&&b[0].style.height&&b[0].style.height.indexOf("%")>0||b.hasClass("h100"))&&(a.el.height(a.el.parent()[0].offsetHeight),a.grid.invalidateAllRows(),a.grid.resizeCanvas(),a.grid.render())}}var a=this,d={enableCellNavigation:!0,enableColumnReorder:!0,enableExpandCollapse:!0,explicitInitialization:!0,syncColumnCellResize:!0,forceFitColumns:this.state.get("fitColumns"),useInnerChart:b(this.state.get("useInnerChart"))&&c(this.state.get("hideInnerChartScale")),innerChartMax:this.state.get("innerChartMax"),useStripedStyle:this.state.get("useStripedStyle"),useCondensedStyle:this.state.get("useCondensedStyle"),useHoverStyle:this.state.get("useHoverStyle"),showLineNumbers:this.state.get("showLineNumbers"),showTotals:this.state.get("showTotals"),showPartitionedData:this.state.get("showPartitionedData"),selectedCellFocus:this.state.get("selectedCellFocus"),customHtmlFormatters:this.state.get("customHtmlFormatters"),fieldFormatters:this.state.get("fieldFormatters")},e=[],f=function(b,c,d,e,f){var g=a.model.getFields(a.resultType).get(e.id);return g.renderer?g.renderer(d,g,f):d},g=a.model.getRecords(a.resultType);if(d.showLineNumbers==1&&g.length>0){var h={id:"lineNumberField",name:"",field:"lineNumberField",sortable:d.showPartitionedData?!1:!0,maxWidth:40,formatter:Slick.Formatters.FixedCellFormatter};e.push(h)}var i=[],j=this.state.get("columnsOrder");if(d.showPartitionedData){var k=function(a){if(a&&a.constructor&&a.constructor.toString){var b=a.constructor.toString().match(/function\s*(\w+)/);if(b&&b.length==2)return b[1]}return undefined};if(k(a.model)!="VirtualDataset")throw"Slickgrid exception: showPartitionedData option can only be used on a partitioned virtualmodel! Exiting";var l=d.showPartitionedData.measures[0].field,m=d.showPartitionedData.partition,n=a.model.getPartitionedFields(m,l),o=n[0].id;i=a.model.attributes.aggregation.dimensions.concat([d.showPartitionedData.partition]).concat(_.map(d.showPartitionedData.measures,function(a){return a.field+"_"+a.aggregation}));var p=a.model.attributes.aggregation.dimensions.concat([o]).concat(_.map(d.showPartitionedData.measures,function(a){return a.field+"_"+a.aggregation})),q=this.state.get("columnsOrder");if(typeof q=="undefined"||q==null||q.length==0)j=p;var r={id:o,name:d.showPartitionedData.partition,field:d.showPartitionedData.partition,sortable:!1,minWidth:80,formatter:f},s=_.find(a.state.get("columnsWidth"),function(a){return a.column==field.id});s&&(h.width=s.width),e.push(r)}_.each(a.model.getFields(a.resultType).toJSON(),function(b){var c=f;if(d.customHtmlFormatters&&!d.showPartitionedData){var g=_.find(d.customHtmlFormatters,function(a){return a.id==b.id});g&&(c=g.formula?Slick.Formatters.HtmlExtFormatter:Slick.Formatters.HtmlFormatter)}var h="";if(d.fieldFormatters){var j=_.find(d.fieldFormatters,function(a){return a.id==b.id});j&&(h=j.cssClass)}var k={id:b.id,name:b.label,field:b.id,cssClass:h,sortable:d.showPartitionedData?!1:!0,minWidth:80,formatter:c};a.model.queryState.attributes.sort&&_.each(a.model.queryState.attributes.sort,function(a){k.sortable&&b["id"]==a.field&&(k.sorted=a.order)});var l=_.find(a.state.get("columnsWidth"),function(a){return a.column==b.id});l&&(k.width=l.width),d.showPartitionedData?(_.contains(i,b.id)||b["id"]==o&&b["field"]==d.showPartitionedData.partition)&&e.push(k):e.push(k)});var t=a.state.get("innerChartSerie1"),u=a.state.get("innerChartSerie2");d.useInnerChart==1&&g.length>0&&e.push({name:a.state.get("innerChartHeader"),id:"innerChart",field:"innerChart",sortable:!1,alignLeft:!0,minWidth:150,formatter:t&&u?Slick.Formatters.TwinBarFormatter:Slick.Formatters.PercentCompleteBar}),a.state.get("fieldLabels")&&a.state.get("fieldLabels").length>0&&_.each(a.state.get("fieldLabels"),function(a){for(var b in e)e[b].id==a.id&&(e[b].name=a.label)});var v=[];a.state.get("visibleColumns").length>0?(v=e.filter(function(b){return _.indexOf(a.state.get("visibleColumns"),b.id)>=0||d.showLineNumbers==1&&b.id=="lineNumberField"}),a.state.get("useInnerChart")==1&&g.length>0&&v.push(e[e.length-1])):v=e.filter(function(b){return _.indexOf(a.state.get("hiddenColumns"),b.id)==-1}),j&&(v=v.sort(function(a,b){var c=_.indexOf(j,a.id),d=_.indexOf(j,b.id);return c>=0&&d>=0?c>d?1:-1:a.id=="innerChart"||b.id=="lineNumberField"?1:b.id=="innerChart"||a.id=="lineNumberField"?-1:c<d?1:-1}),e=e.sort(function(a,b){return _.indexOf(j,a.id)>_.indexOf(j,b.id)?1:-1}));var w=[];for(var x=e.length-1;x>=0;x--)_.indexOf(_.pluck(v,"id"),e[x].id)==-1&&w.push(e.splice(x,1)[0]);e=e.concat(w);var y=0,z=function(a){var b=""+parseInt(a),c=b.length;if(c<=1)return 10;var d=parseInt(b.charAt(0)),e=parseInt(b.charAt(1));return e<5?(d+.5)*Math.pow(10,c-1):(d+1)*Math.pow(10,c-1)};a.state.get("useInnerChart")==1&&t&&g.length>0&&(_.each(g,function(b){var c={};_.each(a.model.getFields(a.resultType).models,function(a){c[a.id]=b.getFieldValueUnrendered(a);if(a.id==t||a.id==u){var d=Math.abs(parseFloat(c[a.id]));d>y&&(y=d)}})}),u&&(y=z(y)),d.innerChartMax=y);var A=[],B=[],C=[],D=0;if(d.showPartitionedData){var m=d.showPartitionedData.partition,E=a.model.attributes.aggregation.dimensions,F=g,G=[];for(var H in E){var I=E[H],J=_.map(F,function(a){return a.attributes[I]});G[H]=_.uniq(J)}var l=d.showPartitionedData.measures[0].field,n=a.model.getPartitionedFields(m,l),K=_.map(n,function(a){return a.attributes.partitionValue}),L=_.uniq(K),M={},N=!1;E.length==1&&(N=!0,G[1]=[""],E[1]="___fake____");for(var O in G[0]){M={};var P=E[0];for(var Q in G[1]){M={};var R=E[1],S=_.find(F,function(a){return a.attributes[P]==G[0][O]&&(N||a.attributes[R]==G[1][Q])});for(var T in L){M={},Q==0&&T==0&&(M[P]=G[0][O]),T==0&&(M[R]=G[1][Q]),M[m]=L[T];for(var U in d.showPartitionedData.measures){var V=d.showPartitionedData.measures[U],W=V.field,X=a.model.getPartitionedFields(m,W),Y=_.find(X,function(a){return a.attributes.partitionValue==L[T]});if(Y)if(S){var Z=S.getFieldValueUnrendered(Y);Z?M[W+"_"+V.aggregation]=S.getFieldValueUnrendered(Y):M[W+"_"+V.aggregation]=0}else M[W+"_"+V.aggregation]=0}d.showLineNumbers==1&&(M.lineNumberField=D),M.rowNumber=D,M.__orig_record__=S,A.push(M)}if(d.showPartitionedData.showSubTotals){M={},M[m]="<b>Total(s)</b>";for(var U in d.showPartitionedData.measures){var V=d.showPartitionedData.measures[U],W=V.field+"_"+V.aggregation,Y=_.find(a.model.getFields(a.resultType).models,function(a){return a.attributes.id==W});if(Y&&S){var Z=S.getFieldValueUnrendered(Y);Z?M[W]="<b>"+S.getFieldValueUnrendered(Y)+"</b>":M[W]="<b>0</b>"}else M[W]="<b>0</b>"}C.push(A.length),A.push(M)}}}}else _.each(g,function(b){b.is_selected&&B.push(D);var c={schema_colors:[]};_.each(a.model.getFields(a.resultType).models,function(a){c[a.id]=b.getFieldValueUnrendered(a),t&&a.id==t&&(c.schema_colors[0]=b.getFieldColor(a)),u&&a.id==u&&(c.schema_colors[1]=b.getFieldColor(a))}),a.state.get("useInnerChart")==1&&t&&(u?c.innerChart=[c[t],c[u],y]:c.innerChart=[c[t],y]),d.customHtmlFormatters&&_.each(d.customHtmlFormatters,function(a){a.formula?c[a.id]=[b,a.formula]:c[a.id]=[b.attributes,a.template]}),A.push(c),D++,d.showLineNumbers==1&&(c.lineNumberField=D),c.rowNumber=D,c.__orig_record__=b});if(d.showTotals&&g.length>0){d.totals={};if(a.model.getField_byAggregationFunction){var $=a.model.getRecords("totals");for(var ab in d.showTotals){var bb=d.showTotals[ab],cb=a.model.getField_byAggregationFunction("totals"+(bb.filtered?"_filtered":""),bb.field,bb.aggregation);typeof cb!="undefined"&&(d.totals[bb.field]=$[0].getFieldValueUnrendered(cb))}}else for(var ab in d.showTotals){var bb=d.showTotals[ab],db=0;for(var D in g)db+=g[D].attributes[bb.field];var cb=a.model.fields.get(bb.field),eb=g[0].attributes[bb.field];bb.aggregation=="sum"?g[0].attributes[bb.field]=db:bb.aggregation=="avg"&&(g[0].attributes[bb.field]=db/g.length),d.totals[bb.field]=g[0].getFieldValue(cb),bb.align&&(d.totals[bb.field]="<div style='text-align:"+bb.align+"'>"+d.totals[bb.field]+"</div>"),g[0].attributes[bb.field]=eb}}this.options.actions!=null&&typeof this.options.actions!="undefined"&&_.each(this.options.actions,function(a){_.indexOf(a.event,"hover")>=0&&(d.trackMouseHover=!0)}),A.getItemMetadata=function(a){if(_.contains(C,a))return{selectable:!1}},this.grid=new Slick.Grid(this.el,A,v,d);var fb=["s-table"];d.useHoverStyle&&fb.push("s-table-hover"),d.useCondensedStyle&&fb.push("s-table-condensed"),d.useStripedStyle&&fb.push("s-table-striped"),this.grid.addClassesToGrid(fb),this.grid.removeClassesFromGrid(["ui-widget"]),this.grid.setSelectionModel(new Slick.RowSelectionModel);var gb=[];_.each(a.model.queryState.attributes.sort,function(a){gb.push({columnId:a.field,sortAsc:a.order=="asc"})}),this.grid.setSortColumns(gb),this.grid.onSelectedRowsChanged.subscribe(function(b,c){a.discardSelectionEvents||a.onSelectionChanged(c.rows),a.discardSelectionEvents=!1}),this.grid.onSort.subscribe(function(b,c){var d=c.sortAsc?"asc":"desc";c.sortCol.sorted&&(c.sortCol.sorted=="asc"&&(d="desc"),c.sortCol.sorted=="desc"&&(d="asc"));var e=[{field:c.sortCol.field,order:d}];a.model.query({sort:e})}),this.grid.onColumnsReordered.subscribe(function(b,c){a.state.set({columnsOrder:_.pluck(a.grid.getColumns(),"id")})}),this.grid.onColumnsResized.subscribe(function(b,c){var d=c.grid.getColumns(),e=c.grid.getOptions().defaultColumnWidth,f=[];_.each(d,function(a){a.width!=e&&f.push({column:a.id,width:a.width})}),a.state.set({columnsWidth:f})}),this.grid.onRowHoverIn.subscribe(function(b,c){var d=[];d.push(a.model.records.models[c.row]);var e=
a.options.actions;e.forEach(function(a){a.action.doAction(d,a.mapping)})});var hb=new Slick.Controls.ColumnPicker(e,this.grid,_.extend(d,{state:this.state}));return a.visible?(a.grid.init(),a.rendered=!0):a.rendered=!1,ib(),this.handleRequestOfRowSelection(),this},handleRequestOfRowSelection:function(){this.discardSelectionEvents=!0;var a=[],b=this.model.getRecords(this.resultType),c=null;for(row in b)if(b[row].is_selected){a.push(row);if(!c||row<c)c=row}this.grid.getSelectionModel().setSelectedRows(a),c&&this.options.state&&this.options.state.selectedCellFocus&&this.grid.scrollRowToTop(c)},onSelectionChanged:function(a){var b=this,c=[];_.each(a,function(a){var d=b.grid.getDataItem(a);c.push(d.__orig_record__),d.__orig_record__.is_selected=!0});var d=this.options.actions;d!=null&&d.forEach(function(a){a.action.doAction(c,a.mapping)})},show:function(){this.rendered||(this.grid||this.render(),this.grid.init(),this.rendered=!0),this.visible=!0},hide:function(){this.visible=!1}})}(jQuery,recline.View),function(a){function b(b,c,d){function h(){c.onHeaderContextMenu.subscribe(i),d=a.extend({},g,d),e=a('<ul class="dropdown-menu slick-contextmenu" style="display:none;position:absolute;z-index:20;" />').appendTo(document.body),e.bind("mouseleave",function(b){a(this).fadeOut(d.fadeSpeed)}),e.bind("click",j)}function i(g,h){g.preventDefault(),e.empty(),f=[];var i,j;for(var k=0;k<b.length;k++){var l=b[k].id;l.indexOf("ratioToReport")==-1&&l.indexOf("ratioToMax")==-1&&l.indexOf("dimension")==-1&&l.indexOf("count")==-1&&(i=a("<li />").appendTo(e),j=a('<input type="checkbox" />').data("column-id",b[k].id).attr("id","slick-column-vis-"+b[k].id).attr("style","float:left"),f.push(j),c.getColumnIndex(b[k].id)!=null&&j.attr("checked","checked"),j.appendTo(i),a("<label />").text(b[k].name).attr("for","slick-column-vis-"+b[k].id).attr("style","float:left;margin:0").appendTo(i),a("<br/>").appendTo(i))}a("<li/>").addClass("divider").appendTo(e),i=a("<li />").data("option","autoresize").appendTo(e),j=a('<input type="checkbox" />').data("option","autoresize").attr("id","slick-option-autoresize").attr("style","float:left"),j.appendTo(i),a("<label />").text("Force fit columns").attr("for","slick-option-autoresize").attr("style","float:left;margin:0").appendTo(i),c.getOptions().forceFitColumns&&j.attr("checked","checked"),e.css("top",g.pageY-10).css("left",g.pageX-10).fadeIn(d.fadeSpeed)}function j(e){if(a(e.target).data("option")=="autoresize"){var g;if(a(e.target).is("li")){var h=a(e.target).find("input").first();g=!h.is(":checked"),h.attr("checked",g)}else g=e.target.checked;g?(c.setOptions({forceFitColumns:!0}),c.autosizeColumns()):c.setOptions({forceFitColumns:!1}),d.state.set({fitColumns:g});return}if(a(e.target).is("li")&&!a(e.target).hasClass("divider")||a(e.target).is("input")){if(a(e.target).is("li")){var h=a(e.target).find("input").first();h.attr("checked",!h.is(":checked"))}var i=[],j=[];a.each(f,function(c,d){a(this).is(":checked")?i.push(b[c]):j.push(b[c].id)});if(!i.length){a(e.target).attr("checked","checked");return}c.setColumns(i),d.state.set({hiddenColumns:j})}}var e,f,g={fadeSpeed:250};h()}a.extend(!0,window,{Slick:{Controls:{ColumnPicker:b}}})}(jQuery),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.xCharts=Backbone.View.extend({template:'<figure style="clear:both; width: {{width}}px; height: {{height}}px;" id="{{uid}}"></figure><div class="xCharts-title-x" style="width:{{width}}px;text-align:center;margin-left:50px">{{xAxisTitle}}</div>',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.options=b,this.height=b.state.height,this.width=b.state.width,this.xAxisTitle=b.state.xAxisTitle,this.yAxisTitle=b.state.yAxisTitle,b.state.loader&&b.state.loader.bindChart(this),b.state.widths&&(this.widths=b.state.widths);if(b.state.opts==null||typeof b.state.opts=="undefined")b.state.opts={}},render:function(a){isNaN(a)||(this.width=a);var b=this;b.trigger("chart:startDrawing");var c="#"+this.uid,d=Mustache.render(this.template,this);this.el.html(d),b.trigger("chart:endDrawing")},changeDataset:function(a){_.bindAll(this,"render","redraw"),this.model.off("change",this.render),addfacet,this.model.fields.off("reset",this.render),this.model.fields.off("add",this.render),this.model.off("query:done",this.redraw),this.model.queryState.off("selection:done",this.redraw),this.model=a,this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.render(),this.redraw()},redraw:function(){var a=this;a.trigger("chart:startDrawing"),a.renderGraph(),a.trigger("chart:endDrawing")},updateGraph:function(){var b=this;b.updateSeries();if(b.series.main&&b.series.main.length&&b.series.main[0].data&&b.series.main[0].data.length){this.el.find("figure div.noData").remove(),this.el.find("div.xCharts-title-x").html(b.options.state.xAxisTitle);var c=b.options.state;b.updateState(c),b.graph._options=c.opts,b.graph.setData(b.series),b.updateOptions(),b.graph.setType(c.type),c.legend&&b.createLegend()}else{var d="#"+this.uid;b.graph&&(d3.select(window).on("resize.for."+d,null),a(d).off(),a(d).empty(),delete b.graph),this.el.find("figure").html(""),this.el.find("figure").append((new recline.View.NoDataMsg).create()),this.el.find("div.xCharts-title-x").html(""),b.graph=null}},updateState:function(b){var c=this;c.options.state.yAxisTitle&&(b.opts.paddingLeft=90);if(b.useAnnotations){var d=function(b){var d=-(a("html").css("padding-left").replace("px","")+a("body").css("margin-left").replace("px",""))+10,e=-5,f=a(this).offset(),g='<div class="moda_tooltip annotation-description">'+b.text+"</div>",h=e+f.top;h<0&&(h=-h),nv.tooltip.show([f.left+d,e+f.top],g,f.left<c.el[0].offsetLeft+c.el.width()/2?"w":"e",null,c.el[0])},e=function(){nv.tooltip.cleanup()};b.opts.mouseoverAnnotation=d,b.opts.mouseoutAnnotation=e}},updateOptions:function(){var a=this;this.el.find("div.xCharts-title-x").html(a.options.state.xAxisTitle);if(a.options.state.yAxisTitle){var b=a.graph._height+a.graph._options.axisPaddingTop+a.graph._options.axisPaddingBottom;a.graph._g.selectAll("g.axisY g.titleY").data([a.options.state.yAxisTitle]).enter().append("g").attr("class","titleY").attr("transform","translate(-60,"+b/2+") rotate(-90)").append("text").attr("x",-3).attr("y",0).attr("dy",".32em").attr("text-anchor","middle").text(function(a){return a})}},renderGraph:function(){var b=this,c=b.options.state;b.updateSeries(),c.legend&&b.createLegend();if(b.series.main&&b.series.main.length&&b.series.main[0].data&&b.series.main[0].data.length)b.el.find("figure div.noData").remove(),b.el.find("figure svg g").remove(),b.updateState(c),c.interpolation&&(c.opts.interpolation=c.interpolation),b.graph=new xChart(c.type,b.series,"#"+b.uid,c.opts),c.timing!=null&&typeof c.timing!="undefined"&&(b.graph._options.timing=c.timing),b.updateOptions();else{var d="#"+this.uid;b.graph&&(d3.select(window).on("resize.for."+d,null),a(d).off(),a(d).empty(),delete b.graph),this.el.find("figure").html(""),this.el.find("figure").append((new recline.View.NoDataMsg).create()),this.el.find("div.xCharts-title-x").html("")}},createLegend:function(){var b=this,c=a("<div/>"),d=0;a("<script>function changeSeriesVisibility(i){var isVisible = $('g .color'+i).attr('display'); if (isVisible === 'none') {isVisible = false;} else {isVisible = true;}if (isVisible){	$('g .color'+i).attr('display', 'none');	$('.legend_item_value.legendcolor'+i).addClass('noFillLegendBullet');} else {$('g .color'+i).attr('display', 'inline');$('.legend_item_value.legendcolor'+i).removeClass('noFillLegendBullet');}}</script>").appendTo("head"),_.each(b.series.main,function(b){if(b.color){a("<style type='text/css'> .color"+d+"{ color:rgb("+b.color.rgb+");} "+".legendcolor"+d+"{ color:rgb("+b.color.rgb+"); background-color:rgb("+b.color.rgb+"); } "+".xchart .color"+d+" .fill { fill:rgba("+b.color.rgb+",0.1);} "+".xchart .color"+d+" .line { stroke:rgb("+b.color.rgb+");} "+".xchart .color"+d+" rect, .xchart .color"+d+" circle { fill:rgb("+b.color.rgb+");} "+"</style>").appendTo("head");var e=a('<div class="legend_item" onClick="changeSeriesVisibility('+d+')"/>'),f=a("<span/>");f.html(b.label),e.append(f);var g=a('<div class="legend_item_value"/>');g.addClass("legendcolor"+d),e.append(g),c.append(e)}else console.log("d.color not defined");d++}),b.options.state.legend.html(c)},updateSeries:function(){var a=this,b=a.options.state,c=recline.Data.SeriesUtility.createSeries(b.series,b.unselectedColor,a.model,a.resultType,b.group,b.scaleTo100Perc,b.groupAllSmallSeries),d={main:[],xScale:b.xScale,yScale:b.yScale};_.each(c,function(a){var b={color:a.color,name:a.key,label:a.label,data:_.map(a.values,function(a){return{x:a.x,y:a.y,x_formatted:a.x_formatted,y_formatted:a.y_formatted,legendField:a.legendField,legendValue:a.legendValue}})};d.main.push(b)}),a.options.state.useAnnotations&&c.length&&recline.Data.SeriesUtility.createSerieAnnotations(a.options.state.useAnnotations.dataset,a.options.state.useAnnotations.dateField,a.options.state.useAnnotations.textField,d.main),a.series=d}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.CurrentFilter=Backbone.View.extend({template:'    	<script>     	$(function() {     		$(".chzn-select-deselect").chosen({allow_single_deselect:true});     	});     	</script>       <div">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}"> 			<select class="chzn-select-deselect data-control-id" multiple data-placeholder="{{label}}">             {{#values}}             <option value="{{dataset_index}}-{{filter_index}}" selected>{{val}}</option>             {{/values}}           </select>         </fieldset>       </div>',events:{"change .chzn-select-deselect":"onFilterValueChanged"},initialize:function(b){var c=this;this.el=a(this.el),_.bindAll(this,"render"),this._sourceDatasets=b.models,this.uid=b.id||Math.floor(Math.random()*1e5),_.each(this._sourceDatasets,function(a){a.bind("query:done",c.render),a.queryState.bind("selection:done",c.render)})},render:function(){var a=this,b={id:a.uid,label:"Active filters"},c=[];_.each(a._sourceDatasets,function(b,d){_.each(b.queryState.get("filters"),function(e,f){var g={dataset_index:d,filter_index:f};g.val=a.filterDescription[e.type](e,b),c.push(g)})}),b.values=c;var d=Mustache.render(a.template,b);this.el.html(d)},filterDescription:{term:function(a,b){return b.fields.get(a.field).attributes.label+": "+a.term},range:function(a,b){return b.fields.get(a.field).attributes.label+": "+a.start+"-"+a.stop},list:function(a,b){var c=b.fields.get(a.field).attributes.label+": ";return _.each(a.list,function(a,b){b>0&&(c+=","),c+=a}),c}},onFilterValueChanged:function(b){var c=this;b.preventDefault();var d=a(b.target).parent(),e=d.find(".data-control-id")[0][0].value.split("-"),f=e[0],g=e[1];c._sourceDatasets[f].queryState.removeFilter(g)}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.DatePicker=Backbone.View.extend({template:'<div style="width: 230px;" id="datepicker-calendar-{{uid}}"></div>',fullyInitialized:!1,maindateFromChanged:!1,maindateToChanged:!1,comparedateFromChanged:!1,comparedateToChanged:!1,initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw","redrawCompare","calculateMonday","calculateFirstDayOfMonth","calculateLastDayOfMonth");if(!this.model)return;this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.options.compareModel&&(this.options.compareModel.bind("query:done",this.redrawCompare),this.options.compareModel.queryState.bind("selection:done",this.redrawCompare)),a(window).resize(this.resize),this.uid=b.id||(new Date).getTime()+Math.floor(Math.random()*1e4);var c=Mustache.render(this.template,this);this.el.html(c)},daterange:{yesterday:"day",lastweeks:"week",lastdays:"day",lastmonths:"month",lastquarters:"quarter",lastyears:"year",previousyear:"year",custom:"day"},onChange:function(a){var b=function(b,c){var d=[],e=a.getActionsForEvent("selection");if(e.length>0){var f=new Date(parseInt(b.dr1from_millis)),g=new Date(parseInt(b.dr1to_millis)),h=a.daterange[b.daterangePreset];d=[{field:"date_reference",value:[f.toString(),g.toString()]},{field:"rangetype_reference",value:[h]}];var i=h;b.comparisonPreset!="previousperiod"&&(i=a.daterange[b.comparisonPreset]);if(b.comparisonEnabled){var j=new Date(parseInt(b.dr2from_millis)),k=new Date(parseInt(b.dr2to_millis));j!=null&&k!=null&&(d.push({field:"date_compare",value:[j.toString(),k.toString()]}),d.push({field:"rangetype_compare",value:[i]}))}a.doActions(e,d)}};return b},doActions:function(a,b){_.each(a,function(a){a.action.doActionWithValues(b,a.mapping)})},render:function(){var b=this,c=this.uid;b.datepicker=a("#datepicker-calendar-"+c).DateRangesWidget({aggregations:[],values:{comparisonEnabled:!1,daterangePreset:"lastweeks",comparisonPreset:"previousperiod"},onChange:b.onChange(b)}),b.redraw(),b.redrawCompare();if(b.options.weeklyMode){var d=a(".datepicker.selectableRange").data("datepicker");d?d.weeklyMode=b.options.weeklyMode:a(".datepicker.selectableRange").data("datepicker","weeklyMode",b.options.weeklyMode)}else if(b.options.monthlyMode){var d=a(".datepicker.selectableRange").data("datepicker");d?d.monthlyMode=b.options.monthlyMode:a(".datepicker.selectableRange").data("datepicker","monthlyMode",b.options.monthlyMode)}},redraw:function(){if(!this.model||this.model=="undefined")return;var b=this,c=a(".date-ranges-picker").DatePickerGetDate();if(c){var d=c[0],e=b.model.queryState.getFilterByFieldName(b.options.fields.date);e&&e.type=="range"&&(d[0]=new Date(e.start),d[1]=new Date(e.stop));var e=b.model.queryState.getFilterByFieldName(b.options.fields.type);!e||e.type!="term";var f=b.datepicker.data("DateRangesWidget").options.values;!d[0]||!d[1]?(f.dr1from="N/A",f.dr1from_millis="",f.dr1to="N/A",f.dr1to_millis=""):(f.daterangePreset="custom",f.dr1from=b.retrieveDateStr(d[0]),f.dr1from_millis=(new Date(d[0])).getTime(),f.dr1to=b.retrieveDateStr(d[1]),f.dr1to_millis=(new Date(d[1])).getTime()),a(".date-ranges-picker").DatePickerSetDate(d,!0),f.dr1from&&f.dr1to&&a("span.main",b.datepicker).text(f.dr1from+" - "+f.dr1to),a(".dr1.from",b.datepicker).val(f.dr1from),a(".dr1.to",b.datepicker).val(f.dr1to),a(".dr1.from_millis",b.datepicker).val(f.dr1from_millis),a(".dr1.to_millis",b.datepicker).val(f.dr1to_millis),b.fullyInitialized||(a(".dr1.from").bind("keypress",function(a){b.maindateFromChanged=!0}),a(".dr1.to").bind("keypress",function(a){b.maindateToChanged=!0}),a(".dr1.from").bind("blur",function(c){if(b.maindateFromChanged){if(b.options.weeklyMode){var d=b.calculateMonday(a(this).val()),e=b.calculateSundayFromMonday(d),f=b.retrieveDateStr(d),g=b.retrieveDateStr(e);a(".dr1.from").val(f),a(".dr1.to").val(g),b.applyTextInputDateChange(d,f,b,!0,!0),b.applyTextInputDateChange(e,g,b,!0,!1)}else if(b.options.monthlyMode){var h=b.calculateFirstDayOfMonth(a(this).val()),i=b.calculateLastDayOfMonth(a(this).val()),j=b.retrieveDateStr(h),k=b.retrieveDateStr(i);a(".dr1.from").val(j),a(".dr1.to").val(k),b.applyTextInputDateChange(h,j,b,!0,!0),b.applyTextInputDateChange(i,k,b,!0,!1)}else{var l=b.retrieveDMYDate(a(this).val());b.applyTextInputDateChange(l,a(this).val(),b,!0,!0)}b.maindateFromChanged=!1}}),a(".dr1.to").bind("blur",function(c){if(b.maindateToChanged){if(b.options.weeklyMode){var d=b.calculateMonday(a(this).val()),e=b.calculateSundayFromMonday(d),f=b.retrieveDateStr(d),g=b.retrieveDateStr(e);a(".dr1.from").val(f),a(".dr1.to").val(g),b.applyTextInputDateChange(d,f,b,!0,!0),b.applyTextInputDateChange(e,g,b,!0,!1)}else if(b.options.monthlyMode){var h=b.calculateFirstDayOfMonth(a(this).val()),i=b.calculateLastDayOfMonth(a(this).val()),j=b.retrieveDateStr(h),k=b.retrieveDateStr(i);a(".dr1.from").val(j),a(".dr1.to").val(k),b.applyTextInputDateChange(h,j,b,!0,!0),b.applyTextInputDateChange(i,k,b,!0,!1)}else{var l=b.retrieveDMYDate(a(this).val()).getTime()+864e5-1;b.applyTextInputDateChange(new Date(l),a(this).val(),b,!0,!1)}b.maindateToChanged=!1}}))}},redrawCompare:function(){var b=this,c=a(".date-ranges-picker").DatePickerGetDate();if(c){var d=c[0],e=b.datepicker.data("DateRangesWidget").options.values;if(this.options.compareModel){if(b.fullyInitialized&&!e.comparisonEnabled)return;var f=b.options.compareModel.queryState.getFilterByFieldName(b.options.compareFields.date);f&&f.type=="range"&&(d[2]=new Date(f.start),d[3]=new Date(f.stop));var f=b.model.queryState.getFilterByFieldName(b.options.fields.type);!f||f.type!="term",d[2]&&d[3]?(e.comparisonEnabled=!0,e.comparisonPreset="custom",e.dr2from=b.retrieveDateStr(d[2]),e.dr2from_millis=(new Date(d[2])).getTime(),e.dr2to=b.retrieveDateStr(d[3]),e.dr2to_millis=(new Date(d[3])).getTime(),a(".comparison-preset").val("custom")):(e.comparisonEnabled=!1,e.dr2from="N/A",e.dr2from_millis="",e.dr2to="N/A",e.dr2to_millis="",a(".comparison-preset").val("previousperiod")),a(".date-ranges-picker").DatePickerSetDate(d,!0),e.comparisonEnabled&&e.dr2from&&e.dr2to?(a("span.comparison",b.datepicker).text(e.dr2from+" - "+e.dr2to),a("span.comparison",b.datepicker).show(),a("span.comparison-divider",b.datepicker).show()):(a("span.comparison-divider",b.datepicker).hide(),a("span.comparison",b.datepicker).hide()),a(".dr2.from",b.datepicker).val(e.dr2from),a(".dr2.to",b.datepicker).val(e.dr2to),a(".dr2.from_millis",b.datepicker).val(e.dr2from_millis),a(".dr2.to_millis",b.datepicker).val(e.dr2to_millis),b.fullyInitialized||(a(".dr2.from").bind("keypress",function(a){b.comparedateFromChanged=!0}),a(".dr2.to").bind("keypress",function(a){b.comparedateToChanged=!0}),a(".dr2.from").bind("blur",function(c){if(b.comparedateFromChanged){if(b.options.weeklyMode){var d=b.calculateMonday(a(this).val()),e=b.calculateSundayFromMonday(d),f=b.retrieveDateStr(d),g=b.retrieveDateStr(e);a(".dr2.from").val(f),a(".dr2.to").val(g),b.applyTextInputDateChange(d,f,b,!1,!0),b.applyTextInputDateChange(e,g,b,!1,!1)}else if(b.options.monthlyMode){var h=b.calculateFirstDayOfMonth(a(this).val()),i=b.calculateLastDayOfMonth(a(this).val()),j=b.retrieveDateStr(h),k=b.retrieveDateStr(i);a(".dr2.from").val(j),a(".dr2.to").val(k),b.applyTextInputDateChange(h,j,b,!1,!0),b.applyTextInputDateChange(i,k,b,!1,!1)}else{var l=b.retrieveDMYDate(a(this).val());b.applyTextInputDateChange(l,a(this).val(),b,!1,!0)}b.comparedateFromChanged=!1}}),a(".dr2.to").bind("blur",function(c){if(b.comparedateToChanged){if(b.options.weeklyMode){var d=b.calculateMonday(a(this).val()),e=b.calculateSundayFromMonday(d),f=b.retrieveDateStr(d),g=b.retrieveDateStr(e);a(".dr2.from").val(f),a(".dr2.to").val(g),b.applyTextInputDateChange(d,f,b,!1,!0),b.applyTextInputDateChange(e,g,b,!1,!1)}else if(b.options.monthlyMode){var h=b.calculateFirstDayOfMonth(a(this).val()),i=b.calculateLastDayOfMonth(a(this).val()),j=b.retrieveDateStr(h),k=b.retrieveDateStr(i);a(".dr2.from").val(j),a(".dr2.to").val(k),b.applyTextInputDateChange(h,j,b,!1,!0),b.applyTextInputDateChange(i,k,b,!1,!1)}else{var l=b.retrieveDMYDate(a(this).val()).getTime()+864e5-1;b.applyTextInputDateChange(new Date(l),a(this).val(),b,!1,!1)}b.comparedateToChanged=!1}}),b.fullyInitialized=!0)}else e.comparisonEnabled=!1,e.comparisonPreset="previousperiod",a(".comparison-preset").val("previousperiod"),a(".comparison-preset").prop("disabled",!0),a(".enable-comparison").removeAttr("checked"),a(".enable-comparison").change(),a(".comparison-daterange").css("display","none"),a(".enable-comparison").parent().css("display","none"),a("#datepicker-dropdown").css("min-height","140px")}},calculateMonday:function(a){var b=this.retrieveDMYDate(a),c=b.getDay(),d=(c==0?-6:1)-c;return new Date(b.getTime()+d*24*36e5)},calculateSundayFromMonday:function(a){return new Date(a.getTime()+6048e5-1)},calculateFirstDayOfMonth:function(a){var b=this.retrieveDMYDate(a);return b.setDate(1),b},calculateLastDayOfMonth:function(a){var b=this.retrieveDMYDate(a);b.setDate(1);var c=b.getMonth()+1;return c==12?(b.setMonth(0),b.setFullYear(b.getFullYear()+1)):b.setMonth(c),new Date(b.getTime()-1)},retrieveDMYDate:function(a){var b=a.split("/");if(b.length<3)return null;var c=new Date(b[2],parseInt(b[1])-1,b[0]);return b[2]>=1970&&c&&c.getMonth()+1==b[1]&&c.getDate()==Number(b[0])?c:null},retrieveDateStr:function(a){return d3.time.format("%d/%m/%Y")(a)},applyTextInputDateChange:function(b,c,d,e,f){var g=d.datepicker.data("DateRangesWidget").options,h=a(".datepicker.selectableRange").data("datepicker"),i=g.values;e?(f?(i.dr1from=c,i.dr1from_millis=b.getTime(),a(".dr1.from_millis").val(b.getTime()),h.date[0]=b.getTime()):(i.dr1to=c,i.dr1to_millis=b.getTime(),a(".dr1.to_millis").val(b.getTime()),h.date[1]=b.getTime()),h.mode=="tworanges"&&(h.lastSel=2)):(f?(i.dr2from=c,i.dr2from_millis=b.getTime(),a(".dr2.from_millis").val(b.getTime()),h.date[2]=b.getTime()):(i.dr2to=c,i.dr2to_millis=b.getTime(),a(".dr2.to_millis").val(b.getTime()),h.date[3]=b.getTime()),h.mode=="tworanges"&&(h.lastSel=0)),h.current=b,a(".date-ranges-picker").DatePickerSetMode(a(".date-ranges-picker").DatePickerGetMode())},getActionsForEvent:function(a){var b=[];return _.each(this.options.actions,function(c){_.contains(c.event,a)&&b.push(c)}),b}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.GenericFilter=Backbone.View.extend({className:"recline-filter-editor well",template:'<div class="filters" {{#backgroundColor}}style="background-color:{{backgroundColor}}"{{/backgroundColor}}>       <div class="form-stacked js-edit"> 	  	<div class="label label-info" style="display:{{titlePresent}}" > 		  	<h4>{{filterDialogTitle}}</h4> 		  	{{filterDialogDescription}} 	  	</div>         {{#filters}}           {{{filterRender}}} 		  <hr style="display:{{hrVisible}}">         {{/filters}}       </div>     </div>',templateHoriz:'<style> .separated-item { padding-left:20px;padding-right:20px; } </style> <div class="filters" style="background-color:{{backgroundColor}}">       <table > 	  	<tbody> 	  		<tr>	  			<td class="separated-item" style="display:{{titlePresent}}">				  	<div class="label label-info"> 					  	<h4>{{filterDialogTitle}}</h4> 					  	{{filterDialogDescription}} 				  	</div> 				</td>			  	{{#filters}} 			  	<td class="separated-item">          			{{{filterRender}}}           		</td>  				{{/filters}}         	</tr>  		</tbody>  	   </table>     </div> ',filterTemplates:{term:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>      		<div style="float:left;padding-right:10px;padding-top:2px;display:{{useLeftLabel}}">{{label}}</div>           <input type="text" value="{{term}}" name="term" class="data-control-id" />           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',slider:' 	<script> 		$(document).ready(function(){ 			$( "#slider{{ctrlId}}" ).slider({ 				min: {{min}}, 				max: {{max}}, 				value: {{term}}, 				slide: function( event, ui ) { 					$( "#amount{{ctrlId}}" ).html( "{{label}}: "+ ui.value ); 				} 			}); 			$( "#amount{{ctrlId}}" ).html( "{{label}}: "+ $( "#slider{{ctrlId}}" ).slider( "value" ) ); 		}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}" style="min-width:100px">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}} 			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 		</legend>  		  <label id="amount{{ctrlId}}">{{label}}: </label> 		  <div id="slider{{ctrlId}}" class="data-control-id"></div> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',slider_styled:' 	<style> 		 .layout-slider { padding-bottom:15px;width:150px } 	</style> 	<script> 		$(document).ready(function(){ 			$( "#slider{{ctrlId}}" ).jslider({ 				from: {{min}}, 				to: {{max}}, 				scale: [{{min}},"|","{{step1}}","|","{{mean}}","|","{{step3}}","|",{{max}}],             	{{#step}}step: {{step}}{{/step}}, 				limits: false, 				skin: "plastic" 			}); 		}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}} 			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 		</legend>  		<div style="float:left;padding-right:15px;display:{{useLeftLabel}}">{{label}} 			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 		</div> 	    <div style="float:left" class="layout-slider" > 	    	<input type="slider" id="slider{{ctrlId}}" value="{{term}}" class="slider-styled data-control-id" /> 	    </div>         </fieldset>       </div>     ',range:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>            <label class="control-label" for="">From</label>           <input type="text" value="{{start}}" name="start"  class="data-control-id-from" style="width:auto"/>           <label class="control-label" for="">To</label>           <input type="text" value="{{stop}}" name="stop" class="data-control-id-to"  style="width:auto"/> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',range_slider:' 	<script> 		$(document).ready(function(){ 			$( "#slider-range{{ctrlId}}" ).slider({ 				range: true, 				min: {{min}}, 				max: {{max}}, 				values: [ {{from}}, {{to}} ], 				slide: function( event, ui ) { 					$( "#amount{{ctrlId}}" ).html(  "{{label}}: " + ui.values[ 0 ] + " - " + ui.values[ 1 ] ); 				} 			}); 			$( "#amount{{ctrlId}}" ).html(  "{{label}}: " + $( "#slider-range{{ctrlId}}" ).slider( "values", 0 ) + " - " + $( "#slider-range{{ctrlId}}" ).slider( "values", 1 ) ); 		}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}" style="min-width:100px">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  		  <label id="amount{{ctrlId}}">{{label}} range: </label> 		  <div id="slider-range{{ctrlId}}" class="data-control-id" ></div> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',range_slider_styled:' 	<style> 	 .layout-slider { padding-bottom:15px;width:150px } 	</style> 	<script> 		$(document).ready(function(){ 			$( "#slider{{ctrlId}}" ).jslider({ 				from: {{min}}, 				to: {{max}}, 				scale: [{{min}},"|","{{step1}}","|","{{mean}}","|","{{step3}}","|",{{max}}], 				limits: false,             	{{#step}}step: {{step}}{{/step}}, 				skin: "round_plastic", 			}); 		}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}} 		</legend>  		<div style="float:left;padding-right:15px;display:{{useLeftLabel}}">{{label}}</div> 	    <div style="float:left" class="layout-slider" > 	    	<input type="slider" id="slider{{ctrlId}}" value="{{from}};{{to}}" class="slider-styled data-control-id" /> 	    </div>         </fieldset>       </div>     ',month_week_calendar:' 	  <style> 		.list-filter-item { cursor:pointer; } 		.list-filter-item:hover { background: lightblue;cursor:pointer; } 	  </style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}              <a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 			</legend> 			Year<br> 			<select class="drop-down2 fields data-control-id" >             {{#yearValues}}             <option value="{{val}}" {{selected}}>{{val}}</option>             {{/yearValues}}           </select> 			<br> 			Type<br> 			<select class="drop-down3 fields" > 				{{#periodValues}} 				<option value="{{val}}" {{selected}}>{{val}}</option> 				{{/periodValues}} 			</select> 			<br> 			<div style="max-height:500px;width:100%;border:1px solid grey;overflow:auto;"> 				<table class="table table-striped table-hover table-condensed" style="width:100%" data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}"> 				<tbody>				{{#values}} 				<tr class="{{selected}}"><td class="list-filter-item " myValue="{{val}}" startDate="{{startDate}}" stopDate="{{stopDate}}">{{label}}</td></tr> 				{{/values}} 				</tbody> 			  </table> 		  </div> 	    </fieldset>       </div> 	',range_calendar:' 	<script> 	$(function() { 		$( "#from{{ctrlId}}" ).datepicker({ 			defaultDate: "{{startDate}}", 			changeMonth: true, 			numberOfMonths: 1, 			dateFormat: "D M dd yy", 			onSelect: function( selectedDate ) { 				$( "#to{{ctrlId}}" ).datepicker( "option", "minDate", selectedDate ); 			} 		}); 		$( "#to{{ctrlId}}" ).datepicker({ 			defaultDate: "{{endDate}}", 			changeMonth: true, 			numberOfMonths: 1, 			dateFormat: "D M dd yy", 			onSelect: function( selectedDate ) { 				$( "#from{{ctrlId}}" ).datepicker( "option", "maxDate", selectedDate ); 			} 		}); 	}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  			<label for="from{{ctrlId}}">From</label> 			<input type="text" id="from{{ctrlId}}" name="from{{ctrlId}}" class="data-control-id-from" value="{{startDate}}" style="width:auto"/> 			<br> 			<label for="to{{ctrlId}}">to</label> 			<input type="text" id="to{{ctrlId}}" name="to{{ctrlId}}" class="data-control-id-to" value="{{endDate}}" style="width:auto"/>  		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>        </fieldset>       </div> 	',dropdown:'       <script>      	function updateColor(elem) {     		if (elem.prop("selectedIndex") == 0) elem.addClass("dimmed"); else elem.removeClass("dimmed");   		}       </script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:2px;display:{{useLeftLabel}}">{{label}}</div>     		<select class="drop-down fields data-control-id dimmed" onchange="updateColor($(this))"> 			<option class="dimmedDropDownText">{{innerLabel}}</option>             {{#values}}             <option class="normalDropDownText" value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select>         </fieldset>       </div>     ',dropdown_styled:'     	<script>     	$(function() {     		$(".chzn-select-deselect").chosen({allow_single_deselect:true});     	});     	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  			<div style="float:left;padding-right:10px;padding-top:3px;display:{{useLeftLabel}}">{{label}}</div>     		<select class="chzn-select-deselect data-control-id" data-placeholder="{{innerLabel}}">     		<option></option>             {{#values}}             <option value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select>         </fieldset>       </div>     '
,dropdown_date_range:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:3px;display:{{useLeftLabel}}">{{label}}</div> 			<select class="drop-down fields data-control-id" > 			<option></option>             {{#date_values}}             <option startDate="{{startDate}}" stopDate="{{stopDate}}" {{selected}}>{{val}}</option>             {{/date_values}}           </select>         </fieldset>       </div>     ',list:' 	  <style> 		.list-filter-item { cursor:pointer; } 		.list-filter-item:hover { background: lightblue;cursor:pointer; } 	  </style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}              <a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 			</legend>     		<div style="float:left;padding-right:10px;display:{{useLeftLabel}}">{{label}}     			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a>     		</div> 			<div style="max-height:500px;width:100%;border:1px solid grey;overflow:auto;"> 				<table class="table table-striped table-hover table-condensed" style="width:100%" data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" > 				<tbody>				{{#values}} 				<tr class="{{selected}}"><td class="list-filter-item" >{{val}}</td><td style="text-align:right">{{count}}</td></tr> 				{{/values}} 				</tbody>			  </table> 		  </div> 	    </fieldset>       </div> 	',listbox:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>      		<div style="float:left;padding-right:10px;display:{{useLeftLabel}}">{{label}}</div> 			<select class="fields data-control-id"  multiple SIZE=10>             {{#values}}             <option value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',listbox_styled:'     	<script>     	$(function() {     		$(".chzn-select-deselect").chosen({allow_single_deselect:true});     	});     	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div> 			<select class="chzn-select-deselect data-control-id" multiple data-placeholder="{{innerLabel}}">             {{#values}}             <option value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select>         </fieldset>       </div>     ',radiobuttons:'         <div class="filter-{{type}} filter" id="{{ctrlId}}">             <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">                 <legend style="display:{{useLegend}}">{{label}}</legend>      			<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div>     			<div class="btn-group data-control-id" >             		{{^noAllButton}}             		<button class="btn btn-mini grouped-button btn-primary">All</button>             		{{/noAllButton}}     	            {{#values}}     	    		<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button>     	            {{/values}}               	</div>             </div>         </div>         ',hierarchic_radiobuttons:'         <div class="filter-{{type}} filter" id="{{ctrlId}}">             <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">                 <legend style="display:{{useLegend}}">{{label}}</legend>      			<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div>     			<div class="btn-group data-control-id" level="1" style="float:left">             		{{#useAllButton}}             		<button class="btn btn-mini grouped-button {{all1Selected}}" val="All">All</button>             		{{/useAllButton}}     	            {{#values}}     	    		<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button>     	            {{/values}}               	</div>         		{{#useLevel2}} 	    			<div class="btn-group level2" level="2" style="float:left;display:{{showLevel2}}">      		{{#useAllButton}}         	 			<button class="btn btn-mini grouped-button {{all2Selected}}" val="">All</button>      		{{/useAllButton}} 			            {{#valuesLev2}} 	            			<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button> 			            {{/valuesLev2}} 	            	</div>             		{{#useLevel3}} 		    			<div class="btn-group level3" level="3" style="float:left;display:{{showLevel3}}">       		{{#useAllButton}} 	            			<button class="btn btn-mini grouped-button {{all3Selected}}" val="">All</button>      		{{/useAllButton}} 				            {{#valuesLev3}} 			        			<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button> 				            {{/valuesLev3}} 			        	</div>             		{{/useLevel3}}         		{{/useLevel2}}             </div>         </div>         ',multibutton:'     <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">     		<legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div>     		<div class="btn-group data-control-id" > 	            {{#values}} 	    		<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button> 	            {{/values}}           </div>         </fieldset>     </div>     ',legend:' 	  <style>       .legend-item { 					border-top:2px solid black;border-left:2px solid black; 					border-bottom:2px solid darkgrey;border-right:2px solid darkgrey; 					width:16px;height:16px;padding:1px;margin:5px; 					opacity: 0.85 					}  	 .legend-item.not-selected { background-color:transparent !important; } /* the idea is that the color "not-selected" overrides the original color (this way we may use a global style) */ 	  </style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  			<div style="float:left;padding-right:10px;display:{{useLeftLabel}}">{{label}}</div> 			<table style="width:100%;background-color:transparent">			{{#values}} 				<tr> 				<td style="width:25px"><div class="legend-item {{notSelected}}" myValue="{{val}}" style="background-color:{{color}}"></td> 				<td style="vertical-align:middle"><label style="color:{{color}};text-shadow: black 1px 1px, black -1px -1px, black -1px 1px, black 1px -1px, black 0px 1px, black 0px -1px, black 1px 0px, black -1px 0px">{{val}}</label></td>				<td><label style="text-align:right">[{{count}}]</label></td>				</tr>			{{/values}}			</table> 	    </fieldset>       </div> 	',color_legend:' 	<div class="filter-{{type}} filter" id="{{ctrlId}}" style="width:{{totWidth2}}px;max-height:{{totHeight2}}px">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  				<div style="float:left;padding-right:10px;height:{{lineHeight}}px;display:{{useLeftLabel}}"> 					<label style="line-height:{{lineHeight}}px">{{label}}</label> 				</div>             	<div class="data-control-id" style="width:{{totWidth}}px;height:{{totHeight}}px;display:inline" > 					<svg height="{{totHeight}}" xmlns="http://www.w3.org/2000/svg">             		<g> 					{{#colorValues}} 				    	<rect width="{{width}}" height={{lineHeight}} fill="{{color}}" x="{{x}}" y={{y}}/>             			{{#showValueLabels}}             			<text width="{{width}}" fill="{{textColor}}" x="{{x}}" y="{{yplus30}}">{{val}}</text>             			{{/showValueLabels}}             		{{/colorValues}}            		</g>             		<g>             			{{^showValueLabels}}             			{{#totWidth}}             			<path d="M0,0 L{{totWidth}},0 L{{totWidth}},{{totHeight}} L0,{{totHeight}} L0,0" style="fill:none;"/>             			{{/totWidth}}             			{{#colorValues2}}             			<text width="{{width}}" fill="{{textColor}}" x="{{x}}" y="{{yplus30}}">{{val}}</text>             			{{/colorValues2}}             			{{/showValueLabels}}             		</g> 					</svg>						</div> 	    </fieldset> 	</div> 	'},FiltersTemplate:{range_calendar:{needFacetedField:!1},month_week_calendar:{needFacetedField:!0},list:{needFacetedField:!0},legend:{needFacetedField:!0},dropdown:{needFacetedField:!0},dropdown_styled:{needFacetedField:!0},dropdown_date_range:{needFacetedField:!1},listbox:{needFacetedField:!0},listbox_styled:{needFacetedField:!0},term:{needFacetedField:!1},range:{needFacetedField:!0},slider:{needFacetedField:!0},range_slider:{needFacetedField:!0},range_slider_styled:{needFacetedField:!0},color_legend:{needFacetedField:!0},multibutton:{needFacetedField:!0},radiobuttons:{needFacetedField:!1},hierarchic_radiobuttons:{needFacetedField:!1}},events:{"click .js-remove-filter":"onRemoveFilter","click .js-add-filter":"onAddFilterShow","click #addFilterButton":"onAddFilter","click .list-filter-item":"onListItemClicked","click .legend-item":"onLegendItemClicked","click #setFilterValueButton":"onFilterValueChanged","change .drop-down":"onFilterValueChanged","change .chzn-select-deselect":"onFilterValueChanged","change .drop-down2":"onListItemClicked","change .drop-down3":"onPeriodChanged","click .grouped-button":"onButtonsetClicked","change .slider-styled":"onStyledSliderValueChanged"},activeFilters:new Array,_sourceDataset:null,_selectedClassName:"info",initialize:function(b){this.el=a(this.el),_.bindAll(this,"render"),_.bindAll(this,"update"),_.bindAll(this,"getFieldType"),_.bindAll(this,"onRemoveFilter"),_.bindAll(this,"onPeriodChanged"),_.bindAll(this,"findActiveFilterByField"),_.bindAll(this,"updateDropdown"),_.bindAll(this,"updateDropdownStyled"),_.bindAll(this,"updateSlider"),_.bindAll(this,"updateSliderStyled"),_.bindAll(this,"updateRadiobuttons"),_.bindAll(this,"updateRangeSlider"),_.bindAll(this,"updateRangeSliderStyled"),_.bindAll(this,"updateRangeCalendar"),_.bindAll(this,"updateMonthWeekCalendar"),_.bindAll(this,"updateDropdownDateRange"),_.bindAll(this,"updateList"),_.bindAll(this,"updateListbox"),_.bindAll(this,"updateListboxStyled"),_.bindAll(this,"updateLegend"),_.bindAll(this,"updateColorLegend"),_.bindAll(this,"updateMultibutton"),_.bindAll(this,"redrawGenericControl"),_.bindAll(this,"fixHierarchicRadiobuttonsSelections"),_.bindAll(this,"changeFilterField"),this._sourceDataset=b.sourceDataset,this.uid=b.id||Math.floor(Math.random()*1e5),this.numId=0,this.sourceFields=b.sourceFields,b.state&&(this.filterDialogTitle=b.state.title,this.filterDialogDescription=b.state.description,this.useHorizontalLayout=b.state.useHorizontalLayout,this.showBackground=b.state.showBackground,this.showBackground==0&&(a(this).removeClass("well"),a(this.el).removeClass("well")),this.backgroundColor=b.state.backgroundColor),this.activeFilters=new Array,this._actions=b.actions;if(this.sourceFields&&this.sourceFields.length)for(var c in this.sourceFields)this.addNewFilterControl(this.sourceFields[c]);this._sourceDataset&&(this._sourceDataset.bind("query:done",this.render),this._sourceDataset.queryState.bind("selection:done",this.update))},areValuesEqual:function(a,b){return typeof a=="undefined"||typeof b=="undefined"?!1:a==b?!0:a&&a.valueOf()==b?!0:b&&a==b.valueOf()?!0:a&&b&&a.valueOf==b.valueOf()?!0:!1},update:function(){var b=this;_.each(this._sourceDataset.queryState.get("selections"),function(a){for(var c in b.activeFilters)b.activeFilters[c].field==a.field&&(b.activeFilters[c].list=a.list,b.activeFilters[c].term=a.term,b.activeFilters[c].start=a.start,b.activeFilters[c].stop=a.stop,b.fixHierarchicRadiobuttonsSelections(b.activeFilters[c]))});var c=this.el.find("div.filter");_.each(c,function(c){var d=a(c).find(".data-control-id");if(typeof d=="undefined"||d==null)var e=a(c).find(".data-control-id-from"),f=a(c).find(".data-control-id-to");var g=null;for(var h in b.activeFilters)if(b.activeFilters[h].ctrlId==c.id){g=b.activeFilters[h];break}if(g!=null){if(g.userChanged){g.userChanged=undefined;return}switch(g.controlType){case"dropdown":return b.updateDropdown(a(c),g,a(d));case"dropdown_styled":return b.updateDropdownStyled(a(c),g,a(d));case"slider":return b.updateSlider(a(c),g,a(d));case"slider_styled":return b.updateSliderStyled(a(c),g,a(d));case"radiobuttons":return b.updateRadiobuttons(a(c),g,a(d));case"hierarchic_radiobuttons":return b.updateHierarchicRadiobuttons(a(c),g,a(d));case"range_slider":return b.updateRangeSlider(a(c),g,a(d));case"range_slider_styled":return b.updateRangeSliderStyled(a(c),g,a(d));case"range_calendar":return b.updateRangeCalendar(a(c),g,a(e),a(f));case"month_week_calendar":return b.updateMonthWeekCalendar(a(c),g,a(d));case"dropdown_date_range":return b.updateDropdownDateRange(a(c),g,a(d));case"list":return b.updateList(a(c),g,a(d));case"listbox":return b.updateListbox(a(c),g,a(d));case"listbox_styled":return b.updateListboxStyled(a(c),g,a(d));case"legend":return b.updateLegend(a(c),g,a(d));case"color_legend":return b.updateColorLegend(a(c),g,a(d));case"multibutton":return b.updateMultibutton(a(c),g,a(d))}}})},computeUserChoices:function(a){var b=a.list;return(typeof b=="undefined"||b==null)&&a.term&&(b=[a.term]),b},redrawGenericControl:function(a,b){var c=this.createSingleFilter(b);a.parent().html(c)},updateDropdown:function(a,b,c){var d=this.computeUserChoices(b);d!=null&&d.length==1?(c[0].style.color="",c.val(d[0])):c.find("option:first").prop("selected","selected"),c.prop("selectedIndex")==0?c.addClass("dimmed"):c.removeClass("dimmed")},updateDropdownStyled:function(a,b,c){this.redrawGenericControl(a,b)},updateSlider:function(b,c,d){var e=this.computeUserChoices(c);e!=null&&e.length==1&&(d.slider("value",e[0]),a("#amount"+c.ctrlId).html(c.label+": "+e[0]),d.trigger("slide",d))},updateSliderStyled:function(a,b,c){var d=this.computeUserChoices(b);d!=null&&d.length==1&&c.jslider("value",d[0])},updateHierarchicRadiobuttons:function(a,b,c){this.redrawGenericControl(a,b)},updateRadiobuttons:function(b,c,d){var e=this.computeUserChoices(c),f=d.find("button.grouped-button");_.each(f,function(b){a(b).removeClass("btn-primary")});if(e!=null&&typeof valuelist!="undefined")if(e.length==1)for(var g=0;g<f.length;g++){var h=a(f[g]);for(var i=0;i<e.length;i++){var j=e[i];if(this.areValuesEqual(j,h.html())){h.addClass("btn-primary");break}}}else e.length==0&&!c.noAllButton&&a(f[0]).addClass("btn-primary");else c.noAllButton||a(f[0]).addClass("btn-primary")},updateRangeSlider:function(b,c,d){var e=this.computeUserChoices(c);e&&e.length==2&&(d.slider("values",0,e[0]),d.slider("values",1,e[1]),a("#amount"+c.ctrlId).html(c.label+": "+e[0]+" - "+e[1]),d.trigger("slide",d))},updateRangeSliderStyled:function(a,b,c){var d=this.computeUserChoices(b);d&&d.length==2&&c.jslider("value",d[0],d[1])},updateRangeCalendar:function(a,b,c,d){this.redrawGenericControl(a,b)},updateMonthWeekCalendar:function(a,b,c){this.redrawGenericControl(a,b)},updateDropdownDateRange:function(a,b,c){this.redrawGenericControl(a,b)},updateList:function(a,b,c){this.redrawGenericControl(a,b)},updateListbox:function(a,b,c){this.redrawGenericControl(a,b)},updateListboxStyled:function(a,b,c){this.redrawGenericControl(a,b)},updateLegend:function(a,b,c){this.redrawGenericControl(a,b)},updateColorLegend:function(a,b,c){this.redrawGenericControl(a,b)},updateMultibutton:function(b,c,d){var e=this.computeUserChoices(c),f=c.selectedClassName||"btn-info",g=d.find("button.grouped-button");_.each(g,function(b){a(b).removeClass(f)});if(e)for(var h=0;h<g.length;h++){var i=a(g[h]);for(var j=0;j<e.length;j++){var k=e[j];this.areValuesEqual(k,i.html())&&i.addClass(f)}}},filterRender:function(){return this.self.createSingleFilter(this)},createSingleFilter:function(a){var b=a.self,c=b.FiltersTemplate[a.controlType],d;if(!c)throw"GenericFilter: Invalid control type "+a.controlType;if(c.needFacetedField){if(!b._sourceDataset.getRecords().length)return;a.facet=b._sourceDataset.getFacetByFieldId(a.field);if(a.facet==null||typeof a.facet=="undefined")throw"GenericFilter: no facet present for field ["+a.field+"]. Define a facet before filter render";if(a.fieldType=="integer"||a.fieldType=="number")a.facet.attributes.terms=_.sortBy(a.facet.attributes.terms,function(a){return a.term});d=a.facet.attributes.terms;if(typeof a.label=="undefined"||a.label==null)a.label=a.field}else!b._sourceDataset;a.useLegend="block",a.labelPosition!="top"&&(a.useLegend="none"),a.useLeftLabel="none",a.labelPosition=="left"&&(a.useLeftLabel="block"),a.labelPosition=="inside"&&(a.innerLabel=a.label),a.values=new Array,a.controlType.indexOf("calendar")>=0&&(a.start&&(a.startDate=b.dateConvert(a.start)),a.stop&&(a.endDate=b.dateConvert(a.stop))),a.controlType.indexOf("slider")>=0&&(d.length>0&&typeof d[0].term!="undefined"?(a.max=d[0].term,a.min=d[0].term):(a.max=100,a.min=0));if(a.controlType=="month_week_calendar"){a.weekValues=[],a.periodValues=[{val:"Months",selected:a.period=="Months"?"selected":""},{val:"Weeks",selected:a.period=="Weeks"?"selected":""}];var e=a.year,f=new Date(e,0,1),g=f.getTime(),h=f.getDay(),i=!1;for(var j=0;j<=53&&!i;j++){var k=g+6048e5*(j-1)+(7-h)*864e5,l=k+6048e5;j==0&&(k=g),(new Date(l)).getFullYear()>e&&(l=(new Date(e+1,0,1)).getTime(),i=!0),a.weekValues.push({val:j+1,label:""+(j+1)+" ["+d3.time.format("%x")(new Date(k))+" -> "+d3.time.format("%x")(new Date(l-1e3))+"]",startDate:new Date(k),stopDate:new Date(l),selected:a.term==j+1?b._selectedClassName:""})}a.monthValues=[];for(m=1;m<=12;m++){var n=e,o=m;m==12&&(n=e+1,o=0),a.monthValues.push({val:d3.format("02d")(m),label:d3.time.format("%B")(new Date(m+"/01/2012"))+" "+e,startDate:new Date(e,m-1,1,0,0,0,0),stopDate:new Date(n,o,1,0,0,0,0),selected:a.term==m?b._selectedClassName:""})}a.period=="Months"?a.values=a.monthValues:a.period=="Weeks"&&(a.values=a.weekValues),a.yearValues=[];var p=2010,n=parseInt(d3.time.format("%Y")(new Date));for(var q=p;q<=n;q++)a.yearValues.push({val:q,selected:a.year==q?"selected":""})}else if(a.controlType=="dropdown_date_range"){a.date_values=[];var r=[{label:"This week",start:"sunday",stop:"next sunday"},{label:"This month",start:"1",delta:{months:1}},{label:"This year",start:"january 1",delta:{years:1}},{label:"Past week",stop:"sunday",delta:{days:-7}},{label:"Past month",stop:"1",delta:{months:-1}},{label:"Past 2 months",stop:"1",delta:{months:-2}},{label:"Past 3 months",stop:"1",delta:{months:-3}},{label:"Past 6 months",stop:"1",delta:{months:-6}},{label:"Past year",stop:"january 1",delta:{years:-1}},{label:"Last 7 days",start:"-6",stop:"t +1 d"},{label:"Last 30 days",start:"-29",stop:"t +1 d"},{label:"Last 90 days",start:"-89",stop:"t +1 d"},{label:"Last 365 days",start:"-1 y",stop:"t +1 d"}],s=r;a.skipDefaultFilters&&(s=[]),a.userFilters&&(s=s.concat(a.userFilters));for(var t in s){var u=s[t],v=null,w=null;u.start&&u.stop?(v=Date.parse(u.start),w=Date.parse(u.stop)):u.start&&u.delta?(v=Date.parse(u.start),v&&(w=new Date(v),w.add(u.delta))):u.stop&&u.delta&&(w=Date.parse(u.stop),w&&(v=new Date(w),v.add(u.delta))),v&&w&&u.label&&a.date_values.push({val:u.label,startDate:v,stopDate:w})}for(var x in a.date_values)if(a.date_values[x].val==a.term){a.date_values[x].selected=b._selectedClassName;break}}else if(a.controlType=="legend"){a.tmpValues=_.pluck(a.facet.attributes.terms,"term"),typeof a.origLegend=="undefined"&&(a.origLegend=a.tmpValues,a.legend=a.origLegend),a.tmpValues=a.origLegend;var y=a.legend;for(var t in a.tmpValues){var z=a.tmpValues[t],A="";if(a.fieldType!="date"&&y.indexOf(z)<0||a.fieldType=="date"&&y.indexOf(z)<0&&y.indexOf((new Date(z)).valueOf())<0)A="not-selected";a.values.push({val:z,notSelected:A,color:a.facet.attributes.terms[t].color,count:a.facet.attributes.terms[t].count})}}else if(a.controlType=="color_legend"){typeof a.showValueLabels=="undefined"&&(a.showValueLabels=!0),a.colorValues=[],a.tmpValues=_.filter(_.pluck(a.facet.attributes.terms,"term"),function(a){return typeof a!="undefined"&&a!=null});var B=document.getElementById("my_string_width_calculation_ruler");if(typeof B=="undefined"||B==null)B=document.createElement("span"),B.setAttribute("id","my_string_width_calculation_ruler"),B.style.visibility="hidden",B.style.width="auto",document.body.appendChild(B);if(a.showValueLabels){var C=b.$el.width()||250;a.lineHeight=40;if(a.fieldType=="float"||a.fieldType=="number"||a.fieldType=="integer")for(var D in a.tmpValues)a.tmpValues[D]=Math.floor(a.tmpValues[D]);a.tmpValues=_.uniq(a.tmpValues);var E=0;for(var t in a.tmpValues){var z=a.tmpValues[t];B.innerHTML=z;var j=B.offsetWidth;j>E&&(E=j)}E+=2;var F=Math.floor(C/E),G=Math.ceil(a.tmpValues.length/F),H=Math.ceil(a.tmpValues.length/G);a.totWidth=H*E,a.totWidth2=a.totWidth+(a.labelPosition=="left"?a.label.length*10:10),a.totHeight=G*a.lineHeight,a.totHeight2=a.totHeight+a.lineHeight;var I=0,J=0;for(var t in a.tmpValues){var z=a.tmpValues[t],K=a.facet.attributes.terms[t].color;J==H&&(I++,J=0),a.colorValues.push({width:E,color:K,textColor:b.complementColor(K),val:z,x:E*J,y:I*a.lineHeight,yplus30:I*a.lineHeight+25}),J++}}else{a.colorValues2=[],a.lineHeight=20,a.minValue=a.tmpValues[0],a.maxValue=a.tmpValues[a.tmpValues.length-1];var C=b.el.width()||250,H=a.tmpValues.length,E=Math.floor(C/H);a.totWidth=H*E,a.totWidth2=a.totWidth+(a.labelPosition=="left"?a.label.length*10:10),a.totHeight=a.lineHeight,a.totHeight2=a.totHeight+a.lineHeight;for(var t in a.tmpValues){var z=a.tmpValues[t],K=a.facet.attributes.terms[t].color;if(t==0||t==a.tmpValues.length-1){isNaN(z)||(z=z.toFixed(2)),B.innerHTML=z;var j=B.offsetWidth;a.colorValues2.push({width:j,color:K,val:z,x:t==0?2:a.totWidth-j-2,y:0,yplus30:15,textColor:b.complementColor(K)})}a.colorValues.push({width:E,color:K,val:"",x:E*t,y:0,yplus30:15})}}}else if(a.controlType=="hierarchic_radiobuttons"){var L=[],M=[],N=1,O=null;a.all1Selected="btn-primary",a.term?O=a.term:typeof a.list!="undefined"&&a.list&&a.list.length==1&&(O=a.list[0]);if(a.term||a.list&&a.list.length<b._sourceDataset.getRecords())a.all1Selected="";_.each(b._sourceDataset.getRecords(),function(c){var d=b._sourceDataset.fields.get(a.field);if(!d)throw"widget.genericfilter: unable to find field ["+a.field+"] in dataset";var e=c.getFieldValue(d),f=c.getFieldValueUnrendered(d),g=c.getFieldShape(d,!1,!1);M.push(e);if(e.indexOf(a.separator)<0)L.push({value:e,valueUnrendered:f,record:c,shape:g});else{var h=e.split(a.separator),i=h[0];_.find(L,function(a){return a.value==i})||(L.push({value:i,valueUnrendered:i,record:null,shape:g}),h.length>N&&(N=h.length))}}),N>1&&(a.useLevel2=!0,a.showLevel2="none",a.all2Selected="btn-primary"),N>2&&(a.useLevel3=!0,a.showLevel3="none",a.all3Selected="btn-primary"),_.each(L,function(c){var d="",e=c.value,f=c.valueUnrendered,g=c.record;O&&O!=""&&b.areValuesEqual(O.split(a.separator)[0],f)&&(d="btn-primary");if(a.useShapeOnly==1){var h=c.shape;h&&h.indexOf("undefined")<0?(T="rel=tooltip title="+e,e="<div class='shape'>"+h+"</div>"):e="<div class='shapeH'>"+e+"</div>"}a.values.push({value:f,val:e,record:g,selected:d,valCount:e,tooltip:T})});if(O&&O!=""){a.valuesLev2=[];var P=O.split(a.separator),Q=_.filter(M,function(b){return b.indexOf(P[0]+a.separator)==0});Q&&Q.length&&(a.showLevel2="block",_.each(Q,function(c){var d="",e=c.split(a.separator),f=e[1],g=f;if(!_.find(a.valuesLev2,function(a){return a.value==f})){var h=null;e.length==2&&(h=_.find(b._sourceDataset.getRecords(),function(d){var e=b._sourceDataset.fields.get(a.field),f=d.getFieldValue(e);return f==c})),b.areValuesEqual(P[0],e[0])&&b.areValuesEqual(P[1],e[1])&&(d="btn-primary",a.all2Selected="");if(a.useShapeOnly==1){var i=h.getFieldShape(field,!1,!1);i&&i.indexOf("undefined")<0?(T="rel=tooltip title="+f,f="<div class='shape'>"+i+"</div>"):f="<div class='shapeH'>"+f+"</div>"}a.valuesLev2.push({value:g,val:f,selected:d,valCount:f,tooltip:T,record:h});if(e.length>=2&&P.length>=2){var j=_.filter(M,function(b){return b.indexOf(P[0]+a.separator+P[1])==0});j&&j.length&&(a.showLevel3="block",a.valuesLev3=[],_.each(j,function(c){var d="",e=c.split(a.separator),f=e[2],g=f;if(!_.find(a.valuesLev3,function(a){return a.value==f})){var h=null;e.length==3&&(h=_.find(b._sourceDataset.getRecords(),function(d){var e=b._sourceDataset.fields.get(a.field),f=d.getFieldValue(e);return f==c})),b.areValuesEqual(O,c)&&(d="btn-primary",a.all2Selected="");if(a.useShapeOnly==1){var i=h.getFieldShape(field,!1,!1);i&&i.indexOf("undefined")<0?(T="rel=tooltip title="+f,f="<div class='shape'>"+i+"</div>"):f="<div class='shapeH'>"+f+"</div>"}a.valuesLev3.push({value:g,val:f,selected:d,valCount:f,tooltip:T,record:h})}}))}}}))}}else{var R=null;a.step=null;if(d)for(var t in d){var S="",T="",z=d[t].term;if(d[t].term){var U=_.find(b._sourceDataset.getRecords(),function(b){return b.attributes[a.field]==d[t].term});if(U){var V=U.fields.get(a.field);V&&(z=U.getFieldValue(V))}}var W=d[t].term,X=z,Y=d[t].count;if(a.controlType=="list")Y>0&&(S=b._selectedClassName);else if(a.controlType=="radiobuttons"){var Z=a.selectedClassName||"btn-primary";if(b.areValuesEqual(a.term,W)||typeof a.list!="undefined"&&a.list&&a.list.length==1&&b.areValuesEqual(a.list[0],W))S=Z;a.useShapeOnly==1&&(d[t].shape&&d[t].shape.indexOf("undefined")<0?(T="rel=tooltip title="+z,z="<div class='shape'>"+d[t].shape+"</div>"):z="<div class='shapeH'>"+z+"</div>")}else if(a.controlType=="multibutton"){var Z=a.selectedClassName||"btn-info";if(b.areValuesEqual(a.term,W))S=Z;else if(typeof a.list!="undefined"&&a.list!=null)for(var x in a.list)b.areValuesEqual(a.list[x],W)&&(S=Z);a.useShapeOnly==1&&(d[t].shape&&d[t].shape.indexOf("undefined")<0?(T="rel=tooltip title="+z,z="<div class='shape'>"+d[t].shape+"</div>"):z="<div class='shapeH'>"+z+"</div>")}else if(a.controlType=="dropdown"||a.controlType=="dropdown_styled"){if(b.areValuesEqual(a.term,W)||typeof a.list!="undefined"&&a.list&&a.list.length==1&&b.areValuesEqual(a.list[0],W))S="selected"}else if(a.controlType=="listbox"||a.controlType=="listbox_styled")if(b.areValuesEqual(a.term,W))S="selected";else if(typeof a.list!="undefined"&&a.list!=null)for(var x in a.list)b.areValuesEqual(a.list[x],W)&&(S="selected");a.showCount?a.values.push({value:W,val:z,selected:S,valCount:z+"	["+Y+"]",count:"["+Y+"]",tooltip:T}):a.values.push({value:W,val:z,selected:S,valCount:z,tooltip:T}),a.controlType.indexOf("slider")>=0&&(z>a.max&&(a.max=z),z<a.min&&(a.min=z),a.controlType.indexOf("styled")>0&&R!=null&&(a.step==null||typeof a.step=="undefined"?a.step=z-R:z-R!=a.step&&(a.step=1))),R=z}else{if(!b._sourceDataset)throw"widget.genericfilter: nor facet or dataset present to build filter";_.each(b._sourceDataset.getRecords(),function(c){var d="",e="",f=b._sourceDataset.fields.get(a.field);if(!f)throw"widget.genericfilter: unable to find field ["+a.field+"] in dataset";var g=c.getFieldValue(f),h=c.getFieldValueUnrendered(f),i=g;if(a.controlType=="radiobuttons"){var j=a.selectedClassName||"btn-primary";if(b.areValuesEqual(a.term,h)||typeof a.list!="undefined"&&a.list&&a.list.length==1&&b.areValuesEqual(a.list[0],h))d=j;if(a.useShapeOnly==1){var k=c.getFieldShape(f,!1,!1);k&&k.indexOf("undefined")<0?(e="rel=tooltip title="+g,g="<div class='shape'>"+k+"</div>"):g="<div class='shapeH'>"+g+"</div>"}}else if(a.controlType=="multibutton"){var j=a.selectedClassName||"btn-info";if(b.areValuesEqual(a.term,h))d=j;else if(typeof a.list!="undefined"&&a.list!=null)for(var l in a.list)b.areValuesEqual(a.list[l],h)&&(d=j);if(a.useShapeOnly==1){var k=c.getFieldShape(f,!1,!1);k&&k.indexOf("undefined")<0?(e="rel=tooltip title="+g,g="<div class='shape'>"+k+"</div>"):g="<div class='shapeH'>"+g+"</div>"}}else if(a.controlType=="dropdown"||a.controlType=="dropdown_styled"){if(b.areValuesEqual(a.term,h)||typeof a.list!="undefined"&&a.list&&a.list.length==1&&b.areValuesEqual(a.list[0],h))d="selected"}else if(a.controlType=="listbox"||a.controlType=="listbox_styled")if(b.areValuesEqual(a.term,h))d="selected";else if(typeof a.list!="undefined"&&a.list!=null)for(var l in a.list)b.areValuesEqual(a.list[l],h)&&(d="selected");a.values.push({value:h,val:g,record:c,selected:d,valCount:g,tooltip:e}),a.controlType.indexOf("slider")>=0&&(g>a.max&&(a.max=g),g<a.min&&(a.min=g),a.controlType.indexOf("styled")>0&&R!=null&&(a.step==null||typeof a.step=="undefined"?a.step=g-R:g-R!=a.step&&(a.step=1))),R=g})}if(a.controlType.indexOf("slider")>=0){typeof a.from=="undefined"&&(a.from=a.min),typeof a.to=="undefined"&&(a.to=a.max),typeof a.term=="undefined"&&(a.term=a.min);if(a.controlType.indexOf("styled")>0)if(a.min%2==0&&a.max%2==0){a.step1=(a.max-a.min)/4+a.min,a.mean=(a.max-a.min)/2,a.step2=(a.max-a.min)*3/4+a.min;if(a.step1!=Math.floor(a.step1)||a.step2!=Math.floor(a.step2))a.step1="|",a.step2="|"}else a.step1="|",a.mean="|",a.step2="|"}}return a.ctrlId=b.uid+"_"+b.numId,b.numId++,Mustache.render(b.filterTemplates[a.controlType],a)},fixHierarchicRadiobuttonsSelections:function(a){var b=this;if(a.controlType=="hierarchic_radiobuttons"&&a.type=="list"&&a.list&&a.list.length>1){var c=a.list[0].split(a.separator);if(c.length>1){var d=c.splice(0,c.length-1).join(a.separator),e=d.length,f=!0,g=b._sourceDataset.getRecords();for(var h in g){var i=g[h],j=b._sourceDataset.fields.get(a.field),k=i.getFieldValue(j);if(k.substring(0,e)===d&&!_.contains(a.list,k)){f=!1;break}}f&&(a.term=d)}}},render:function(){var b=this;console.log("Render "+this._sourceDataset.id+" ["+this._sourceDataset.getRecords().length+"]");var c={filters:this.activeFilters};_.each(c.filters,function(a){a.hrVisible="block",a.self=b}),b._sourceDataset&&(_.each(b._sourceDataset.queryState.get("selections"),function(a){for(var d in c.filters)c.filters[d].field==a.field&&(c.filters[d].list=a.list,c.filters[d].term=a.term,c.filters[d].start=a.start,c.filters[d].stop=a.stop,b.fixHierarchicRadiobuttonsSelections(c.filters[d]))}),c.fields=this._sourceDataset.fields.toJSON()),c.filters.length>0&&(c.filters[c.filters.length-1].hrVisible="none");var d="filtered";b.options.resultType!==null&&(d=b.options.resultType),c.filterDialogTitle=this.filterDialogTitle,c.filterDialogDescription=this.filterDialogDescription,this.filterDialogTitle||this.filterDialogDescription?c.titlePresent="block":c.titlePresent="none",c.dateConvert=b.dateConvert,c.filterRender=b.filterRender;var e=this.template;this.useHorizontalLayout&&(e=this.templateHoriz),b.showBackground==0?(b.className=b.className.replace("well",""),a(b).removeClass("well"),a(b.el).removeClass("well")):(c.backgroundColor=b.backgroundColor,b.showBackground==1&&(b.className.indexOf("well")<0&&(b.className+=" well"),a(b).addClass("well"),a(b.el).addClass("well")));var f=Mustache.render(e,c);this.el.html(f),_.each(c.filters,function(c){if(c.controlType=="hierarchic_radiobuttons"&&c.type=="list"&&c.list&&c.list.length>1){var d;c.ctrlId?d=b.el.find("#"+c.ctrlId):d=this.el.find("div.filter");var e=a(d).find(".data-control-id");b.updateHierarchicRadiobuttons(a(d),c,a(e))}})},complementColor:function(a){var b=a.rgb;return b[0]+b[1]+b[2]<382.5?"white":"black"},onButtonsetClicked:function(b){b.preventDefault();var c=this,d=a(b.currentTarget),e=d.parent().parent(),f=e.attr("data-filter-type"),g=e.attr("data-filter-field"),h=e.attr("data-control-type");if(h=="hierarchic_radiobuttons"){var i=this.findActiveFilterByField(g,h),j=i.selectedClassName||"btn-primary";d.parent().find("button."+j).each(function(){a(this).removeClass
(j)}),d.addClass(j);var k=d.parent().attr("level"),l="";if(k>=2){var m=e.find("div.data-control-id button."+j);l=m.attr("val").valueOf()+i.separator}if(k==3){var n=e.find("div.level2 button."+j);l+=n.attr("val").valueOf()+i.separator}var o=[];d.attr("val")&&d.attr("val").length?o.push(l+d.attr("val").valueOf()):l.length&&o.push(l.substring(0,l.length-1)),i.userChanged=!0;if(o.length==1&&o[0]=="All"&&!i.noAllButton){i.term="",i.showLevel2="none",i.showLevel3="none";var p=this.options.actions;p.forEach(function(a){a.action.doAction(c._sourceDataset.getRecords(),a.mapping)})}else{var q=d.attr("val").valueOf(),r=null;k==1?r=_.find(i.values,function(a){return a.value==q}):k==2?r=_.find(i.valuesLev2,function(a){return a.value==q}):k==3&&(r=_.find(i.valuesLev3,function(a){return a.value==q}));if(r&&r.record){i.term=l+q;if(k==1){var s=e.find("div.level2");if(s.length>0){s[0].style.display="none";var t=e.find("div.level3");t.length&&(t[0].style.display="none")}}else if(k==2){var t=e.find("div.level3");t.length>0&&(t[0].style.display="none")}this.doAction("onButtonsetClicked",g,o,"add",i)}else{i.term=l+q,i.term.length&&i.term[i.term.length-1]==i.separator&&(i.term=i.term.substring(0,i.term.length-1));var u;i.ctrlId?u=c.el.find("#"+i.ctrlId):u=this.el.find("div.filter");var v=a(u).find(".data-control-id");this.updateHierarchicRadiobuttons(a(u),i,a(v)),o=[],_.each(this._sourceDataset.getRecords(),function(a){var b=c._sourceDataset.fields.get(i.field),d=a.getFieldValue(b),e=l+q+i.separator;q==""&&(e=l),d.indexOf(e)==0&&o.push(d)}),this.doAction("onButtonsetClicked",g,o,"add",i)}}}else{var e=d.parent().parent(),f=e.attr("data-filter-type"),g=e.attr("data-filter-field"),h=e.attr("data-control-type"),i=this.findActiveFilterByField(g,h),j=i.selectedClassName||"btn-info";if(h=="multibutton"){d.toggleClass(j);if(i.nullSelectionNotAllowed&&e.find("div.btn-group button."+j).length==0){d.toggleClass(j);return}}else if(h=="radiobuttons"){j=i.selectedClassName||"btn-primary";if(i.allowDeselection){var w=d.hasClass(j);e.find("div.btn-group button."+j).each(function(){a(this).removeClass(j)}),w||d.addClass(j)}else e.find("div.btn-group button."+j).each(function(){a(this).removeClass(j)}),d.addClass(j)}var o=[];e.find("div.btn-group button."+j).each(function(){o.push(a(this).attr("val").valueOf())}),i.userChanged=!0,h=="multibutton"?i.list=o:h=="radiobuttons"&&(o.length==1&&o[0]=="All"&&!i.noAllButton||o.length==0&&i.allowDeselection?(o=[],i.term=""):i.term=d.attr("val").valueOf()),this.doAction("onButtonsetClicked",g,o,"add",i)}},onLegendItemClicked:function(b){b.preventDefault();var c=a(b.currentTarget),d=c.parent().parent().parent().parent().parent(),e=d.attr("data-filter-type"),f=d.attr("data-filter-field"),g=d.attr("data-control-type");c.toggleClass("not-selected");var h=[];d.find("div.legend-item").each(function(){a(this).hasClass("not-selected")||h.push(a(this).attr("myValue").valueOf())});if(h.length>0){var i=this.findActiveFilterByField(f,g);i.userChanged=!0,i.legend=h,this.doAction("onLegendItemClicked",f,h,"add",i)}else c.toggleClass("not-selected")},onListItemClicked:function(b){b.preventDefault();var c=a(b.currentTarget),d,e,f,g;if(c.is("td")){e=c,d=c.parent().parent().parent();var h=d.attr("data-filter-type");h=="range"&&(g=d.parent().parent().find(".drop-down2"))}else c.is("select")&&(g=c,d=g.parent().find(".table"));this.handleListItemClicked(e,d,g,b.ctrlKey)},handleListItemClicked:function(b,c,d,e){var f=c.attr("data-filter-field"),g=c.attr("data-control-type"),h=c.attr("data-filter-type");if(h=="range"&&typeof b=="undefined"){var i=parseInt(d.val());this.findActiveFilterByField(f,g).year=i,this.render()}if(typeof b!="undefined"){e||c.find("tr").each(function(){a(this).removeClass(this._selectedClassName)}),b.parent().addClass(this._selectedClassName);var j=[];h=="list"&&c.find("tr."+this._selectedClassName+" td").each(function(){j.push(a(this).text())});var k=this.findActiveFilterByField(f,g);k.userChanged=!0;if(h=="range"){var i=parseInt(d.val()),l=b.attr("startDate"),m=b.attr("stopDate");k.term=b.attr("myValue"),this.doAction("onListItemClicked",f,[l,m],"add",k)}else h=="list"?this.doAction("onListItemClicked",f,j,"add",k):h=="term"&&this.doAction("onListItemClicked",f,[b.text()],"add",k)}},doAction:function(a,b,c,d,e){var f=this,g=[],h=e.values;e.valuesLev3?h=e.values.concat(e.valuesLev2,e.valuesLev3):e.valuesLev2&&(h=e.values.concat(e.valuesLev2)),_.each(h,function(a){if(a.record){var b=a.record.fields.get(e.field);_.contains(c,a.record.getFieldValueUnrendered(b).toString())&&g.push(a.record)}});var i=this.options.actions;e.facet?i.forEach(function(a){a.action.doActionWithFacets(e.facet.attributes.terms,c,a.mapping,b)}):i.forEach(function(a){a.action.doAction(g,a.mapping)})},dateConvert:function(a){var b=new Date(a);return b.toDateString()},dateConvertBack:function(a){try{var b=a.split(/\D/);return b[2]+"-"+b[0]+"-"+b[1]+" 00:00:00"}catch(c){return a}},onStyledSliderValueChanged:function(b,c){b.preventDefault();var d=a(b.target).parent().parent(),e=d.attr("data-filter-field"),f=d.attr("data-filter-type"),g=d.attr("data-control-type");if(f=="term"){var h=c,i=this.findActiveFilterByField(e,g);i.userChanged=!0,i.term=h,i.list=[h],this.doAction("onStyledSliderValueChanged",e,[h],"add",i)}else if(f=="range"){var i=this.findActiveFilterByField(e,g);i.userChanged=!0;var j=c.split(";"),k=j[0],l=j[1];i.from=k,i.to=l,this.doAction("onStyledSliderValueChanged",e,[k,l],"add",i)}},onFilterValueChanged:function(b){b.preventDefault();var c=a(b.target).parent(),d=c.attr("data-filter-field"),e=c.attr("data-filter-type"),f=c.attr("data-control-type"),g=this.findActiveFilterByField(d,f);g.userChanged=!0;if(e=="term"){var h,i="add",j=c.find(".data-control-id");switch(f){case"term":h=j.val();break;case"slider":h=j.slider("value");break;case"slider_styled":h=j.attr("value"),h==""&&(h=null);break;case"dropdown":case"dropdown_styled":h=j.val(),h==""&&(h=null);break;case"listbox":h=j.val()}g.term=h,h?g.list=[h]:g.list=[null],this.doAction("onFilterValueChanged",d,g.list,i,g)}else if(e=="list"){var k=new Array,l=c.find(".data-control-id")[0];for(var m in l.options)l.options[m].selected&&k.push(l.options[m].value);g.list=k,this.doAction("onFilterValueChanged",d,k,"add",g)}else if(e=="range"){var n,o,p,q=c.find(".data-control-id-from"),r=c.find(".data-control-id-to"),s=c.find(".data-control-id");switch(f){case"range":n=q.val(),o=r.val();break;case"range_slider":n=s.slider("values",0),o=s.slider("values",1);break;case"range_slider_styled":p=s.attr("value").split(";"),n=p[0],o=p[1];break;case"range_calendar":n=new Date(q.val()),o=new Date(r.val());break;case"dropdown_date_range":n=s.find(":selected").attr("startDate"),o=s.find(":selected").attr("stopDate"),g.term=s.val()}g.from=n,g.to=o,this.doAction("onFilterValueChanged",d,[n,o],"add",g)}},onAddFilterShow:function(b){b.preventDefault();var c=a(b.target);c.hide(),this.el.find("div.js-add").show()},hidePanel:function(b){a(function(){b.hide("blind",{},1e3,function(){})})},getFilterTypeFromControlType:function(a){switch(a){case"dropdown":case"dropdown_styled":case"slider":case"slider_styled":case"radiobuttons":return"term";case"range_slider":case"range_slider_styled":case"range_calendar":case"month_week_calendar":case"dropdown_date_range":return"range";case"list":case"listbox":case"listbox_styled":case"legend":case"multibutton":case"hierarchic_radiobuttons":return"list"}return a},getFieldType:function(a){var b=this._sourceDataset.fields.find(function(b){return b.get("id")===a});return typeof b!="undefined"&&b!=null?b.get("type"):"string"},onAddFilter:function(b){b.preventDefault();var c=a(b.target).parent().parent();c.hide();var d=c.find("select.filterType").val(),e=this.getFilterTypeFromControlType(d),f=c.find("select.fields").val();this.addNewFilterControl({type:e,field:f,controlType:d})},addNewFilterControl:function(a){typeof a.type=="undefined"&&(a.type=this.getFilterTypeFromControlType(a.controlType)),typeof a.fieldType=="undefined"&&(a.fieldType=this.getFieldType(a.field));if(a.controlType=="radiobuttons"||a.controlType=="hierarchic_radiobuttons")a.noAllButton&&a.noAllButton==1?a.useAllButton=!1:a.useAllButton=!0;if(a.controlType=="radiobuttons"||a.controlType=="multibutton")a.useShapeOnly=a.useShapeOnly&&a.useShapeOnly==1;a.controlType=="month_week_calendar"&&(typeof a.period=="undefined"&&(a.period="Months"),typeof a.year=="undefined"&&(a.year=(new Date).getFullYear())),this.activeFilters.push(a)},onPeriodChanged:function(b){b.preventDefault();var c=a(b.target).parent().find(".table"),d=c.attr("data-filter-field"),e=c.attr("data-control-type"),f=c.attr("data-filter-type"),g=this.findActiveFilterByField(d,e);g.period=a(b.target).val(),g.term=null,this.render()},findActiveFilterByField:function(a,b){for(var c in this.activeFilters)if(this.activeFilters[c].field==a&&this.activeFilters[c].controlType==b)return this.activeFilters[c];return new Object},changeFilterField:function(a,b){this.activeFilters[a]&&(this.activeFilters[a].field=b)},onRemoveFilter:function(b){b.preventDefault();var c=a(b.target),d=c.parent().parent().attr("data-filter-field"),e=c.parent().parent().attr("data-control-type"),f=this.findActiveFilterByField(d,e);f.term=undefined,f.value=[],f.userChanged=undefined;if(f.controlType=="list"||f.controlType=="month_week_calendar")$table=c.parent().parent().find(".table"),typeof $table!="undefined"&&$table.find("tr").each(function(){a(this).removeClass(this._selectedClassName)});else if(f.controlType=="slider_styled"){var g=c.parent().parent().find(".slider-styled");g.jslider("value",g.jslider().settings.from)}this.doAction("onRemoveFilter",d,[],"remove",f)},composeStateData:function(){var b=this,c="?",d=[];return a.each(b._sourceDataset.queryState.toJSON(),function(a,b){typeof b=="object"&&(b=JSON.stringify(b)),d.push(a+"="+encodeURIComponent(b))}),d}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.MultiButtonDropdownFilter=Backbone.View.extend({template:'<div class="btn-toolbar">         				<div class="btn-group data-control-id">         				{{^noAllButton}}         					<button class="btn btn-mini grouped-button AllButton {{allButtonSelected}}" val="All">All</button>         				{{/noAllButton}}     					{{#buttonsData}}         					{{{buttonRender}}}         				{{/buttonsData}}         			</div>         		</div>',buttonTemplate:'<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}">{{valueLabel}}</button>',dropdownTemplate:'<select id="dropdown{{uid}}_{{numId}}" multiple="multiple">         					{{#options}}         						<option value="{{fullValue}}" {{#selected}}selected="selected"{{/selected}}>{{value}}</option>         					{{/options}}         					</select>',events:{"click .grouped-button":"onButtonsetClicked","click button.select-all-button":"onDropdownSelectAll"},_sourceDataset:null,_selectedClassName:"btn-primary",hasValueChanges:!1,documentClickAssigned:!1,initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","update","onButtonsetClicked","getDropdownSelections","getRecordByValue","handleChangedSelections","onDropdownSelectAll"),this._sourceDataset=b.sourceDataset,this.uid=b.id||Math.floor(Math.random()*1e5),this.numId=0,this.sourceField=b.sourceField,this._actions=b.actions,this.noAllButton=b.sourceField.noAllButton||!1,this.exclusiveButtonValue=b.sourceField.exclusiveButtonValue||(this.noAllButton?undefined:"All"),this.separator=this.sourceField.separator,this._sourceDataset&&(this._sourceDataset.bind("query:done",this.render),this._sourceDataset.queryState.bind("selection:done",this.update)),this.multiSelects=[]},render:function(){var b=this;this.el.html(""),this.numId=0;var c={noAllButton:this.noAllButton};b._sourceDataset&&_.each(b._sourceDataset.queryState.get("selections"),function(a){if(b.sourceField.field=a.field)b.sourceField.list=a.list,b.sourceField.term=a.term}),b.buttonsData={};var d=b._sourceDataset.getRecords();c.allButtonSelected=d&&b.sourceField.list&&d.length==b.sourceField.list.length&&!b.noAllButton;var e=[];_.each(d,function(a){var d=b._sourceDataset.fields.get(b.sourceField.field);if(!d)throw"widget.genericfilter: unable to find field ["+b.sourceField.field+"] in dataset";var f=a.getFieldValue(d),g=a.getFieldValueUnrendered(d);if(!_.contains(e,f)){if(b.separator&&f.indexOf(b.separator)>0){var h=f.split(b.separator,2);b.buttonsData[h[0]]&&b.buttonsData[h[0]].options?b.buttonsData[h[0]].options.push({fullValue:f,value:h[1],record:a,selected:!c.allButtonSelected&&_.contains(b.sourceField.list,f)}):b.buttonsData[h[0]]={self:b,options:[{fullValue:f,value:h[1],record:a,selected:!c.allButtonSelected&&_.contains(b.sourceField.list,f)}]}}else b.buttonsData[g]={value:f,valueUnrendered:g,record:a,selected:!c.allButtonSelected&&_.contains(b.sourceField.list,g),self:b};e.push(f)}}),b.allValues=e,c.buttonsData=_.map(b.buttonsData,function(a,b){return a});for(var f in c.buttonsData)c.buttonsData[f].options&&(c.buttonsData[f].options=_.sortBy(c.buttonsData[f].options,function(a){return a.value}));c.buttonsData=_.sortBy(c.buttonsData,function(a){return a.options?1:b.exclusiveButtonValue&&b.exclusiveButtonValue==a.valueUnrendered?-1:0}),c.buttonRender=b.buttonRender;var g=Mustache.render(this.template,c);this.el.html(g);var h=function(b){var c=a(b.context),d=c.find("option").length;if(b.length==0||b.length==d)return this.mainValue;var e="";for(var f=0;f<4&&f<b.length;f++)e+=a(b[f]).text()+", ";return f<b.length&&(e+="... "+(b.length-f)+" other options  "),this.mainValue+' <span style="opacity:0.5">'+e.substr(0,e.length-2)+"</span>"},i=function(c,d){b.hasValueChanges=!0;var e=c.parent(),f=e.data("multiselect").container,g=c.parent().find("[selected='selected']");g.length?a("button",f).addClass(b._selectedClassName):a("button",f).addClass(b._selectedClassName),b.documentClickAssigned||(a(document).on("click.dropdownbtn",function(c){a("button",f).parent().hasClass("open")||b.handleChangedSelections(!0)}),b.documentClickAssigned=!0)},j,k=null;for(var l in b.buttonsData)k==null&&(k=l),b.buttonsData[l].options&&(j=l);var m=0;b.multiSelects=[];for(var l in b.buttonsData)if(b.buttonsData[l].options){var n=a("#dropdown"+this.uid+"_"+m).multiselect({mainValue:l,buttonClass:"btn btn-mini"+(l==j?" btn-last":""),buttonClassFirst:"btn btn-mini"+(l==k?" btn-first":""),buttonText:h,onChange:i}),o=n.data("multiselect").container;_.find(b.buttonsData[l].options,function(a){return a.selected})&&a("button",o).addClass(b._selectedClassName),b.multiSelects.push(n),m++}},buttonRender:function(){var a=this,b=a.self,c={};return a.options?(c.numId=b.numId,c.uid=b.uid,c.options=a.options,b.numId++,Mustache.render(b.dropdownTemplate,c)):(c.value=a.valueUnrendered,c.valueLabel=a.value,a.selected&&(c.selected=" "+b._selectedClassName+" "),Mustache.render(b.buttonTemplate,c))},update:function(){var b=this;if(b.sourceField.userChanged){b.sourceField.userChanged=!1;return}_.each(b._sourceDataset.queryState.get("selections"),function(a){if(b.sourceField.field=a.field)b.sourceField.list=a.list,b.sourceField.term=a.term});var c=this.computeUserChoices(b.sourceField),d=b._sourceDataset.getRecords();d&&b.sourceField.list&&d.length==b.sourceField.list.length&&!b.noAllButton?b.el.find("div.btn-toolbar button.AllButton").addClass(b._selectedClassName):(b.el.find("div.btn-toolbar button").not(".select-all-button").each(function(){a(this).hasClass("dropdown-toggle")||(_.contains(c,a(this).attr("val"))?(a(this).addClass(b._selectedClassName),c=_.without(c,a(this).attr("val"))):(a(this).removeClass(b._selectedClassName),c=_.without(c,a(this).attr("val"))))}),_.each(b.multiSelects,function(d){_.each(d.find("option"),function(e){_.contains(c,a(e).val())?(a(e).attr("selected","selected"),c=_.without(c,a(e).val())):a(e).removeAttr("selected");var f=d.data("multiselect").container;d.find("option:selected").length?a("button",f).addClass(b._selectedClassName):a("button",f).removeClass(b._selectedClassName)})}))},computeUserChoices:function(a){var b=a.list;return(typeof b=="undefined"||b==null)&&a.term&&(b=[a.term]),b},onButtonsetClicked:function(b){var c=this;b.preventDefault();var d=a(b.currentTarget);!d.hasClass(c._selectedClassName)&&c.exclusiveButtonValue&&(c.exclusiveButtonValue==d.attr("val")?(c.el.find("div.btn-toolbar button."+c._selectedClassName).not(".select-all-button").each(function(){a(this).hasClass("dropdown-toggle")||a(this).removeClass(c._selectedClassName)}),_.each(c.multiSelects,function(b){_.each(b.find("option[selected='selected']"),function(b){a(b).removeAttr("selected")});var d=b.data("multiselect").container;_.each(d.find("button."+c._selectedClassName),function(b){a(b).removeClass(c._selectedClassName)}),b.multiselect("refresh")})):d.parent().find("button.grouped-button[val='"+c.exclusiveButtonValue+"']").removeClass(c._selectedClassName)),d.toggleClass(c._selectedClassName),this.handleChangedSelections()},onDropdownSelectAll:function(b){var c=this;c.hasValueChanges=!0;var d=a(b.currentTarget),e=d.parent().prev("select"),f=e.data("multiselect").container,g=e.find("[selected='selected']"),h=e.find("option");g.length>0&&h.length>g.length||!d.hasClass(c._selectedClassName)?(_.each(h,function(b){a(b).attr("selected","selected")}),a("button",f).addClass(c._selectedClassName)):(_.each(h,function(b){a(b).removeAttr("selected")}),a("button",f).removeClass(c._selectedClassName)),e.multiselect("refresh"),c.handleChangedSelections(!0)},handleChangedSelections:function(b){var c=this;a(document).off("click.dropdownbtn"),c.documentClickAssigned=!1,a("div.btn-toolbar .btngroup-multiselect.open").removeClass("open"),b&&c.el.find("div.btn-toolbar button.grouped-button[val='"+c.exclusiveButtonValue+"']").removeClass(c._selectedClassName);var d=[];c.el.find("div.btn-toolbar button."+c._selectedClassName).not(".select-all-button").each(function(){a(this).hasClass("dropdown-toggle")||d.push(a(this).attr("val").valueOf())}),d.length==1&&d[0]=="All"?d=c.allValues:d=d.concat(c.getDropdownSelections());var e=[];_.each(d,function(a){e.push(c.getRecordByValue(a))}),c.hasValueChanges=!1,c.sourceField.userChanged=!0,c.sourceField.list=d;var f=c.options.actions;f.forEach(function(a){a.action.doAction(e,a.mapping)})},getDropdownSelections:function(){var b=this,c=[];return _.each(b.multiSelects,function(b){_.each(b.find("option[selected='selected']"),function(b){c.push(a(b).val())})}),c},getRecordByValue:function(a){var b=this;if(b.buttonsData[a])return b.buttonsData[a].record;if(b.separator){var c=a.split(b.separator,2);if(b.buttonsData[c[0]]){var d=_.find(b.buttonsData[c[0]].options,function(b){return b.fullValue==a});if(d)return d.record}}return null}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.VisualSearch=Backbone.View.extend({template:'<div id="search_box_container" id="{{uid}}"> </div><div id="search_query">&nbsp;</div>',initialize:function(b){var c=this;this.el=a(this.el),_.bindAll(this,"render","redraw"),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4)},render:function(){var a=this,b=Mustache.render(this.template,this);return this.el.html(b),this},redraw:function(){var b=this;console.log(a().jquery),console.log(a.ui.version),window.visualSearch=VS.init({container:a("#search_box_container"),query:'country: "South Africa" account: 5-samuel "U.S. State": California',showFacets:!0,unquotable:["text","account","filter","access"],callbacks:{search:function(b,c){var d=a("#search_query");d.stop().animate({opacity:1},{duration:300,queue:!1}),d.html('<span class="raquo">&raquo;</span> You searched for: <b>'+c.serialize()+"</b>"),clearTimeout(window.queryHideDelay),window.queryHideDelay=setTimeout(function(){d.animate({opacity:0},{duration:1e3,queue:!1})},2e3)},valueMatches:function(a,b,c){switch(a){case"account":c([{value:"1-amanda",label:"Amanda"},{value:"2-aron",label:"Aron"},{value:"3-eric",label:"Eric"},{value:"4-jeremy",label:"Jeremy"},{value:"5-samuel",label:"Samuel"},{value:"6-scott",label:"Scott"}]);break;case"filter":c(["published","unpublished","draft"]);break;case"access":c(["public","private","protected"]);break;case"title":c(["Pentagon Papers","CoffeeScript Manual","Laboratory for Object Oriented Thinking","A Repository Grows in Brooklyn"]);break;case"city":c(["Cleveland","New York City","Brooklyn","Manhattan","Queens","The Bronx","Staten Island","San Francisco","Los Angeles","Seattle","London","Portland","Chicago","Boston"]);break;case"U.S. State":c(["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia","Florida","Georgia","Guam","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Puerto Rico","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Virgin Islands","Washington","West Virginia","Wisconsin","Wyoming"]);break;case"country":c(["China","India","United States","Indonesia","Brazil","Pakistan","Bangladesh","Nigeria","Russia","Japan","Mexico","Philippines","Vietnam","Ethiopia","Egypt","Germany","Turkey","Iran","Thailand","D. R. of Congo","France","United Kingdom","Italy","Myanmar","South Africa","South Korea","Colombia","Ukraine","Spain","Tanzania","Sudan","Kenya","Argentina","Poland","Algeria","Canada","Uganda","Morocco","Iraq","Nepal","Peru","Afghanistan","Venezuela","Malaysia","Uzbekistan","Saudi Arabia","Ghana","Yemen","North Korea","Mozambique","Taiwan","Syria","Ivory Coast","Australia","Romania","Sri Lanka","Madagascar","Cameroon","Angola","Chile","Netherlands","Burkina Faso","Niger","Kazakhstan","Malawi","Cambodia","Guatemala","Ecuador","Mali","Zambia","Senegal","Zimbabwe","Chad","Cuba","Greece","Portugal","Belgium","Czech Republic","Tunisia","Guinea","Rwanda","Dominican Republic","Haiti","Bolivia","Hungary","Belarus","Somalia","Sweden","Benin","Azerbaijan","Burundi","Austria","Honduras","Switzerland","Bulgaria","Serbia","Israel","Tajikistan","Hong Kong","Papua New Guinea","Togo","Libya","Jordan","Paraguay","Laos","El Salvador","Sierra Leone","Nicaragua","Kyrgyzstan","Denmark","Slovakia","Finland","Eritrea","Turkmenistan"],{preserveOrder:!0})}},facetMatches:function(a){a(["account","filter","access","title",{label:"city",category:"location"},{label:"address",category:"location"},{label:"country",category:"location"},{label:"U.S. State",category:"location"}])}}})},doActions:function(a,b){_.each(a,function(a){a.action.doAction(b,a.mapping)})},getActionsForEvent:function(a){var b=this,c=[];return _.each(b.options.actions,function(b){_.contains(b.event,a)&&c.push(b)}),c}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3Bubble=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"><div id="{{uid}}_graph" class="span11"></div><div class="span1" style="padding-left:30px;"><div id="{{uid}}_legend_color"  style="width:{{color_legend_width}}px;height:{{color_legend_height}}px"></div><div id="{{uid}}_legend_size" style="width:{{size_legend_width}}px;height:{{size_legend_height}}px"></div></div></div>',brushstart:function(){return[]},brushend:function(a){return function(){return a.trigger("zoom",{xRange:a.xRange,yRange:a.yRange}),[]}},brush:function(a){return function(){var b;return b=d3.event.target.extent(),a.xRange=[b[0][0],b[1][0]],a.yRange=[b[0][1],b[1][1]],[]}},xRange:null,yRange:null,initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),a(window).resize(this.resize),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.margin={top:19.5,right:19.5,bottom:19.5,left:50},this.width=b.width-this.margin.right,this.bubbleWidth=this.width*.9,this.legendWidth=this.width*.1,this.height=b.height-this.margin.top-this.margin.bottom,this.options.state.colorLegend&&(this.options.state.colorLegend.margin=this.options.state.colorLegend.margin||[],this.color_legend_width=this.options.state.colorLegend.width+(this.options.state.colorLegend.margin.right||0)+(this.options.state.colorLegend.margin.left||this.options.state.colorLegend.margin.right||0),this.color_legend_height=this.options.state.colorLegend.height+(this.options.state.colorLegend.margin.top||0)+(this.options.state.colorLegend.margin.bottom||this.options.state.colorLegend.margin.top||0)),this.options.state.sizeLegend&&(this.options.state.sizeLegend.margin=this.options.state.sizeLegend.margin||[],this.size_legend_width=this.options.state.sizeLegend.width+(this.options.state.sizeLegend.margin.right||0)+(this.options.state.sizeLegend.margin.left||this.options.state.sizeLegend.margin.right||0),this.size_legend_height=this.options.state.sizeLegend.height+(this.options.state.sizeLegend.margin.top||0)+(this.options.state.sizeLegend.margin.bottom||this.options.state.sizeLegend.margin.top||0)),this.options.state.customTooltipTemplate&&(this.tooltipTemplate=this.options.state.customTooltipTemplate);var c=Mustache.render(this.template,this);this.el.html(c)},render:function(){var a=this,b="#"+this.uid+"_graph",c="#"+this.uid+"_legend_color",d="#"+this.uid+"_legend_size";a.graph&&(jQuery(b).empty(),jQuery(c).empty(),jQuery(d).empty()),a.graph=d3.select(b)},redraw:function(){var a=this;if(!a.visible)return;var b=a.options.state,c;this.options.resultType&&(c=this.options.resultType);var d=[Infinity,-Infinity],e=[Infinity,-Infinity],f=[Infinity,-Infinity],g=[Infinity,-Infinity],h=_.map(this.options.model.getRecords(c),function(c){return b.domains=b.domains||{},d=b.domains.xDomain||[Math.min(d[0],c.attributes[b.xField.field]),Math.max(d[1],c.attributes[b.xField.field])],e=b.domains.yDomain||[Math.min(e[0],c.attributes[b.yField.field]),Math.max(e[1],c.attributes[b.yField.field])],f=b.domains.sizeDomain||[Math.min(f[0],c.attributes[b.sizeField.field]),Math.max(f[1],c.attributes[b.sizeField.field])],g=b.domains.colorDomain||[Math.min(g[0],c.attributes[b.colorField.field]),Math.max(g[1],c.attributes[b.colorField.field])],{key:c.attributes[b.keyField.field],color:c.attributes[b.colorField.field],x:c.attributes[b.xField.field],size:c.attributes[b.sizeField.field],y:c.attributes[b.yField.field],color_formatted:c.getFieldValue(a.model.fields.get(b.colorField.field)),x_formatted:c.getFieldValue(a.model.fields.get(b.xField.field)),y_formatted:c.getFieldValue(a.model.fields.get(b.yField.field)),size_formatted:c.getFieldValue(a.model.fields.get(b.sizeField.field))}});f[0]==f[1]&&(f=[f[0]/2,f[0]*2]),g[0]==g[1]&&(g=[g[0]/2,g[0]*2]),d[0]==d[1]&&(d=[d[0]/2,d[0]*2]),e[0]==e[1]&&(e=[e[0]/2,e[0]*2]),a.xScale=b.xField.scale.domain(d).range([0,a.bubbleWidth]),a.yScale=b.yField.scale.domain(e).range([a.height,0]),a.sizeScale=b.sizeField.scale.domain(f).range([2,20]),a.colorScale=b.colorField.scale.domain(g),b.colorLegend&&a.drawLegendColor(g[0],g[1]),b.sizeLegend&&a.drawLegendSize(f[0],f[1]),a.xAxisTitle=b.xAxisTitle,a.yAxisTitle=b.yAxisTitle,a.colorTitle=b.colorField.label,a.sizeTitle=b.sizeField.label,a.graph=d3.select("#"+a.uid+"_graph"),this.drawD3(h)},drawLegendSize:function(b,c){var d=this,e=d.options.state.sizeLegend,f=d.size_legend_width,g=d.size_legend_height;e.margin=a.extend({top:0,right:0,bottom:0,left:0},e.margin);var h=20,i=e.numElements,j="#"+this.uid+"_legend_size",k=f/2-e.width/2||0,l=e.margin.top||0,m=d3.select(j).append("svg").attr("width",f).attr("height",g),n=d3.range(i),o=[],p=(e.height-h*2-i)/i,q=_.map(n,function(a){return a*(c-b)/(i-1)+b}),r=m.selectAll("circle").data(q);r.enter().append("circle").attr({width:e.width,height:p,cy:function(a,b){var e=d.sizeScale(a),f=d.sizeScale(c);return f*2-e+5},cx:e.margin.left+d.sizeScale(c),r:function(a,b){return d.sizeScale(a)},fill:"none",stroke:"black","stroke-width":"1","stroke-dasharray":"2,2"}),_.map([b,(c-b)/2,c],function(a){return a>1e3?d3.format("s")(Math.round(a)):d3.format(".2f")(a)}),m.selectAll(".label").data(q).enter().append("text").attr("class","y label").attr("text-anchor","middle").attr("y",function(a,b){var e=d.sizeScale(a),f=d.sizeScale(c);return f*2-e*2+10}).attr("x",k+d.sizeScale(c)*4).text(function(a){return a>1e3?d3.format("s")(Math.round(a)):d3.format(".2f")(a)})},drawLegendColor:function(b,c){var d=this,e=d.options.state.colorLegend,f=d.color_legend_width,g=this.color_legend_height;e.margin=a.extend({top:0,right:0,bottom:0,left:0},e.margin);var h=20,i=20,j=e.numElements,k="#"+this.uid+"_legend_color",l=f/2-h/2||0,m=e.margin.top||0,n=d3.select(k).append("svg").attr("width",f).attr("height",g),o=d3.range(j),p=[],q=n.selectAll("rect").data(o),r=(e.height-i*2-j)/j;q.enter().append("rect").attr({width:h,height:r,y:function(a,b){return m+5+b*(r+1)},x:l,fill:function(a,e){return d.colorScale(a*(c-b)/j+b)}});var s=_.map([b,c],function(a){return a>1e3?d3.format("s")(Math.round(a)):d3.format(".2f")(a)});n.selectAll(".label").data(s).enter().append("text").attr("class","y label").attr("text-anchor","middle").attr("y",function(a,b){return(e.height-i)/(s.length-1)*b+i/2}).attr("x",(f/2-e.width/2||0)+e.width/2).text(function(a){return a})},drawD3:function(a){function c(a){return a.x}function d(a){return a.y}function e(a){return a.size}function f(a){return a.color}function g(a){return a.key}function l(a){a.attr("cx",function(a){return b.xScale(c(a))}).attr("cy",function(a){return b.yScale(d(a))}).attr("r",function(a){return b.sizeScale(e(a))})}function m(a,b){return e(b)-e(a)}var b=this,h=d3.svg.axis().orient("bottom").scale(b.xScale).tickFormat(d3.format("s")),i=d3.svg.axis().scale(b.yScale).orient("left").tickFormat(d3.format("s")),j=b.graph.append("svg").attr("width",b.bubbleWidth+b.margin.left+b.margin.right).attr("height",b.height+b.margin.top+b.margin.bottom).append("g").attr("transform","translate("+b.margin.left+","+b.margin.top+")");j.append("g").attr("class","x axis").attr("transform","translate(0,"+b.height+")").call(h),j.append("g").attr("class","y axis").call(i),j.append("text").attr("class","x label").attr("text-anchor","end").attr("x",b.bubbleWidth).attr("y",b.height-6).text(b.xAxisTitle),j.append("text").attr("class","y label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)").text(b.yAxisTitle),j.append("g").attr("class","brush").call(d3.svg.brush().x(b.xScale).y(b.yScale).on("brushstart",b.brushstart).on("brush",b.brush(this)).on("brushend",b.brushend(this)));var k=j.append("g").attr("class","dots").selectAll(".dot").data(a).enter().append("circle").attr("class","dot").style("fill",function(a){return b.colorScale(f(a))}).call(l).sort(m).on("mouseover",b.handleMouseover(b)).on("mouseout",b.mouseout);b.alreadyDrawed=!0},handleMouseover:function(b){return function(c){var d=a(b.el).position(),e=this.getBoundingClientRect(),f=document.body.getBoundingClientRect(),g={left:e.left+e.width/2,top:e.top+e.height/2-f.top},h={title:c.key,dim1Label:b.xAxisTitle,dim1Value:c.x_formatted,dim2Label:b.yAxisTitle,dim2Value:c.y_formatted,dim3Label:b.colorTitle,dim3Value:c.color_formatted,dim4Label:b.sizeTitle,dim4Value:c.size_formatted},i=Mustache.render(b.tooltipTemplate,h),j=a(b.el),k=g.top<j[0].offsetTop+j.height()/2?"n":"s";nv.tooltip.show([g.left,g.top],i,k,null,j[0])}},mouseout:function(){nv.tooltip.cleanup()}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3Bullet=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;">',firstResizeDone:!1,initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw","resize"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),a(window).resize(this.resize),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),b.width?this.width=b.width:this.width="100",b.height?this.height=b.height:this.height="100",this.options.animation||(this.options.animation={duration:2e3,delay:200});var c=Mustache.render(this.template,this);this.el.html(c)},resize:function(){this.firstResizeDone=!0;var b=a("#"+this.uid).height(),c=a("#"+this.uid).width(),d=this.el,e=d.height(),f=d.width();typeof this.options.width=="undefined"&&(a("#"+this.uid).width(f),this.width=
f),typeof this.options.height=="undefined"&&(a("#"+this.uid).height(e),this.height=e),this.redraw()},render:function(){var a=this,b="#"+this.uid;a.graph&&jQuery(b).empty(),a.graph=d3.select(b),a.firstResizeDone||a.resize()},redraw:function(){var a=this,b=this.model.fields.get(this.options.fieldRanges),c=this.model.fields.get(this.options.fieldMeasures),d;this.options.resultType&&(d=this.options.resultType);var e=_.map(this.options.model.getRecords(d),function(b){var c=[];_.each(a.options.fieldRanges,function(d){var e=a.model.fields.get(d);c.push(b.getFieldValueUnrendered(e))});var d=[];_.each(a.options.fieldMeasures,function(c){var e=a.model.fields.get(c);d.push(b.getFieldValueUnrendered(e))});var e=[];return _.each(a.options.fieldMarkers,function(c){var d=a.model.fields.get(c);e.push(b.getFieldValueUnrendered(d))}),{ranges:c,measures:d,markers:e,customTicks:a.options.customTicks}}),f={top:5,right:40,bottom:40,left:40},g=a.width-f.left-f.right,h=a.height-f.top-f.bottom;g<0&&(g=0),h<0&&(h=0),a.plugin(),this.chart=d3.bullet().width(g).height(h),this.drawD3(e,g,h,f)},drawD3:function(a,b,c,d){var e=this;e.graph.selectAll(".bullet").remove(),e.graph.selectAll(".bullet").data(a).enter().append("svg").attr("class","bullet").attr("width",b+d.left+d.right).attr("height",c+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")").call(e.chart),e.alreadyDrawed=!0},plugin:function(){function a(a){return a.customTicks}function b(a){return a.ranges}function c(a){return a.markers}function d(a){return a.measures}function e(a){return function(b){return"translate("+a(b)+",0)"}}function f(a){var b=a(0);return function(c){return Math.abs(a(c)-b)}}d3.bullet=function(){function q(a){a.each(function(a,b){var c=j.call(this,a,b).slice().sort(d3.descending),d=k.call(this,a,b).slice().sort(d3.descending),g=l.call(this,a,b).slice().sort(d3.descending),q=p.call(this,a,b),r=d3.select(this),s=d3.scale.linear().domain([0,Math.max(c[0],d[0],g[0])]).range(h?[m,0]:[0,m]),t=this.__chart__||d3.scale.linear().domain([0,Infinity]).range(s.range());this.__chart__=s;var u=f(t),v=f(s),w=r.selectAll("rect.range").data(c);w.enter().append("rect").attr("class",function(a,b){return"range s"+b}).attr("width",u).attr("height",n).attr("x",h?t:0).transition().duration(i).attr("width",v).attr("x",h?s:0),w.transition().duration(i).attr("x",h?s:0).attr("width",v).attr("height",n);var x=r.selectAll("rect.measure").data(g);x.enter().append("rect").attr("class",function(a,b){return"measure s"+b}).attr("width",u).attr("height",function(a,b){return n/(b*4+3)}).attr("x",h?t:0).attr("y",function(a,b){return(n/3-n/(b*4+3))/2+n/3}).transition().duration(i).attr("width",v).attr("x",h?s:0),x.transition().duration(i).attr("width",v).attr("height",function(a,b){return n/(b*4+3)}).attr("x",h?s:0).attr("y",function(a,b){return(n/3-n/(b*4+3))/2+n/3});var y=r.selectAll("line.marker").data(d);y.enter().append("line").attr("class","marker").attr("x1",t).attr("x2",t).attr("y1",n/6).attr("y2",n*5/6).transition().duration(i).attr("x1",s).attr("x2",s),y.transition().duration(i).attr("x1",s).attr("x2",s).attr("y1",n/6).attr("y2",n*5/6);var z=o||s.tickFormat(8),A=r.selectAll("g.tick").data(s.ticks(8),function(a){return this.textContent||z(a)}),B=A.enter().append("g").attr("class","tick").attr("transform",e(t)).style("opacity",1e-6),C=-1,D=function(){return q&&q[++C]?q[C]:""};B.append("line").attr("y1",n).attr("y2",n*7/6),B.append("text").attr("text-anchor","middle").attr("dy","1em").attr("y",n*7/6).text(q?D:z),B.transition().duration(i).attr("transform",e(s)).style("opacity",1);var E=A.transition().duration(i).attr("transform",e(s)).style("opacity",1);E.select("line").attr("y1",n).attr("y2",n*7/6),E.select("text").attr("y",n*7/6),A.exit().transition().duration(i).attr("transform",e(s)).style("opacity",1e-6).remove()}),d3.timer.flush()}var g="left",h=!1,i=0,j=b,k=c,l=d,m=380,n=30,o=null,p=a;return q.orient=function(a){return arguments.length?(g=a,h=g=="right"||g=="bottom",q):g},q.ranges=function(a){return arguments.length?(j=a,q):j},q.markers=function(a){return arguments.length?(k=a,q):k},q.measures=function(a){return arguments.length?(l=a,q):l},q.width=function(a){return arguments.length?(m=a,q):m},q.height=function(a){return arguments.length?(n=a,q):n},q.tickFormat=function(a){return arguments.length?(o=a,q):o},q.customTicks=function(a){return arguments.length?(p=a,q):p},q.duration=function(a){return arguments.length?(i=a,q):i},q}}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.D3CalendarView=Backbone.View.extend({template:"<style>         	.calendar-view {         	  shape-rendering: crispEdges;         	}         	.calendar-view svg .day {         	  fill: #fff;         	  stroke: #ccc;         	}         	.calendar-view svg  .month {         	  fill: none;         	  stroke: #000;         	  stroke-width: 2px;         	}     		.calendar-view svg.RdYlGn .q0-11{fill:rgb(165,0,38)}     		.calendar-view svg.RdYlGn .q1-11{fill:rgb(215,48,39)}     		.calendar-view svg.RdYlGn .q2-11{fill:rgb(244,109,67)}     		.calendar-view svg.RdYlGn .q3-11{fill:rgb(253,174,97)}     		.calendar-view svg.RdYlGn .q4-11{fill:rgb(254,224,139)}     		.calendar-view svg.RdYlGn .q5-11{fill:rgb(255,255,191)}     		.calendar-view svg.RdYlGn .q6-11{fill:rgb(217,239,139)}     		.calendar-view svg.RdYlGn .q7-11{fill:rgb(166,217,106)}     		.calendar-view svg.RdYlGn .q8-11{fill:rgb(102,189,99)}     		.calendar-view svg.RdYlGn .q9-11{fill:rgb(26,152,80)}     		.calendar-view svg.RdYlGn .q10-11{fill:rgb(0,104,55)}     	</style>",initialize:function(b){var c=this;_.bindAll(this,"render"),this.model=b.model,this.model.bind("query:done",this.render),this.el=b.el,a(this.el).addClass("calendar-view"),this.dateField=b.dateField,this.valueField=b.valueField,this.scaleDomain=b.valueDomain;var d=Mustache.render(this.template,this);a(this.el).html(d)},render:function(){function b(a){return a.getDate?a:Date.parse(a)||Date.parse(a.replace(/\.\d\d\d\+\d+$/,""))||Date.parse(a.split("T")[0])||new Date(a)}var a=this;if(this.model.getRecords().length){var c=960,d=136,e=17,f=d3.time.format("%w"),g=d3.time.format("%U"),h=d3.format(".1%"),i=d3.time.format("%Y-%m-%d"),j=d3.scale.quantize().domain(a.scaleDomain).range(d3.range(11).map(function(a){return"q"+a+"-11"})),k=this.model.getRecords(),l,m;_.each(k,function(c){var d=b(c.attributes[a.dateField]).getFullYear();l?l>d&&(l=d):l=d,m?m<d&&(m=d):m=d});var n=d3.range(l,m);l==m&&(n=[l]);var o=d3.nest().key(function(c){return b(c.attributes[a.dateField]).toString("yyyy-MM-dd")}).rollup(function(b){return b[0].attributes[a.valueField]||0}).map(k);d3.select(this.el).selectAll("svg").data([]).exit().remove();var p=d3.select(this.el).selectAll("svg").data(n).enter().append("svg").attr("width",c).attr("height",d).attr("class","RdYlGn").append("g").attr("transform","translate("+(c-e*53)/2+","+(d-e*7-1)+")");p.append("text").attr("transform","translate(-6,"+e*3.5+")rotate(-90)").style("text-anchor","middle").text(function(a){return a});var q=p.selectAll(".day").data(function(a){return d3.time.days(new Date(a,0,1),new Date(a+1,0,1))}).enter().append("rect").attr("class","day").attr("width",e).attr("height",e).attr("x",function(a){return g(a)*e}).attr("y",function(a){return f(a)*e}).datum(i);q.append("title").text(function(a){return a});function r(a){var b=new Date(a.getFullYear(),a.getMonth()+1,0),c=+f(a),d=+g(a),h=+f(b),i=+g(b);return"M"+(d+1)*e+","+c*e+"H"+d*e+"V"+7*e+"H"+i*e+"V"+(h+1)*e+"H"+(i+1)*e+"V"+0+"H"+(d+1)*e+"Z"}p.selectAll(".month").data(function(a){return d3.time.months(new Date(a,0,1),new Date(a+1,0,1))}).enter().append("path").attr("class","month").attr("d",r),q.filter(function(a){return a in o}).attr("class",function(a){return"day "+j(o[a])}).select("title").text(function(a){return a+": "+o[a]}),d3.select(a.frameElement).style("height",d+"px")}}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3Chord=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"></div>',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.width=b.width,this.height=b.height;var c=Mustache.render(this.template,this);this.el.html(c)},render:function(){var a=this;a.trigger("chart:startDrawing");var b="#"+this.uid;a.graph&&jQuery(b).empty(),a.graph=d3.select(b),a.trigger("chart:endDrawing")},redraw:function(){if(!this.visible)return;var a=this;a.trigger("chart:startDrawing");var b=a.options.state,c;this.options.resultType&&(c=this.options.resultType);var d={},e=[],f=0,g=[],h=this.options.model.fields.get(b.valueField);if(!h)throw"d3.chord.js: unable to fiend field ["+b.valueField+"] in model";_.each(this.options.model.getRecords(c),function(a){var c=d[a.attributes[b.startField]];c==null&&(d[a.attributes[b.startField]]=f,c=f,e[f]=a.attributes[b.startField],f++);var i=d[a.attributes[b.endField]];i==null&&(i=f,d[a.attributes[b.endField]]=f,e[f]=a.attributes[b.endField],f++),g[c]||(g[c]=[]),g[c][i]=a.getFieldValueUnrendered(h)});for(var i=0;i<f;i++)for(var j=0;j<f;j++)g[i]||(g[i]=[]),g[i][j]||(g[i][j]=0);a.graph=d3.select("#"+a.uid),this.drawD3(e,g),a.trigger("chart:endDrawing")},drawD3:function(a,b){function q(a,b){p.classed("fade",function(a){return a.source.index!=b&&a.target.index!=b})}var c=this,d=c.options.state,e=d3.scale.category20(),f=Math.min(c.width,c.height)/2-10,g=f-24,h=d3.format(".1%"),i=d3.svg.arc().innerRadius(g).outerRadius(f),j=d3.layout.chord().padding(.04).sortSubgroups(d3.descending).sortChords(d3.ascending),k=d3.svg.chord().radius(g),l=c.graph.append("svg").attr("width",c.width).attr("height",c.height).append("g").attr("id","circle").attr("transform","translate("+c.width/2+","+c.height/2+")");l.append("circle").attr("r",f),j.matrix(b);var m=l.selectAll(".group").data(j.groups).enter().append("g").attr("class","group").on("mouseover",q);m.append("title").text(function(b,c){return a[c]+": "+h(b.value)+" of origins"});var n=m.append("path").attr("id",function(a,b){return"group"+b}).attr("d",i).style("fill",function(a,b){return e(b)}),o=m.append("text").attr("x",6).attr("dy",15);o.append("textPath").attr("xlink:href",function(a,b){return"#group"+b}).text(function(b,c){return a[c]}),o.filter(function(a,b){return n[0][b].getTotalLength()/2-16<this.getComputedTextLength()}).remove();var p=l.selectAll(".chord").data(j.chords).enter().append("path").attr("class","chord").style("fill",function(a){return e(a.source.index)}).attr("d",k);p.append("title").text(function(b){return a[b.source.index]+" â†’ "+a[b.target.index]+": "+h(b.source.value)+"\n"+a[b.target.index]+" â†’ "+a[b.source.index]+": "+h(b.target.value)}),c.alreadyDrawed=!0}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.D3ChoroplethMap=Backbone.View.extend({rendered:!1,template:'{{#showZoomCtrl}}<input type="range" id="mapZoomCtrl" step="500" min="0" max="30000" value="{{scale}}"     				{{#mapWidth}} width={{mapWidth}}{{/mapWidth}}     				{{#mapHeight}} height={{mapHeight}}{{/mapHeight}}     			  >Zoom</input>{{/showZoomCtrl}}     			  <svg x="0" y="0" xmlns="http://www.w3.org/2000/svg" version="1.1" style="{{svgStyle}}">     			  		<g class="regions"></g>     					<g class="regionLabels" pointer-events="none"></g>     					<g class="places" pointer-events="none"></g>     				</svg>',events:{"change #mapZoomCtrl":"onZoomChanged"},initialize:function(b){var c=this;_.bindAll(this,"render","redraw","getRecordByValue","getActionsForEvent","onZoomChanged","getLabelFor"),this.model.bind("change",c.render),this.model.fields.bind("reset",c.render),this.model.fields.bind("add",c.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.el=b.el,this.unselectedColor="#C0C0C0",this.options.state.unselectedColor&&(this.unselectedColor=this.options.state.unselectedColor),this.mapWidth=this.options.state.width,this.mapHeight=this.options.state.height;var d="";this.options.state.svgStyle&&(d=this.options.state.svgStyle);if(this.mapWidth==null||typeof this.mapWidth=="undefined")this.mapWidth=a(this.el).width();if(this.mapHeight==null||typeof this.mapHeight=="undefined")this.mapHeight=a(this.el).height();this.scale=this.options.state.scale,this.fieldLabels=this.options.state.fieldLabels;var e={scale:this.scale,mapWidth:this.mapWidth,mapHeight:this.mapHeight,svgStyle:d},f=Mustache.render(this.template,e);a(this.el).html(f),this.svg=d3v3.select(this.el+" svg")},getLabelFor:function(a){return this.fieldLabels&&this.fieldLabels[a]?this.fieldLabels[a]:a},render:function(){var b=this,c=this.options.state.mapJson,d=this.options.state.layer,e=this.options.state.showRegionNames,f=this.options.state.showCities,g=this.options.state.randomColors,h=b.options.state.rotation;if(h==null||h=="undefined")h=[0,0];var i=function(){a(b.el+" svg path.region").each(function(){a(this).attr("class",a(this).attr("class").replace(" selected",""))}),a(this).attr("class",a(this).attr("class")+" selected"),d3v3.event.preventDefault()},j=function(){},k=_.filter(this.options.state.mapping,function(a){return a.destLayer==d});if(k.length>1)throw"view.D3.ChoroplethMap.js: more than one field associated with layer, impossible to link with actions";if(k.length==1){var l=b.getActionsForEvent("selection"),m=b.getActionsForEvent("hover"),n=_.filter(l,function(a){return a.mapping.srcField==k.srcShapeField}),o=_.filter(m,function(a){return a.mapping.srcField==k.srcShapeField});n.length&&(i=function(){var a=this.attributes.regionName.nodeValue,c=b.options.state.mapping;c.forEach(function(c){var d=b.getRecordByValue(c.srcShapeField,a);n.forEach(function(a){a.action.doAction([d],a.mapping)})})});var p=function(){};b.options.state.customTooltipTemplate&&(p=function(c){var d=a(b.el).position(),e=this.getBoundingClientRect(),f=document.body.getBoundingClientRect(),g={left:e.left+e.width/2,top:e.top+e.height/2-f.top},h=b.getLabelFor(b.options.state.mapping[0].srcValueField)+":",i=b.getLabelFor(b.options.state.mapping[0].srcShapeField)+":",j=this.attributes.regionName.nodeValue,k=b.getRecordByValue(b.options.state.mapping[0].srcShapeField,j),l="N/A";if(k){var m=b.model.fields.get(b.options.state.mapping[0].srcValueField);m&&(l=k.getFieldValue(m))}if(l.indexOf("N/A")==-1){var n={x:j,y:l,xLabel:i,yLabel:h},o=Mustache.render(b.options.state.customTooltipTemplate,n),p=a(b.el),q=g.top<p[0].offsetTop+p.height()/2?"n":"s";nv.tooltip.show([g.left,g.top],o,q,null,p[0])}});var q=function(){nv.tooltip.cleanup()};o.length?j=function(){var a=this.attributes.regionName.nodeValue,c=b.options.state.mapping;c.forEach(function(c){var d=b.getRecordByValue(c.srcShapeField,a);o.forEach(function(a){a.action.doAction([d],a.mapping)})})}:j=p}return d3v3.json(c,function(a,c){b.mapObj=c;if(c==null||typeof c=="undefined")return;b.regionNames=_.pluck(b.mapObj.objects[d].geometries,"id");var k=topojson.object(c,c.objects[d]),l=d3v3.geo.mercator().center(b.options.state.center).rotate(h).scale(b.scale).translate([b.mapWidth/2,b.mapHeight/2]),m=d3v3.geo.path().projection(l),n=function(){return b.unselectedColor};g&&(n=function(){var a=Math.floor(Math.random()*4+6),b=Math.floor(Math.random()*2)*8;return"#"+a+b+a+b+a+b}),b.svg.select("g.regions").selectAll(".region").data(k.geometries).enter().append("path").on("click",i).on("mouseover",j).on("mouseout",q).attr("class",function(a){return"region "+toAscii(a.id)}).attr("regionName",function(a){return a.id}).attr("fill",n).attr("d",m);if(e){var o=b.options.state.minRegionArea||6,p={geometries:_.filter(c.objects[d].geometries,function(a){return a.properties.Shape_Area>o}),type:"GeometryCollection"};b.svg.select("g.regionLabels").selectAll(".region-label").data(topojson.object(c,p).geometries).enter().append("text").attr("class",function(a){return"region-label "+toAscii(a.id)}).attr("transform",function(a){return"translate("+m.centroid(a)+")"}).attr("regionName",function(a){return a.id}).attr("dy",".35em").text(function(a){return a.id})}c.objects.cities&&f&&(b.svg.select("g.places").append("path").datum(topojson.object(c,c.objects.cities)).attr("d",m).attr("class","place"),b.svg.select("g.places").selectAll(".place-label").data(topojson.object(c,c.objects.cities).geometries).enter().append("text").attr("class","place-label").attr("transform",function(a){return"translate("+l(a.coordinates)+")"}).attr("dy",".35em").attr("dx",".8em").text(function(a){return a.properties.name})),(g==null||typeof g=="undefined")&&b.redraw(),b.rendered=!0}),this},redraw:function(){var a=this;if(!a.rendered||!a.mapObj)return;var b=this.options.state.layer,c=this.options.state.mapping;_.each(c,function(b){var c=a._getDataFor(a.regionNames,b.srcShapeField,b.srcValueField);a.svg.selectAll("path.region").attr("fill",function(){var b=this.attributes.regionName.nodeValue,d=c[b];return d!=null?d.color:a.unselectedColor})})},onZoomChanged:function(b){var c=a(b.currentTarget);this.scale=c.val},_getDataFor:function(a,b,c){var d=this,e="filtered";d.options.useFilteredData!==null&&d.options.useFilteredData===!1&&(e="original");var f=d.model.getRecords(e),g=d.model.fields.get(b),h=d.model.fields.get(c),i=!1;d.model.queryState.isSelected()&&(i=!0);var j={};return g&&h&&_.each(f,function(b){if(_.contains(a,b.getFieldValueUnrendered(g))){var c=d.unselectedColor;if(i)b.isRecordSelected()&&(c=b.getFieldColor(h));else{var e=b.getFieldColor(h);e!=null&&(c=e)}j[b.getFieldValueUnrendered(g)]={record:b,field:h,color:c,value:b.getFieldValueUnrendered(h)}}}),j},getRecordByValue:function(a,b){var c=this,d="filtered";c.options.useFilteredData!==null&&c.options.useFilteredData===!1&&(d="original");var e=c.model.getRecords(d),f=c.model.fields.get(a);return _.find(e,function(a){return a.getFieldValueUnrendered(f)==b})},getActionsForEvent:function(a){var b=this,c=[];return _.each(b.options.actions,function(b){_.contains(b.event,a)&&c.push(b)}),c}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3Cloud=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"></div>',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.margin={top:19.5,right:19.5,bottom:19.5,left:100.5},this.width=b.width-this.margin.right,this.height=b.height-this.margin.top-this.margin.bottom;var c=Mustache.render(this.template,this);this.el.html(c)},render:function(){var a=this;a.trigger("chart:startDrawing");var b="#"+this.uid;a.graph&&jQuery(b).empty(),a.graph=d3.select(b),a.trigger("chart:endDrawing")},redraw:function(){if(!this.visible)return;var a=this;a.trigger("chart:startDrawing");var b=a.options.state,c;this.options.resultType&&(c=this.options.resultType);var d=[Infinity,-Infinity],e=_.map(this.options.model.getRecords(c),function(a){return{key:a.attributes[b.wordField],value:a.attributes[b.dimensionField]}});e=_.sortBy(e,function(a){return-a.value}),d=[e[0].value,e[e.length-1].value],d[0]==d[1]&&(d=[d[0]/2,d[0]*2]),a.graph=d3.select("#"+a.uid),a.domain=d,this.drawD3(e),a.trigger("chart:endDrawing")},drawD3:function(a){var b=this,c=b.options.state,d=d3.scale.log().domain(b.domain).range([20,100]),e="Impact";c.font&&(e="Impact"),c.scale&&(d=c.scale),d3.layout.cloud().size([b.width,b.height]).words(a.map(function(a){return{text:a.key,size:a.value}})).rotate(function(){var a=Math.floor(Math.random()*c.orientations),b=Math.floor(a*(c.angle_end-c.angle_start)/c.orientations+c.angle_start);return b}).font(e).fontSize(function(a){return d(+a.size)}).on("end",b.drawCloud(this)).start(),b.alreadyDrawed=!0},drawCloud:function(a){return function(b){var c=a,d=d3.scale.log().range(["#DEEBF7","#3182BD"]);c.graph.append("svg").attr("width",c.width).attr("height",c.height).append("g").attr("transform","translate("+c.width/2+","+c.height/2+")").selectAll("text").data(b).enter().append("text").style("font-size",function(a){return a.size+"px"}).style("font-family","Impact").style("fill",function(a,b){return d(a.size)}).attr("text-anchor","middle").attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).text(function(a){return a.text})}}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){b.D3CooccurrenceMatrix=Backbone.View.extend({rendered:!1,template:'<svg x="0" y="0" width="{{width}}" height="{{height}}" xmlns="http://www.w3.org/2000/svg" version="1.1" style="margin-left:{{marginLeft}}px">     			<g transform="translate({{marginLeft}}, {{marginTop}})">     		</svg>',defaultTooltipTemplate:"<div> 				<b>Correlation:</b><table> 					<tr><td>Cluster 1: </td><td>{{name1}}</td></tr> 					<tr><td>Cluster 2: </td><td>{{name2}}</td></tr> 					<tr><td>Correlation distance: </td><td>{{value}}</td></tr> 				</table> 			  </div>",events:{},initialize:function(a){var b=this;_.bindAll(this,"render","redraw","computeData"),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.$el=a.el,this.axisField=a.axisField,this.valueField=a.valueField,this.filterField=a.filterField,this.filterValue=a.filterValue,this.series1Field=a.series1Field,this.series2Field=a.series2Field;var c={top:120,right:0,bottom:10,left:120};this.width=this.options.state.width||200,this.height=this.options.state.height||200,this.orderMode=="Cluster",this.options.state.customTooltipTemplate?this.tooltipTemplate=this.options.state.customTooltipTemplate:this.tooltipTemplate=this.defaultTooltipTemplate;var d={width:this.width+c.left+c.right,height:this.height+c.top+c.bottom,marginLeft:c.left,marginTop:c.top},e=Mustache.render(this.template,d);this.$el.html(e),this.svg=d3.select("#"+this.$el[0].id+" svg g")},computeData:function(){var a=this,b=[],c=_.filter(this.model.getRecords(),function(b){return b.attributes[a.filterField]==a.filterValue}),d=_.uniq(_.map(c,function(b){return b.attributes[a.series1Field]})),e=_.uniq(_.map(c,function(b){return b.attributes[a.series2Field]})),f=_.uniq(d.concat(e)),g=[],h=f.length;_.each(f,function(a,c){var d={};d.index=c,d.val=0,d.name=a,b[c]=d3.range(h).map(function(a){return{x:a,y:c,z:0}}),g.push(d)});var i,j;_.each(c,function(c){var d=c.attributes[a.series1Field],e=c.attributes[a.series2Field],f=_.find(g,function(a){return a.name==d}).index,h=_.find(g,function(a){return a.name==e}).index,k=c.attributes[a.valueField];f!=h&&(i?i=k<i?k:i:i=k,j?j=k>j?k:j:j=k),b[f][h].z=k,g[f].val+=k,g[h].val+=k});var k=d3.scale.ordinal().rangeBands([0,this.width]),l=d3.scale.linear().domain([i,j]).clamp(!0),m=d3.scale.category10().domain(d3.range(10)),n={name:d3.range(h).sort(function(a,b){return d3.ascending(g[a].name,g[b].name)}),val:d3.range(h).sort(function(a,b){return g[b].val-g[a].val}),group:d3.range(h).sort(function(a,b){return g[b].group-g[a].group})};return a.orderMode?a.orderMode.toLowerCase().indexOf("cluster")>=0?k.domain(n.group):a.orderMode.toLowerCase().indexOf("name")>=0?k.domain(n.name):a.orderMode.toLowerCase().indexOf("value")>=0&&k.domain(n.val):k.domain(n.group),{matrix:b,nodes:g,x:k,z:l,c:m}},render:function(){function h(a){var b=d3.select(this).selectAll(".cell").data(a.filter(function(a){return a.z})).enter().append("rect").attr("class","cell").attr("x",function(a){return e(a.x)}).attr("width",e.rangeBand()).attr("height",e.rangeBand()).style("fill-opacity",function(a){return f(a.z)}).style("fill",function(a){return d[a.x].group==d[a.y].group?g(d[a.x].group):null}).on("mouseover",j).on("mouseout",k)}function j(b){var c=a.$el.position(),e=this.getBoundingClientRect(),f=document.body.getBoundingClientRect(),g={left:e.left+e.width/2,top:e.top+e.height/2-f.top},h={name1:d[b.x].name,name2:d[b.y].name,value:b.z},i=Mustache.render(a.tooltipTemplate,h),j=a.$el,k=g.top<j[0].offsetTop+j.height()/2?"n":"s";nv.tooltip.show([g.left,g.top],i,k,null,j[0]),d3.selectAll(".row text").classed("active",function(a,c){return c==b.y}),d3.selectAll(".column text").classed("active",function(a,c){return c==b.x})}function k(){nv.tooltip.cleanup(),d3.selectAll("text").classed("active",!1)}var a=this,b=this.computeData(),c=b.matrix,d=b.nodes,e=b.x,f=b.z,g=b.c;this.svg.append("rect").attr("class","background").attr("width",a.width).attr("height",a.height);var h=this.svg.selectAll(".row").data(c).enter().append("g").attr("class","row").attr("transform",function(a,b){return"translate(0,"+e(b)+")"}).each(h);h.append("line").attr("x2",this.width),h.append("text").attr("x",-6).attr("y",e.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(a,b){return d[b].name});var i=this.svg.selectAll(".column").data(c).enter().append("g").attr("class","column").attr("transform",function(a,b){return"translate("+e(b)+")rotate(-90)"});i.append("line").attr("x1",-this.width),i.append("text").attr("x",6).attr("y",e.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(a,b){return d[b].name})},redraw:function(){var a=this,b=this.computeData(),c=b.matrix,d=b.nodes,e=b.x,f=b.z,g=b.c,h=a.svg.transition().duration(200);h.selectAll(".row").delay(function(a,b){return e(b)}).attr("transform",function(a,b){return"translate(0,"+e(b)+")"}).selectAll(".cell").delay(function(a){return e(a.x)}).attr("x",function(a){return e(a.x)}),h.selectAll(".column").delay(function(a,b){return e(b)}).attr("transform",function(a,b){return"translate("+e(b)+")rotate(-90)"})}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3GravityBubble=Backbone.View.extend({template:' 	        <div id="{{uid}}"  style="width: {{width}}px; height: {{height}}px;"> 	        	<div id="{{uid}}_graph" class="span11" ></div> 	        	<div class="span1"> 	        		<div id="{{uid}}_legend_color"  style="width:{{color_legend_width}}px;height:{{color_legend_height}}px;{{#colorMargin}}margin:{{colorMargin}}{{/colorMargin}}"></div> 	        		<div id="{{uid}}_legend_size" style="width:{{size_legend_width}}px;height:{{size_legend_height}}px;{{#sizeMargin}}margin:{{sizeMargin}}{{/sizeMargin}}"></div> 	        	</div> 	        </div>',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),a(window).resize(this.resize),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.margin={top:0,right:0,bottom:0,left:0},this.width=b.width-this.margin.right,this.bubbleWidth=this.width*.9,this.legendWidth=this.width*.1,this.height=b.height-this.margin.top-this.margin.bottom,this.options.state.colorLegend&&(this.options.state.colorLegend.margin=this.options.state.colorLegend.margin||[],this.color_legend_width=this.options.state.colorLegend.width+(this.options.state.colorLegend.margin.right||0)+(this.options.state.colorLegend.margin.left||this.options.state.colorLegend.margin.right||0),this.color_legend_height=this.options.state.colorLegend.height+(this.options.state.colorLegend.margin.top||0)+(this.options.state.colorLegend.margin.bottom||this.options.state.colorLegend.margin.top||0),this.colorMargin=(this.options.state.colorLegend.margin.top||0)+"px "+(this.options.state.colorLegend.margin.right||0)+"px "+(this.options.state.colorLegend.margin.bottom||0)+"px "+(this.options.state.colorLegend.margin.left||0)+"px"),this.options.state.sizeLegend&&(this.options.state.sizeLegend.margin=this.options.state.sizeLegend.margin||[],this.size_legend_width=this.options.state.sizeLegend.width+(this.options.state.sizeLegend.margin.right||0)+(this.options.state.sizeLegend.margin.left||this.options.state.sizeLegend.margin.right||0),this.size_legend_height=this.options.state.sizeLegend.height+(this.options.state.sizeLegend.margin.top||0)+(this.options.state.sizeLegend.margin.bottom||this.options.state.sizeLegend.margin.top||0),this.sizeMargin=(this.options.state.sizeLegend.margin.top||0)+"px "+(this.options.state.sizeLegend.margin.right||0)+"px "+(this.options.state.sizeLegend.margin.bottom||0)+"px "+(this.options.state.sizeLegend.margin.left||0)+"px"),this.options.state.customTooltipTemplate&&(this.tooltipTemplate=this.options.state.customTooltipTemplate);var c=Mustache.render(this.template,this);this.el.html(c)},render:function(){var a=this,b="#"+this.uid+"_graph",c="#"+this.uid+"_legend_color",d="#"+this.uid+"_legend_size";a.graph&&(jQuery(b).empty(),jQuery(c).empty(),jQuery(d).empty()),a.graph=d3.select(b)},redraw:function(){var a=this,b=a.options.state;if(!a.visible)return;var c;this.options.resultType&&(c=this.options.resultType),a.colorDataFormat="number";var d=_.map(this.options.model.getRecords(c),function(c){return b.domains=b.domains||{},c.fields.get(b.colorField.field).attributes.type=="string"&&(a.colorDataFormat="string"),{key:c.attributes[b.keyField.field],color:c.attributes[b.colorField.field],size:c.attributes[b.sizeField.field],color_formatted:c.getFieldValue(a.model.fields.get(b.colorField.field)),size_formatted:c.getFieldValue(a.model.fields.get(b.sizeField.field))}}),e=[d3.min(a.options.model.getRecords(c),function(a){return a.attributes[b.sizeField.field]}),d3.max(a.options.model.getRecords(c),function(a){return a.attributes[b.sizeField.field]})];a.sizeScale=d3.scale.linear().domain(e).range([2,60]).clamp(!0),a.colorDataFormat=="string"?a.colorDomain=_.unique(_.map(a.options.model.getRecords(),function(a){return a.attributes[b.colorField.field]})):a.colorDomain=[d3.min(a.options.model.getRecords(c),function(a){return a.attributes[b.colorField.field]}),d3.max(a.options.model.getRecords(c),function(a){return a.attributes[b.colorField.field]})],a.colorScale=d3.scale.category20().domain(a.colorDomain);var f=_.unique(_.map(a.options.model.getRecords(),function(a){return a.attributes[b.colorField.field]}));a.yAxis=d3.scale.ordinal().domain(f).range([0,a.height]),b.colorLegend&&a.drawLegendColor(),b.sizeLegend&&a.drawLegendSize(e[0],e[1]),a.colorTitle=b.colorField.label,a.sizeTitle=b.sizeField.label,a.graph=d3.select("#"+a.uid+"_graph"),this.drawD3(d)},drawLegendSize:function(b,c){var d=this,e=d.options.state.sizeLegend,f=d.size_legend_width,g=d.size_legend_height;e.margin=a.extend({top:0,right:0,bottom:0,left:0},e.margin);var h=20,i=e.numElements,j="#"+this.uid+"_legend_size",k=f/2-e.width/2||0,l=e.margin.top||0,m=d3.select(j).append("svg").attr("width",f).attr("height",g),n=d3.range(i),o=[],p=(e.height-h*2-i)/i,q=_.map(n,function(a){return a*(c-b)/(i-1)+b}),r=m.selectAll("circle").data(q);r.enter().append("circle").attr({width:e.width,height:p,cy:function(a,b){var e=d.sizeScale(a),f=d.sizeScale(c);return f*2-e+5},cx:e.margin.left+d.sizeScale(c),r:function(a,b){return d.sizeScale(a)},fill:"none",stroke:"black","stroke-width":"1","stroke-dasharray":"2,2"}),_.map([b,(c-b)/2,c],function(a){return a>1e3?d3.format("s")(Math.round(a)):d3.format(".2f")(a)}),m.selectAll(".label").data(q).enter().append("text").attr("class","y label").attr("text-anchor","middle").attr("y",function(a,b){var e=d.sizeScale(a),f=d.sizeScale(c),g=f*2-e*2;return g==0&&(g=20),g}).attr("x",k+d.sizeScale(c)+(d.options.state.sizeLegend.margin.left||0)/2).text(function(a){return a>1e3?d3.format("s")(Math.round(a)):d3.format(".2f")(a)})},drawLegendColor:function(){var b=this,c=b.options.state.colorLegend,d=b.color_legend_width,e=this.color_legend_height;c.margin=a.extend({top:0,right:0,bottom:0,left:0},c.margin);var f=20,g=20,h="#"+this.uid+"_legend_color",i=d/2-f/2||0,j=c.margin.top||0,k=d3.select(h).append("svg").attr("width",d).attr("height",e),l,m,n,o;b.colorDataFormat=="string"?(l=b.colorDomain,m=function(a){return b.colorScale(a)},n=b.colorDomain.length,o=b.colorDomain):(n=c.numElements,l=d3.range(n),m=function(a){return b.colorScale(a*(b.colorDomain[1]-b.colorDomain[0])/n+b.colorDomain[0])},o=_.map([b.colorDomain[0],b.colorDomain[1]],function(a){return a>1e3?
d3.format("s")(Math.round(a)):d3.format(".2f")(a)}));var p=[],q=k.selectAll("rect").data(l),r=(c.height-g*2-n)/n;q.enter().append("rect").attr({width:f,height:r,y:function(a,b){return j+5+b*(r+1)},x:i,fill:function(a,b){return m(a)}}),k.selectAll(".label").data(o).enter().append("text").attr("class","y label").attr("text-anchor",function(){return b.colorDataFormat=="string"?"left":"middle"}).attr("y",function(a,d){return b.colorDataFormat=="string"?j+16+d*(r+1):(c.height-g)/(o.length-1)*d+g/2}).attr("x",function(){return b.colorDataFormat=="string"?i+f:(d/2-c.width/2||0)+c.width/2}).text(function(a){return a})},drawD3:function(a){function d(a){return a.size}function e(a){return a.color}function f(a){return a.key}function t(){function j(a){q.gravity(n).charge(function(a){return m(d(a))}).friction(p).linkStrength(function(a,b){console.log(c+" - "+b)}).on("tick",function(b){a(b.alpha),h.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}).start()}function k(a){q.nodes().forEach(function(b){b.x=b.x+(i.x-b.x)*(o+.02)*a,b.y=b.y+(i.y-b.y)*(o+.02)*a})}q.nodes(a),s=r.append("g").attr("id","circles").selectAll("a").data(q.nodes()),q.nodes().forEach(function(a,c){a.x=Math.random()*g,a.y=b.yAxis(e(a))});var h=s.enter().append("a").append("circle").attr("r",0).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("fill",function(a){return b.colorScale(e(a))}).attr("stroke-width",1).attr("stroke",function(a){return d3.rgb(b.colorScale(e(a))).darker()}).attr("id",function(a){return"post_#"+f(a)}).attr("title",function(a){return f(a)}).on("mouseover",b.handleMouseover(b)).on("mouseout",b.mouseout);s.selectAll("circle").transition().delay(function(a,b){return b*10}).duration(1).attr("r",function(a){return a?b.sizeScale(d(a)):0}),j(k)}var b=this,g=b.width,h=b.height,i={x:(g-(b.margin.left+b.margin.right))/2,y:(h-(b.margin.top+b.margin.bottom))/2},j,k,l,m,n=-0.01,o=.2,p=.8,q=d3.layout.force().linkStrength(function(a,b){console.log(" c,i ["+a+","+b+"]")}).size([g-(b.margin.left+b.margin.right),h-(b.margin.top+b.margin.bottom)]),r=b.graph.append("svg"),s,m=function(a){return-b.sizeScale(a)*b.sizeScale(a)/2.5};t(),b.alreadyDrawed=!0},handleMouseover:function(b){return function(c){var d=a(b.el).position(),e=this.getBoundingClientRect(),f=document.body.getBoundingClientRect(),g={left:e.left+e.width/2,top:e.top+e.height/2-f.top},h={title:c.key,colorLabel:b.colorTitle,colorValue:c.color_formatted,sizeabel:b.sizeTitle,sizeValue:c.size_formatted},i=Mustache.render(b.tooltipTemplate,h),j=a(b.el),k=g.top<j[0].offsetTop+j.height()/2?"n":"s";nv.tooltip.show([g.left,g.top],i,k,null,j[0])}},mouseout:function(){nv.tooltip.cleanup()}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3Sparkline=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"> <div> ',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),a(window).resize(this.resize),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.width=b.width,this.height=b.height,this.options.animation||(this.options.animation={duration:2e3,delay:200});var c=Mustache.render(this.template,this);this.el.html(c)},resize:function(){},render:function(){var a=this,b="#"+this.uid;a.graph&&jQuery(b).empty(),a.graph=d3.select(b).append("svg:svg").attr("width","100%").attr("height","100%").style("stroke",function(){return a.options.color||"steelblue"}).style("stroke-width",1).style("fill","none")},redraw:function(){console.log("redraw");var a=this.model.fields.get(this.options.field),b=_.map(this.options.model.getRecords(this.options.resultType.type),function(b){return b.getFieldValueUnrendered(a)});this.drawD3(b,"#"+this.uid)},drawD3:function(a,b){var c=this,d=d3.scale.linear().domain([0,a.length]).range([0,this.width]),e=d3.scale.linear().domain([_.min(a),_.max(a)]).range([0,this.height]),f=d3.svg.line().x(function(a,b){return d(b)}).y(function(a){return e(a)});c.alreadyDrawed?c.graph.select("path").transition().duration(c.options.animation.duration).delay(c.options.animation.delay).attr("d",f(a)):c.graph.append("svg:path").attr("d",f(a)),c.alreadyDrawed=!0}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict";var c=function(a,b){var c=null;return b.fields.forEach(function(b,d){d==0?c=a.getFieldValue(b):c+=a.getFieldValue(b)}),c},d=c,e=function(a,b){return function(c){if(a.length&&c){var d=d3.event.ctrlKey,e=!d3.select(d3.event.target.parentNode).classed("info");e?d?b.push(c):b=[c]:d?b=_.difference(b,[c]):b=[],a.forEach(function(a){a.action.doAction(b,a.mapping)})}}},f=function(a,b){return function(c){a.length&&c&&(b=[],b.push(c),a.forEach(function(a){a.action.doAction(b,a.mapping)}))}},g=function(){document.body.style.overflow="hidden";var a=document.body.clientWidth;return document.body.style.overflow="scroll",a-=document.body.clientWidth,a||(a=document.body.offsetWidth-document.body.clientWidth),document.body.style.overflow="",a},h=function(a,b){return function(c){var e=c.fields[0].id,f=d3.select(this).classed("g-ascending");d3.selectAll(".g-descending").classed("g-descending",!1),d3.selectAll(".g-ascending").classed("g-ascending",!1);if(!f){d3.select(this).classed("g-ascending",!0);var g=function(a,b){return isNaN(d(a,c))-isNaN(d(b,c))||d(a,c)-d(b,c)||a.index-b.index},h=function(a,b){return b.name.localeCompare(a.name)}}else{d3.select(this).classed("g-descending",!0);var g=function(a,b){return isNaN(d(b,c))-isNaN(d(a,c))||d(b,c)-d(a,c)||b.index-a.index},h=function(a,b){return a.name.localeCompare(b.name)}}d3.selectAll("#"+b+" .g-tbody .g-tr").sort(e==="name"?h:g).each(function(a,b){a.index=b}).transition().delay(function(a,b){return(b-1)*10}).duration(750).attr("transform",function(b,c){return"translate(0,"+c*a+")"})}},i=function(a){var b=d3.select("#"+a.graphId+" .g-tbody-container"),c=a.el.find(".g-thead"),d=d3.select("#"+a.graphId+" .g-tbody"),e=d3.select("#"+a.graphId+" .g-tfoot"),f=0,g=0;return d3.sum(a.columns,function(b,d){var e=c.find(".g-th:nth-child("+(d+1)+")");b.padding_left=parseInt(e.css("padding-left").replace("px","")),b.padding_right=parseInt(e.css("padding-right").replace("px","")),b.computed_width=e.outerWidth(!0),b.fields.forEach(function(a,c){a.width=b.width,a.computed_width=b.computed_width});var g=f;f+=b.computed_width,b.translation=g;if(b.scale){var h=b.scale(a.model.records.models,b.computed_width,b.range||1);b.d3scale=h.scale,b.axisScale=h.axisScale,b.fields.forEach(function(a,c){a.scale=b.d3scale,a.axisScale=b.axisScale[a.id]})}return b.computed_width})};b.D3table=Backbone.View.extend({className:"recline-table-editor",template:'   				<div id="{{graphId}}" class="g-table g-table-hover g-table-striped g-table-bordered">   					<h2 class="g-title">{{title}}</h2>   					<p class="lead">{{instructions}}</p>   					<small>{{summary}}</small>   				  				<div>   				  			',templateHeader:'         			<div class="g-thead">   						<div class="g-tr">   							{{#columns}}   							<div class="g-th {{#sortable}}g-sortable{{/sortable}}" style="width: {{hwidth}}"><div>{{label}}</div></div>   							{{/columns}}   						</div>   					</div>   					  					',templateBody:'   					<div class="g-tbody-container" style="width:{{scrollWidth}}px; height:{{height}}px;">   						<div style="width:{{width}}px;">   							<svg class="g-tbody"> 							</svg> 						</div> 					</div> 					  					',templateFooter:'  					<div class="g-tfoot-container"> 						<svg class="g-tfoot"> 						</svg> 					</div> 										',events:{"click .g-thead":"onEvent"},initialize:function(b){_.defaults(b.conf,{row_height:20,height:200}),b.actions=b.actions||[],this.el=a(this.el),_.bindAll(this,"render","redraw","refresh","resize"),this.rowHeight=b.conf.row_height;var c=[],d=[];b.actions.forEach(function(a){a.event.forEach(function(b){b==="selection"?c.push(a):b==="hover"&&d.push(a)})}),this.clickActions=c,this.hoverActions=d,this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),a(window).resize(this.resize),this.columns=_.map(b.columns,function(a){return _.defaults(a,{label:"",type:"text",sortable:!1,fields:{}})}),this.columns.forEach(function(a,b){a.width=a.width||160,a.hwidth=a.width},this),this.height=b.conf.height,this.title=b.title,this.summary=b.summary,this.instructions=b.instructions,this.graphId=b.id||"d3table_"+Math.floor(Math.random()*1e3);var e=Mustache.render(this.template,this);this.el.html(e),this.el.find("#"+this.graphId).append(Mustache.render(this.templateHeader,this)),this.width=b.conf.width},resize:function(){console.log("resize");var a=d3.select("#"+this.graphId+" .g-tbody-container"),b=d3.select("#"+this.graphId+" .g-tbody"),c=d3.select("#"+this.graphId+" .g-tfoot");this.width=i(this),this.scrollWidth=g()+this.width,this.el.find(".g-tbody-container").css("width",this.scrollWidth),this.el.find(".g-tbody-container > div").css("width",this.width);var d=a.select(".g-tbody").selectAll(".g-tr");d.each(function(a){var b=d3.select(this).selectAll(".g-td").attr("transform",function(a,b){return"translate("+(a.translation+a.padding_left)+")"}),c=b.filter(function(a){return a.scale&&a.type==="barchart"});c.selectAll(".g-bar").attr("width",function(b,c){return b.scale(a.getFieldValue(b))}).attr("transform",function(b,c){var d=Math.ceil(c===0?b.computed_width/2-b.scale(a.getFieldValue(b)):c*b.computed_width/2);return c==0?"translate("+d+")":"translate("+d+")"})}),a.select(".g-tbody").selectAll(".g-column-border").attr("class","g-column-border").attr("transform",function(a){return"translate("+a.translation+",0)"}).attr("y2","100%"),a.select(".g-tbody").selectAll(".g-compare").data(this.columns.filter(function(a){return a.scale})).attr("transform",function(a){return"translate("+(a.translation+a.padding_left+a.computed_width/2)+",0)"}).attr("y2","100%");var e=d3.select("#"+this.graphId+" .g-tfoot"),f=e.selectAll(".g-td").attr("width",function(a,b){return a.computed_width}).attr("transform",function(a,b){return"translate("+(a.translation+a.padding_left)+")"}),h=f.filter(function(a){return a.scale&&a.type==="barchart"});h.selectAll(".g-axis").remove();var j,k;h.selectAll(".g-axis").data(function(a){return j=a.fields.length,k=a.range,a.fields}).enter().append("g").attr("class",function(a,b){return"g-axis"}).attr("transform",function(a,b){var c=0,d=a.computed_width/j;return b==0?c=d-d*k:c=b*d,"translate("+c+")"}).each(function(a,b){var c=d3.svg.axis().scale(a.axisScale).ticks(Math.abs(a.axisScale.range()[1]-a.axisScale.range()[0])/80).orient("bottom");d3.select(this).call(c)})},refresh:function(){console.log("d3Table.refresh")},reset:function(){console.log("d3Table.reset")},render:function(){console.log("d3Table.render"),this.width=i(this),this.scrollWidth=g()+this.width,this.el.find("#"+this.graphId).append(Mustache.render(this.templateBody,this)).append(Mustache.render(this.templateFooter,this)),this.columns.forEach(function(a,b){a.fields=recline.Data.Aggregations.intersectionObjects("id",a.fields,this.model.fields.models),a.index=b},this)},redraw:function(){console.log("d3Table.redraw");var a=this.rowHeight,b=this.columns,c=this.model.records.models,j=[];c.forEach(function(a,b){a.index=b,a.isRecordSelected()&&j.push(a)}),this.width=i(this),this.scrollWidth=g()+this.width;var k=d3.select("#"+this.graphId+" .g-tbody-container");k.select("div").style("height",a*c.length+"px"),k.classed("g-tbody-container-overflow",a*c.length>this.height),k.selectAll(".g-tbody .g-tr").remove();var l=k.select(".g-tbody").selectAll(".g-tr").data(c).enter().append("g").attr("class","g-tr").attr("transform",function(b,c){return"translate(0,"+c*a+")"}).classed("info",function(a,b){return a.isRecordSelected()});l.append("rect").attr("class","g-background").attr("width","100%").attr("height",a).on("click",e(this.clickActions,j)).on("mouseover",f(this.hoverActions,j)),l.each(function(c){var e=d3.select(this).selectAll(".g-td").data(b).enter().append("g").attr("class","g-td").classed("g-quantitative",function(a){return a.scale}).classed("g-categorical",function(a){return a.categorical}).attr("transform",function(a,b){return"translate("+(a.translation+a.padding_left)+")"});d3.select(this).append("line").attr("class","g-row-border").attr("y1",a).attr("y2",a).attr("x2","100%");var f=e.filter(function(a){return a.scale&&a.type==="barchart"});f.selectAll(".g-bar").data(function(a){return a.fields}).enter().append("rect").attr("class","g-bar").attr("width",function(a,b){return a.scale(c.getFieldValue(a))}).attr("height",a-1).attr("transform",function(a,b){var d=Math.ceil(b===0?a.computed_width/2-a.scale(c.getFieldValue(a)):b*a.computed_width/2);return b==0?"translate("+d+")":"translate("+d+")"}).style("fill",function(a,b){return a.color}),e.filter(function(a){return!a.scale}).append("text").attr("class","g-value").attr("x",function(a){return a.scale?3:0}).attr("y",function(a){return a.categorical?9:10}).attr("dy",".35em").classed("g-na",function(a){return d(c,a)===undefined}).text(function(a){return d(c,a)}).attr("clip-path",function(a){return(a.clipped=this.getComputedTextLength()>a.computed_width-20)?"url(#g-clip-cell)":null}),e.filter(function(a){return a.clipped}).append("rect").style("fill","url(#g-clip-gradient)").attr("x",function(a){return a.hwidth}).attr("width",20).attr("height",a)});var m=d3.select("#"+this.graphId+" .g-tfoot");m.selectAll(".axisRow").remove();var n=m.append("g").attr("class","axisRow"),o=n.selectAll(".g-td").data(b).enter().append("g").attr("class","g-td").attr("width",function(a,b){return a.computed_width}).attr("transform",function(a,b){return"translate("+(a.translation+a.padding_left)+")"}),p=o.filter(function(a){return a.scale&&a.type==="barchart"}),q,r;p.selectAll(".g-axis").data(function(a){return q=a.fields.length,r=a.range,a.fields}).enter().append("g").attr("class",function(a,b){return"g-axis"}).attr("transform",function(a,b){var c=0,d=a.computed_width/q;return b==0?c=d-d*r:c=b*d,"translate("+c+")"}).each(function(a,b){var c=d3.svg.axis().scale(a.axisScale).ticks(Math.abs(a.axisScale.range()[1]-a.axisScale.range()[0])/80).orient("bottom");d3.select(this).call(c)}),d3.selectAll("#"+this.graphId+" .g-thead .g-th.g-sortable").data(b).on("click",h(a,this.graphId)),k.select(".g-tbody").selectAll(".g-column-border").remove(),k.select(".g-tbody").selectAll(".g-column-border").data(b).enter().append("line").attr("class","g-column-border").attr("transform",function(a){return"translate("+a.translation+",0)"}).attr("y2","100%"),k.select(".g-tbody").selectAll(".g-compare").remove(),k.select(".g-tbody").selectAll(".g-compare").data(b.filter(function(a){return a.scale})).enter().append("line").attr("class","g-compare").attr("transform",function(a){return"translate("+(a.translation+a.padding_left+a.computed_width/2)+",0)"}).attr("y2","100%")},onEvent:function(a){}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(a,b){"use strict",b.D3Treemap=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"> <div> ',initialize:function(b){this.el=a(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),a(window).resize(this.resize),this.uid=b.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.width=b.width,this.height=b.height,this.options.animation||(this.options.animation={duration:2e3,delay:200});var c=Mustache.render(this.template,this);this.el.html(c)},resize:function(){},render:function(){var a=this,b="#"+this.uid;a.graph&&jQuery(b).empty(),a.treemap=d3.layout.treemap().size([this.width,this.height]).sticky(!1).value(function(a){return console.log(a),a.size}),a.color=d3.scale.category20c(),a.div=d3.select(b).append("div").style("position","relative").style("width",this.width+"px").style("height",this.height+"px")},redraw:function(){console.log("redraw");var a=this.model.fields.get(this.options.fieldValue),b=this.model.fields.get(this.options.fieldName),c=_.map(this.options.model.getRecords(this.options.resultType.type),function(c){return{name:c.getFieldValue(b),size:c.getFieldValueUnrendered(a)}});this.drawD3(c,"#"+this.uid)},drawD3:function(a,b){function d(){this.style("left",function(a){return a.x+"px"}).style("top",function(a){return a.y+"px"}).style("width",function(a){return Math.max(0,a.dx-1)+"px"}).style("height",function(a){return Math.max(0,a.dy-1)+"px"})}var c=this,e=c.treemap(a);_.each(a,function(a){c.div.data([a]).selectAll("div").data(c.treemap.nodes).enter().append("div").attr("class","cell").style("background",function(a){c.color(a.name)}).call(d).text(function(a){return console.log(a),a.name})}),c.alreadyDrawed=!0}})}(jQuery,recline.View);