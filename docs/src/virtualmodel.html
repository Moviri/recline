<!DOCTYPE html>  <html> <head>   <title>virtualmodel.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="action.html">                 action.js               </a>                                           <a class="source" href="backend.ckan.html">                 backend.ckan.js               </a>                                           <a class="source" href="backend.couchdb.html">                 backend.couchdb.js               </a>                                           <a class="source" href="backend.csv.html">                 backend.csv.js               </a>                                           <a class="source" href="backend.dataproxy.html">                 backend.dataproxy.js               </a>                                           <a class="source" href="backend.elasticsearch.html">                 backend.elasticsearch.js               </a>                                           <a class="source" href="backend.gdocs.html">                 backend.gdocs.js               </a>                                           <a class="source" href="backend.jsonp.html">                 backend.jsonp.js               </a>                                           <a class="source" href="backend.memory.html">                 backend.memory.js               </a>                                           <a class="source" href="backend.solr.html">                 backend.solr.js               </a>                                           <a class="source" href="data.aggregations.html">                 data.aggregations.js               </a>                                           <a class="source" href="data.colors.html">                 data.colors.js               </a>                                           <a class="source" href="data.fieldsutilities.html">                 data.fieldsutilities.js               </a>                                           <a class="source" href="data.filters.html">                 data.filters.js               </a>                                           <a class="source" href="data.formatters.html">                 data.formatters.js               </a>                                           <a class="source" href="data.shapes.html">                 data.shapes.js               </a>                                           <a class="source" href="data.statemanagement.html">                 data.statemanagement.js               </a>                                           <a class="source" href="data.transform.html">                 data.transform.js               </a>                                           <a class="source" href="ecma-fixes.html">                 ecma-fixes.js               </a>                                           <a class="source" href="joinedmodel.html">                 joinedmodel.js               </a>                                           <a class="source" href="model.html">                 model.js               </a>                                           <a class="source" href="template.shapes.html">                 template.shapes.js               </a>                                           <a class="source" href="view.graph.html">                 view.graph.js               </a>                                           <a class="source" href="view.grid.html">                 view.grid.js               </a>                                           <a class="source" href="view.indicator.html">                 view.indicator.js               </a>                                           <a class="source" href="view.kartograph.html">                 view.kartograph.js               </a>                                           <a class="source" href="view.map.html">                 view.map.js               </a>                                           <a class="source" href="view.multiview.html">                 view.multiview.js               </a>                                           <a class="source" href="view.nvd3.graph.html">                 view.nvd3.graph.js               </a>                                           <a class="source" href="view.rickshaw.html">                 view.rickshaw.js               </a>                                           <a class="source" href="view.slickgrid.html">                 view.slickgrid.js               </a>                                           <a class="source" href="view.timeline.html">                 view.timeline.js               </a>                                           <a class="source" href="view.transform.html">                 view.transform.js               </a>                                           <a class="source" href="virtualmodel.html">                 virtualmodel.js               </a>                                           <a class="source" href="widget.currentfilter.html">                 widget.currentfilter.js               </a>                                           <a class="source" href="widget.facetviewer.html">                 widget.facetviewer.js               </a>                                           <a class="source" href="widget.fields.html">                 widget.fields.js               </a>                                           <a class="source" href="widget.filtereditor.html">                 widget.filtereditor.js               </a>                                           <a class="source" href="widget.genericfilter.html">                 widget.genericfilter.js               </a>                                           <a class="source" href="widget.pager.html">                 widget.pager.js               </a>                                           <a class="source" href="widget.queryeditor.html">                 widget.queryeditor.js               </a>                                           <a class="source" href="widget.visualsearch.html">                 widget.visualsearch.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               virtualmodel.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Recline Backbone Models</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nx">recline</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">recline</span> <span class="o">||</span> <span class="p">{};</span>
<span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Model</span> <span class="o">||</span> <span class="p">{};</span>
<span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">VirtualDataset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">VirtualDataset</span> <span class="o">||</span> <span class="p">{};</span>


<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">my</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2><a id="dataset">VirtualDataset</a></h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">my</span><span class="p">.</span><span class="nx">VirtualDataset</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">constructor</span><span class="o">:</span><span class="kd">function</span> <span class="nx">VirtualDataset</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">},</span>


        <span class="nx">initialize</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">);</span>


            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">backend</span> <span class="o">=</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Backend</span><span class="p">.</span><span class="nx">Memory</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">FieldList</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">RecordList</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">facets</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">FacetList</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">recordCount</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">queryState</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">Query</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;initialState&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;initialState&#39;</span><span class="p">).</span><span class="nx">setState</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;query:done&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">initializeCrossfilter</span><span class="p">();</span>
            <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>this.attributes.dataset.records.bind('add',     function() { self.initializeCrossfilter(); });
this.attributes.dataset.records.bind('reset',   function() { self.initializeCrossfilter(); });</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
            <span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;selection:change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">selection</span><span class="p">();</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>dataset is already been fetched</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">initializeCrossfilter</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TODO verify if is better to use a new backend (crossfilter) to manage grouping and filtering instead of using it inside the model
TODO OPTIMIZATION use a structure for the reduce function that doesn't need any translation to records/arrays
TODO USE crossfilter as backend memory</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">},</span>

        <span class="nx">getRecords</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;filtered&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;totals&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">totals</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">rebuildTotals</span><span class="p">();</span>

                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">totals</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;totals_unfiltered&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">totals_unfiltered</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">rebuildUnfilteredTotals</span><span class="p">();</span>

                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">totals_unfiltered</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_store</span><span class="p">.</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="s2">&quot;VirtualModel: unable to retrieve not filtered data, store can&#39;t provide data. Use a backend that use memory store&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kd">var</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_store</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">_doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">Record</span><span class="p">(</span><span class="nx">hit</span><span class="p">);</span>
                    <span class="nx">_doc</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nx">_doc</span><span class="p">;</span>
                <span class="p">});</span>

                <span class="k">return</span> <span class="nx">docs</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">getField_byAggregationFunction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resultType</span><span class="p">,</span> <span class="nx">fieldName</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFields</span><span class="p">(</span><span class="nx">resultType</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">fieldName</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">aggr</span><span class="p">);</span>
        <span class="p">},</span>


        <span class="nx">getFields</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;filtered&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;totals&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">totals</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">rebuildTotals</span><span class="p">();</span>

                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">totals</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;totals_unfiltered&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">totals</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">rebuildUnfilteredTotals</span><span class="p">();</span>

                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">totals_unfiltered</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">initializeCrossfilter</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">aggregatedFields</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">measures</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">aggregationFunctions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">aggregationFunctions</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">originalFields</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">dimensions</span> <span class="o">=</span>  <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">partitions</span> <span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">partitions</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">crossfilterData</span> <span class="o">=</span> <span class="nx">crossfilter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">toFullJSON</span><span class="p">());</span>
            <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createDimensions</span><span class="p">(</span><span class="nx">crossfilterData</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span><span class="nx">dimensions</span><span class="p">,</span><span class="nx">aggregatedFields</span><span class="p">,</span><span class="nx">aggregationFunctions</span><span class="p">,</span><span class="nx">partitions</span><span class="p">);</span>



            <span class="k">this</span><span class="p">.</span><span class="nx">updateStore</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span><span class="nx">dimensions</span><span class="p">,</span><span class="nx">aggregationFunctions</span><span class="p">,</span><span class="nx">aggregatedFields</span><span class="p">,</span><span class="nx">partitions</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">setDimensions</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">dimensions</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">dimensions</span> <span class="o">=</span> <span class="nx">dimensions</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;dimensions:change&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">initializeCrossfilter</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">getDimensions</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">dimensions</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">createDimensions</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">crossfilterData</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">group</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">dimensions</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>need to evaluate aggregation function on all records</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">group</span> <span class="o">=</span> <span class="nx">crossfilterData</span><span class="p">.</span><span class="nx">groupAll</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">by_dimension</span> <span class="o">=</span> <span class="nx">crossfilterData</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dimensions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">tmp</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">tmp</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="nx">dimensions</span><span class="p">[</span><span class="nx">i</span><span class="p">]].</span><span class="nx">valueOf</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">tmp</span><span class="p">;</span>
                <span class="p">});</span>
                <span class="nx">group</span> <span class="o">=</span> <span class="nx">by_dimension</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">group</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">reduce</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">,</span> <span class="nx">aggregatedFields</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="nx">partitions</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">aggregationFunctions</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;Error aggregationFunctions parameters is not set for virtual dataset &quot;</span><span class="p">);</span>


            <span class="kd">var</span> <span class="nx">partitioning</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">partitionFields</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">partitions</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">partitioning</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">addFunction</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">p</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">aggregatedFields</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>for each aggregation function evaluate results</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">currentAggregationFunction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>

                        <span class="nx">p</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">aggregatedFields</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span>
                            <span class="nx">currentAggregationFunction</span><span class="p">(</span>
                                <span class="nx">p</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">aggregatedFields</span><span class="p">[</span><span class="nx">i</span><span class="p">]],</span>
                                <span class="nx">v</span><span class="p">[</span><span class="nx">aggregatedFields</span><span class="p">[</span><span class="nx">i</span><span class="p">]]);</span>
                    <span class="p">}</span>


                    <span class="k">if</span> <span class="p">(</span><span class="nx">partitioning</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>for each partition need to verify if exist a value of aggregatefield<em>by</em>partition_partitionvalue</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">partitions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">partitionName</span> <span class="o">=</span> <span class="nx">partitions</span><span class="p">[</span><span class="nx">x</span><span class="p">];</span>
                            <span class="kd">var</span> <span class="nx">partitionValue</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">x</span><span class="p">]];</span>
                            <span class="kd">var</span> <span class="nx">aggregatedField</span> <span class="o">=</span> <span class="nx">aggregatedFields</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                            <span class="kd">var</span> <span class="nx">fieldName</span> <span class="o">=</span> <span class="nx">aggregatedField</span> <span class="o">+</span> <span class="s2">&quot;_by_&quot;</span> <span class="o">+</span> <span class="nx">partitionName</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">partitionValue</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>for each aggregation function evaluate results</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

                                <span class="k">if</span> <span class="p">(</span><span class="nx">partitionFields</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                                    <span class="nx">partitionFields</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{};</span>

                                <span class="kd">var</span> <span class="nx">currentAggregationFunction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>

                                <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">fieldName</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">fieldName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="nx">value</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
                                        <span class="nx">partition</span><span class="o">:</span><span class="nx">partitionValue</span><span class="p">,</span>
                                        <span class="nx">originalField</span><span class="o">:</span><span class="nx">aggregatedField</span><span class="p">,</span>
                                        <span class="nx">aggregationFunction</span><span class="o">:</span><span class="nx">currentAggregationFunction</span><span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>populate partitions description</p>             </td>             <td class="code">               <div class="highlight"><pre>                                    <span class="nx">partitionFields</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">fieldName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="nx">field</span><span class="o">:</span><span class="nx">partitionName</span><span class="p">,</span>
                                        <span class="nx">value</span><span class="o">:</span><span class="nx">partitionValue</span><span class="p">,</span>
                                        <span class="nx">originalField</span><span class="o">:</span><span class="nx">aggregatedField</span><span class="p">,</span>
                                        <span class="nx">aggregationFunction</span><span class="o">:</span><span class="nx">currentAggregationFunction</span><span class="p">,</span>
                                        <span class="nx">aggregationFunctionName</span><span class="o">:</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span>
                                        <span class="nx">id</span><span class="o">:</span><span class="nx">fieldName</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
                                    <span class="p">};</span> <span class="c1">// i need partition name but also original field value</span>
                                <span class="p">}</span>
                                <span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">fieldName</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span>
                                    <span class="nx">currentAggregationFunction</span><span class="p">(</span>
                                        <span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]][</span><span class="nx">fieldName</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
                                        <span class="nx">v</span><span class="p">[</span><span class="nx">aggregatedFields</span><span class="p">[</span><span class="nx">i</span><span class="p">]]);</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">.</span><span class="nx">count</span><span class="p">[</span><span class="nx">fieldName</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">.</span><span class="nx">count</span><span class="p">[</span><span class="nx">fieldName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="nx">value</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="nx">partition</span><span class="o">:</span><span class="nx">partitionValue</span><span class="p">,</span>
                                    <span class="nx">originalField</span><span class="o">:</span><span class="nx">aggregatedField</span><span class="p">,</span>
                                    <span class="nx">aggregationFunction</span><span class="o">:</span><span class="s2">&quot;count&quot;</span>
                                <span class="p">};</span>
                            <span class="p">}</span>
                            <span class="k">else</span>
                                <span class="nx">p</span><span class="p">.</span><span class="nx">partitions</span><span class="p">.</span><span class="nx">count</span><span class="p">[</span><span class="nx">fieldName</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>


                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">removeFunction</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="s2">&quot;crossfilter reduce remove function not implemented&quot;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">initializeFunction</span><span class="p">()</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>

                <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tmp</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">initFunctions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]](</span><span class="nx">tmp</span><span class="p">,</span> <span class="nx">aggregatedFields</span><span class="p">,</span> <span class="nx">partitions</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">partitioning</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tmp</span><span class="p">[</span><span class="s2">&quot;partitions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="nx">tmp</span><span class="p">[</span><span class="s2">&quot;partitions&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

                    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">tmp</span><span class="p">[</span><span class="s2">&quot;partitions&quot;</span><span class="p">][</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="p">}</span>

                    <span class="cm">/*_.each(partitions, function(p){</span>
<span class="cm">                     tmp.partitions.list[p] = 0;</span>
<span class="cm">                     });*/</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">tmp</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">reducedGroup</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">addFunction</span><span class="p">,</span> <span class="nx">removeFunction</span><span class="p">,</span> <span class="nx">initializeFunction</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">tmpResult</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">dimensions</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">tmpResult</span> <span class="o">=</span> <span class="p">[</span><span class="nx">reducedGroup</span><span class="p">.</span><span class="nx">value</span><span class="p">()];</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">tmpResult</span> <span class="o">=</span> <span class="nx">reducedGroup</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span><span class="nx">reducedResult</span><span class="o">:</span><span class="nx">tmpResult</span><span class="p">,</span>
                <span class="nx">partitionFields</span><span class="o">:</span><span class="nx">partitionFields</span><span class="p">};</span>

        <span class="p">},</span>

        <span class="nx">updateStore</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="nx">aggregatedFields</span><span class="p">,</span> <span class="nx">partitions</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">reducedResult</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">reducedResult</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">partitionFields</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">partitionFields</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">partitionFields</span> <span class="o">=</span> <span class="nx">partitionFields</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buildFields</span><span class="p">(</span><span class="nx">reducedResult</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="nx">partitionFields</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buildResult</span><span class="p">(</span><span class="nx">reducedResult</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="nx">partitionFields</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="nx">aggregatedFields</span><span class="p">,</span> <span class="nx">partitions</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Backend</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>

            <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">FieldsUtility</span><span class="p">.</span><span class="nx">setFieldsAttributes</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="p">{</span><span class="nx">renderer</span><span class="o">:</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Renderers</span><span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">clearUnfilteredTotals</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>

        <span class="p">},</span>

        <span class="nx">rebuildTotals</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_rebuildTotals</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="p">},</span>
        <span class="nx">rebuildUnfilteredTotals</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_rebuildTotals</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_store</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">clearUnfilteredTotals</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">totals_unfiltered</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
           <span class="k">this</span><span class="p">.</span><span class="nx">clearFilteredTotals</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">clearFilteredTotals</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">totals</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
       <span class="p">},</span>

        <span class="nx">_rebuildTotals</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">records</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="nx">filtered</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">                totals: {</span>
<span class="cm">                    aggregationFunctions:[&quot;sum&quot;],</span>
<span class="cm">                    aggregatedFields: [&quot;fielda&quot;]</span>
<span class="cm">                    }</span>
<span class="cm">            */</span>
            <span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">aggregatedFields</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">totals</span><span class="p">.</span><span class="nx">measures</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">aggregationFunctions</span> <span class="o">=</span>  <span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">totals</span><span class="p">.</span><span class="nx">aggregationFunctions</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">rectmp</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">records</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">==</span> <span class="nb">Array</span><span class="p">)</span>
                <span class="nx">rectmp</span> <span class="o">=</span> <span class="nx">records</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="nx">rectmp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">records</span><span class="p">.</span><span class="nx">models</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;})</span> <span class="p">;</span>

            <span class="kd">var</span> <span class="nx">crossfilterData</span> <span class="o">=</span>  <span class="nx">crossfilter</span><span class="p">(</span><span class="nx">rectmp</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createDimensions</span><span class="p">(</span><span class="nx">crossfilterData</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span><span class="nx">aggregatedFields</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buildFields</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">reducedResult</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buildResult</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">reducedResult</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="nx">aggregatedFields</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>I need to apply table calculations</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">tableCalc</span> <span class="o">=</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">checkTableCalculation</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">totals</span><span class="p">);</span>

                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">tableCalc</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">p</span><span class="p">;</span>
                    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">rectmp</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">p</span> <span class="o">=</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">tableCalculations</span><span class="p">[</span><span class="nx">f</span><span class="p">](</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">measures</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                    <span class="p">});</span>
                <span class="p">});</span>

            <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">FieldsUtility</span><span class="p">.</span><span class="nx">setFieldsAttributes</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">filtered</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">totals</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">totals</span> <span class="o">=</span> <span class="p">{</span><span class="nx">records</span><span class="o">:</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">RecordList</span><span class="p">(),</span> <span class="nx">fields</span><span class="o">:</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">FieldList</span><span class="p">()</span> <span class="p">}}</span>

                    <span class="k">this</span><span class="p">.</span><span class="nx">totals</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="p">{</span><span class="nx">renderer</span><span class="o">:</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Renderers</span><span class="p">})</span> <span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">totals</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
            <span class="p">}</span>   <span class="k">else</span>   <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">totals_unfiltered</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">totals_unfiltered</span> <span class="o">=</span> <span class="p">{</span><span class="nx">records</span><span class="o">:</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">RecordList</span><span class="p">(),</span> <span class="nx">fields</span><span class="o">:</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">FieldList</span><span class="p">()</span> <span class="p">}}</span>

                    <span class="k">this</span><span class="p">.</span><span class="nx">totals_unfiltered</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="p">{</span><span class="nx">renderer</span><span class="o">:</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Renderers</span><span class="p">})</span> <span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">totals_unfiltered</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
            <span class="p">}</span>


        <span class="p">},</span>

        <span class="nx">buildResult</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">reducedResult</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="nx">partitionFields</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">,</span> <span class="nx">aggregatedFields</span><span class="p">,</span> <span class="nx">partitions</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">partitioning</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">partitions</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">partitioning</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">tmpField</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dimensions</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">tmpField</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">reducedResult</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>set  results of dataset</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">reducedResult</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">currentField</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">currentResult</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="kd">var</span> <span class="nx">tmp</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>if dimensions specified add dimension' fields</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">dimensions</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">keyField</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">);</span>

                    <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">dimension</span><span class="o">:</span><span class="nx">currentResult</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">count</span><span class="o">:</span><span class="nx">currentResult</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="p">};</span>

                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">keyField</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">field</span> <span class="o">=</span> <span class="nx">dimensions</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">originalFieldAttributes</span> <span class="o">=</span> <span class="nx">originalFields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">field</span><span class="p">).</span><span class="nx">attributes</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>

                        <span class="kd">var</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">FormattersMODA</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">keyField</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>

                        <span class="nx">tmp</span><span class="p">[</span><span class="nx">dimensions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">currentField</span> <span class="o">=</span> <span class="nx">currentResult</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">currentField</span> <span class="o">=</span> <span class="nx">currentResult</span><span class="p">;</span>
                    <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span><span class="nx">currentResult</span><span class="p">.</span><span class="nx">count</span><span class="p">};</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>add records foreach aggregation function</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>apply finalization function, was not applied since now
todo verify if can be moved above
note that finalization can't be applyed at init cause we don't know in advance wich partitions data are present</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="kd">var</span> <span class="nx">tmpPartitionFields</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">partitionFields</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="nx">tmpPartitionFields</span> <span class="o">=</span> <span class="nx">partitionFields</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>
                    <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">finalizeFunctions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]](</span>
                        <span class="nx">currentField</span><span class="p">,</span>
                        <span class="nx">aggregatedFields</span><span class="p">,</span>
                        <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">tmpPartitionFields</span><span class="p">));</span>

                    <span class="kd">var</span> <span class="nx">tempValue</span><span class="p">;</span>


                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">currentField</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
                        <span class="nx">tempValue</span> <span class="o">=</span> <span class="nx">currentField</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]();</span>
                    <span class="k">else</span>
                        <span class="nx">tempValue</span> <span class="o">=</span> <span class="nx">currentField</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>


                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">tempValue</span><span class="p">)</span> <span class="p">{</span>

                        <span class="kd">var</span> <span class="nx">tempValue2</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">tempValue</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
                            <span class="nx">tempValue2</span> <span class="o">=</span> <span class="nx">tempValue</span><span class="p">[</span><span class="nx">x</span><span class="p">]();</span>
                        <span class="k">else</span>
                            <span class="nx">tempValue2</span> <span class="o">=</span> <span class="nx">tempValue</span><span class="p">[</span><span class="nx">x</span><span class="p">];</span>

                        <span class="nx">tmp</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">tempValue2</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>adding partition records</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">partitioning</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">tempValue</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">currentField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
                            <span class="nx">tempValue</span> <span class="o">=</span> <span class="nx">currentField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]();</span>
                        <span class="k">else</span>
                            <span class="nx">tempValue</span> <span class="o">=</span> <span class="nx">currentField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>

                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">tempValue</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">tempValue2</span><span class="p">;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">currentField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
                                <span class="nx">tempValue2</span> <span class="o">=</span> <span class="nx">currentField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]();</span>
                            <span class="k">else</span>
                                <span class="nx">tempValue2</span> <span class="o">=</span> <span class="nx">currentField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>

                            <span class="kd">var</span> <span class="nx">fieldName</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>

                            <span class="nx">tmp</span><span class="p">[</span><span class="nx">fieldName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tempValue2</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>


                        <span class="p">}</span>

                    <span class="p">}</span>

                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>count is always calculated for each partition</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">partitioning</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">tmpField</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">currentResult</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                            <span class="nx">tmp</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">else</span>
                            <span class="nx">tmp</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">currentResult</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">partitions</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">][</span><span class="nx">x</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>


                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tmp</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">buildFields</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">reducedResult</span><span class="p">,</span> <span class="nx">originalFields</span><span class="p">,</span> <span class="nx">partitionFields</span><span class="p">,</span> <span class="nx">dimensions</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="kd">var</span> <span class="nx">tmpField</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dimensions</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">reducedResult</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">!=</span> <span class="nb">Array</span><span class="p">)</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">;</span>
                <span class="k">else</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">reducedResult</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">reducedResult</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="nx">reducedResult</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="nx">tmpField</span> <span class="o">=</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>creation of fields</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;integer&quot;</span><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>defining fields based on aggreagtion functions</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">aggregationFunctions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">tempValue</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">tmpField</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
                    <span class="nx">tempValue</span> <span class="o">=</span> <span class="nx">tmpField</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]]();</span>
                <span class="k">else</span>
                    <span class="nx">tempValue</span> <span class="o">=</span> <span class="nx">tmpField</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]];</span>

                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">tempValue</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">originalFieldAttributes</span> <span class="o">=</span> <span class="nx">originalFields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">attributes</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">newType</span> <span class="o">=</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">resultingDataType</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]](</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>

                    <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">id</span><span class="o">:</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span>
                        <span class="nx">type</span><span class="o">:</span><span class="nx">newType</span><span class="p">,</span>
                        <span class="nx">is_partitioned</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span>
                        <span class="nx">colorSchema</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">colorSchema</span><span class="p">,</span>
                        <span class="nx">shapeSchema</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">shapeSchema</span><span class="p">,</span>
                        <span class="nx">originalField</span><span class="o">:</span><span class="nx">x</span><span class="p">,</span>
                        <span class="nx">aggregationFunction</span><span class="o">:</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
                    <span class="p">});</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>add partition fields</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">partitionFields</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">aggrFunction</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">aggrFunction</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">originalFieldAttributes</span> <span class="o">=</span> <span class="nx">originalFields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">field</span><span class="p">).</span><span class="nx">attributes</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">newType</span> <span class="o">=</span> <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Aggregations</span><span class="p">.</span><span class="nx">resultingDataType</span><span class="p">[</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]](</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>

                        <span class="kd">var</span> <span class="nx">fieldId</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">fieldLabel</span> <span class="o">=</span> <span class="nx">fieldId</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fieldLabelForPartitions</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">fieldLabel</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fieldLabelForPartitions</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;{originalField}&quot;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">originalField</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;{partitionFieldName}&quot;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">field</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;{partitionFieldValue}&quot;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;{aggregatedFunction}&quot;</span><span class="p">,</span> <span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
                        <span class="p">}</span>

                        <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                                <span class="nx">id</span><span class="o">:</span><span class="nx">fieldId</span><span class="p">,</span>
                                <span class="nx">type</span><span class="o">:</span><span class="nx">newType</span><span class="p">,</span>
                                <span class="nx">is_partitioned</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span>
                                <span class="nx">partitionField</span><span class="o">:</span><span class="nx">d</span><span class="p">.</span><span class="nx">field</span><span class="p">,</span>
                                <span class="nx">partitionValue</span><span class="o">:</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
                                <span class="nx">colorSchema</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">colorSchema</span><span class="p">,</span> <span class="c1">// the schema is the one used to specify partition</span>
                                <span class="nx">shapeSchema</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">shapeSchema</span><span class="p">,</span>
                                <span class="nx">originalField</span><span class="o">:</span><span class="nx">d</span><span class="p">.</span><span class="nx">originalField</span><span class="p">,</span>
                                <span class="nx">aggregationFunction</span><span class="o">:</span><span class="nx">aggregationFunctions</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span>
                                <span class="nx">label</span><span class="o">:</span><span class="nx">fieldLabel</span>
                            <span class="p">}</span>
                        <span class="p">);</span>
                    <span class="p">})</span>
                <span class="p">});</span>

            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>adding all dimensions to field list</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">dimensions</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="s2">&quot;dimension&quot;</span><span class="p">});</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dimensions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">originalFieldAttributes</span> <span class="o">=</span> <span class="nx">originalFields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">dimensions</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">attributes</span><span class="p">;</span>
                    <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">id</span><span class="o">:</span><span class="nx">dimensions</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
                        <span class="nx">type</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
                        <span class="nx">label</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">label</span><span class="p">,</span>
                        <span class="nx">format</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">format</span><span class="p">,</span>
                        <span class="nx">colorSchema</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">colorSchema</span><span class="p">,</span>
                        <span class="nx">shapeSchema</span><span class="o">:</span><span class="nx">originalFieldAttributes</span><span class="p">.</span><span class="nx">shapeSchema</span>
                    <span class="p">});</span>

                <span class="p">}</span>
            <span class="p">}</span>


            <span class="k">return</span> <span class="nx">fields</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">query</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">queryObj</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;query:start&#39;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">queryObj</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">queryObj</span><span class="p">,</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">actualQuery</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;VModel [&quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;] query [&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">actualQuery</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_store</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Warning query called before data has been calculated for virtual model, call fetch on source dataset&quot;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">self</span><span class="p">.</span><span class="nx">clearFilteredTotals</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_store</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">actualQuery</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
                <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">_handleQueryResult</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">);</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;query:done&#39;</span><span class="p">);</span>
                    <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">records</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;query:fail&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                    <span class="nx">dfd</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">selection</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">queryObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;selection:start&#39;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">queryObj</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">queryObj</span><span class="p">,</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">actualQuery</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">queryState</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>apply on current records
needed cause memory store is not mandatory</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">recline</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Filters</span><span class="p">.</span><span class="nx">applySelectionsOnData</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;selections&#39;</span><span class="p">),</span> <span class="nx">self</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">models</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">);</span>

            <span class="nx">self</span><span class="p">.</span><span class="nx">queryState</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;selection:done&#39;</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">_handleQueryResult</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">recordCount</span> <span class="o">=</span> <span class="nx">queryResult</span><span class="p">.</span><span class="nx">total</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">.</span><span class="nx">hits</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">Record</span><span class="p">(</span><span class="nx">hit</span><span class="p">);</span>
                <span class="nx">_doc</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">_doc</span><span class="p">;</span>
            <span class="p">});</span>

                <span class="nx">self</span><span class="p">.</span><span class="nx">clearFilteredTotals</span><span class="p">();</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>


            <span class="k">if</span> <span class="p">(</span><span class="nx">queryResult</span><span class="p">.</span><span class="nx">facets</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">facets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">.</span><span class="nx">facets</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">facetResult</span><span class="p">,</span> <span class="nx">facetId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">facetResult</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">facetId</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">Facet</span><span class="p">(</span><span class="nx">facetResult</span><span class="p">);</span>

                    <span class="nx">self</span><span class="p">.</span><span class="nx">addColorsToTerms</span><span class="p">(</span><span class="nx">facetId</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">terms</span><span class="p">);</span>

                    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
                <span class="p">});</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">facets</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">facets</span><span class="p">);</span>
            <span class="p">}</span>


        <span class="p">},</span>


        <span class="nx">setColorSchema</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">colorSchema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">field</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">getFields</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">models</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">field</span> <span class="o">===</span> <span class="nx">f</span><span class="p">.</span><span class="nx">id</span>
                <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">field</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="nx">field</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">colorSchema</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">schema</span><span class="p">;</span>
            <span class="p">})</span>
        <span class="p">},</span>

        <span class="nx">setShapeSchema</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">shapeSchema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">field</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">getFields</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">models</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">field</span> <span class="o">===</span> <span class="nx">f</span><span class="p">.</span><span class="nx">id</span>
                <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">field</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="nx">field</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">shapeSchema</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">schema</span><span class="p">;</span>
            <span class="p">})</span>
        <span class="p">},</span>

        <span class="nx">addColorsToTerms</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="nx">terms</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">terms</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>assignment of color schema to fields</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">colorSchema</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">colorSchema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">field</span> <span class="o">===</span> <span class="nx">field</span><span class="p">)</span>
                            <span class="nx">t</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">getColorFor</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">term</span><span class="p">);</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">},</span>

        <span class="nx">getFacetByFieldId</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">fieldId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facets</span><span class="p">.</span><span class="nx">models</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">facet</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">facet</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">fieldId</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">},</span>

        <span class="nx">toTemplateJSON</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">recordCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">recordCount</span><span class="p">;</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>getFieldsSummary</h3>

<p>Get a summary for each field in the form of a <code>Facet</code>.</p>

<p>@return null as this is async function. Provides deferred/promise interface.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">getFieldsSummary</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>TODO update function in order to manage facets/filter and selection</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">Query</span><span class="p">();</span>
            <span class="nx">query</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">size</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>

            <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_store</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">queryResult</span><span class="p">.</span><span class="nx">facets</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">.</span><span class="nx">facets</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">facetResult</span><span class="p">,</span> <span class="nx">facetId</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">facetResult</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">facetId</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">facet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">my</span><span class="p">.</span><span class="nx">Facet</span><span class="p">(</span><span class="nx">facetResult</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>TODO: probably want replace rather than reset (i.e. just replace the facet with this id)</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">facetId</span><span class="p">).</span><span class="nx">facets</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">facet</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Retrieve the list of partitioned field for the specified aggregated field</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">getPartitionedFields</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">partitionedField</span><span class="p">,</span> <span class="nx">measureField</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>var field = this.fields.get(fieldName);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">models</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="nx">d</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">partitionField</span> <span class="o">==</span> <span class="nx">partitionedField</span>
                        <span class="o">&amp;&amp;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">originalField</span> <span class="o">==</span> <span class="nx">measureField</span>
                    <span class="p">);</span>
            <span class="p">});</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">fields</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                <span class="nx">field</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>fields.push(field);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">fields</span><span class="p">;</span>

        <span class="p">},</span>

        <span class="nx">isFieldPartitioned</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">fieldName</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span>  <span class="k">this</span><span class="p">.</span><span class="nx">getFields</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">fieldName</span><span class="p">).</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregationFunction</span>
                <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">partitions</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">getPartitionedFieldsForAggregationFunction</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">aggregationFunction</span><span class="p">,</span> <span class="nx">aggregatedFieldName</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">partitionFields</span><span class="p">[</span><span class="nx">aggregationFunction</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">originalField</span> <span class="o">==</span> <span class="nx">aggregatedFieldName</span><span class="p">)</span>
                    <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="nx">fields</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">});</span>


<span class="p">}(</span><span class="nx">jQuery</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">recline</span><span class="p">.</span><span class="nx">Model</span><span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 